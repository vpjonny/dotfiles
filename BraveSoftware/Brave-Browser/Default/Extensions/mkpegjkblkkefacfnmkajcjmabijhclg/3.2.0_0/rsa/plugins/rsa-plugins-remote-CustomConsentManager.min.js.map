{"version":3,"file":"rsa-plugins-remote-CustomConsentManager.min.js","sources":["../../../../src/customConsentManager/constants.ts","../../../../src/customConsentManager/index.ts","../../../../src/customConsentManager/logMessages.ts"],"sourcesContent":["const CUSTOM_CONSENT_MANAGER_PLUGIN = 'CustomConsentManagerPlugin';\n\nexport { CUSTOM_CONSENT_MANAGER_PLUGIN };\n","/* eslint-disable @typescript-eslint/no-unused-vars */\n/* eslint-disable no-param-reassign */\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type { DestinationConfig } from '@rudderstack/analytics-js-common/types/Destination';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type { ExtensionPlugin } from '@rudderstack/analytics-js-common/types/PluginEngine';\nimport type { IStoreManager } from '@rudderstack/analytics-js-common/types/Store';\nimport type { IErrorHandler } from '@rudderstack/analytics-js-common/types/ErrorHandler';\nimport type { PluginName } from '@rudderstack/analytics-js-common/types/PluginsManager';\nimport { CUSTOM_CONSENT_MANAGER_PLUGIN } from './constants';\nimport { DESTINATION_CONSENT_STATUS_ERROR } from './logMessages';\n\nconst pluginName: PluginName = 'CustomConsentManager';\n\nconst CustomConsentManager = (): ExtensionPlugin => ({\n  name: pluginName,\n  deps: [],\n  initialize: (state: ApplicationState) => {\n    state.plugins.loadedPlugins.value = [...state.plugins.loadedPlugins.value, pluginName];\n  },\n  consentManager: {\n    init(state: ApplicationState, logger?: ILogger): void {\n      // Nothing to initialize\n    },\n\n    updateConsentsInfo(\n      state: ApplicationState,\n      storeManager?: IStoreManager,\n      logger?: ILogger,\n    ): void {\n      // Nothing to update. Already provided by the user\n    },\n\n    isDestinationConsented(\n      state: ApplicationState,\n      destConfig: DestinationConfig,\n      errorHandler?: IErrorHandler,\n      logger?: ILogger,\n    ): boolean {\n      if (!state.consents.initialized.value) {\n        return true;\n      }\n\n      const allowedConsentIds = state.consents.data.value.allowedConsentIds as string[];\n\n      try {\n        const { consentManagement } = destConfig;\n\n        // If the destination does not have consent management config, events should be sent.\n        if (!consentManagement) {\n          return true;\n        }\n\n        // Get the corresponding consents for the destination\n        const cmpConfig = consentManagement.find(c => c.provider === state.consents.provider.value);\n\n        // If there are no consents configured for the destination for the current provider, events should be sent.\n        if (!cmpConfig?.consents) {\n          return true;\n        }\n\n        const configuredConsents = cmpConfig.consents.map(c => c.consent.trim()).filter(n => n);\n        const resolutionStrategy =\n          cmpConfig.resolutionStrategy ?? state.consents.resolutionStrategy.value;\n\n        // match the configured consents with user provided consents as per\n        // the configured resolution strategy\n        const matchPredicate = (consent: string) => allowedConsentIds.includes(consent);\n        switch (resolutionStrategy) {\n          case 'or':\n            return configuredConsents.some(matchPredicate) || configuredConsents.length === 0;\n          case 'and':\n          default:\n            return configuredConsents.every(matchPredicate);\n        }\n      } catch (err) {\n        errorHandler?.onError(err, CUSTOM_CONSENT_MANAGER_PLUGIN, DESTINATION_CONSENT_STATUS_ERROR);\n        return true;\n      }\n    },\n  },\n});\n\nexport { CustomConsentManager };\n\nexport default CustomConsentManager;\n","const DESTINATION_CONSENT_STATUS_ERROR = `Failed to determine the consent status for the destination. Please check the destination configuration and try again.`;\n\nexport { DESTINATION_CONSENT_STATUS_ERROR };\n"],"names":["pluginName","CustomConsentManager","name","deps","initialize","state","plugins","loadedPlugins","value","consentManager","init","logger","updateConsentsInfo","storeManager","isDestinationConsented","destConfig","errorHandler","consents","initialized","allowedConsentIds","data","_cmpConfig$resolution","consentManagement","cmpConfig","find","c","provider","configuredConsents","map","consent","trim","filter","n","resolutionStrategy","matchPredicate","includes","some","length","every","err","onError"],"mappings":"AAAA,MCYMA,EAAyB,uBAEzBC,EAAuBA,KAAAA,CAC3BC,KAAMF,EACNG,KAAM,GACNC,WAAaC,IACXA,EAAMC,QAAQC,cAAcC,MAAQ,IAAIH,EAAMC,QAAQC,cAAcC,MAAOR,EAAW,EAExFS,eAAgB,CACdC,IAAAA,CAAKL,EAAyBM,GAC5B,EAGFC,kBAAAA,CACEP,EACAQ,EACAF,GAEA,EAGFG,sBAAAA,CACET,EACAU,EACAC,EACAL,GAEA,IAAKN,EAAMY,SAASC,YAAYV,MAC9B,OAAO,EAGT,MAAMW,EAAoBd,EAAMY,SAASG,KAAKZ,MAAMW,kBAEpD,IAAIE,IAAAA,EACF,MAAMC,kBAAEA,GAAsBP,EAG9B,IAAKO,EACH,OAAO,EAIT,MAAMC,EAAYD,EAAkBE,MAAKC,GAAKA,EAAEC,WAAarB,EAAMY,SAASS,SAASlB,QAGrF,GAAKe,UAAAA,EAAWN,SACd,OAAO,EAGT,MAAMU,EAAqBJ,EAAUN,SAASW,KAAIH,GAAKA,EAAEI,QAAQC,SAAQC,QAAOC,GAAKA,IAC/EC,EACwB,QADNZ,EACtBE,EAAUU,0BAAkB,IAAAZ,EAAAA,EAAIhB,EAAMY,SAASgB,mBAAmBzB,MAI9D0B,EAAkBL,GAAoBV,EAAkBgB,SAASN,GACvE,MACO,OADCI,EAEGN,EAAmBS,KAAKF,IAAiD,IAA9BP,EAAmBU,OAG9DV,EAAmBW,MAAMJ,EAEtC,CAAE,MAAOK,GAEP,OADAvB,SAAAA,EAAcwB,QAAQD,ED5EQ,6BEAG,0HD6E1B,CACT,CACF"}