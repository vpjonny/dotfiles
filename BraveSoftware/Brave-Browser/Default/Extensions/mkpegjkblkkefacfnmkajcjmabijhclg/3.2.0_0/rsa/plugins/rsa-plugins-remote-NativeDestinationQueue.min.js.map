{"version":3,"file":"rsa-plugins-remote-NativeDestinationQueue.min.js","sources":["../../../../src/nativeDestinationQueue/constants.ts","../../../../src/nativeDestinationQueue/utilities.ts","../../../../src/nativeDestinationQueue/logMessages.ts","../../../../src/nativeDestinationQueue/index.ts"],"sourcesContent":["const DEFAULT_QUEUE_OPTIONS = {\n  maxItems: 100,\n};\n\nconst QUEUE_NAME = 'rudder_destinations_events';\n\nconst NATIVE_DESTINATION_QUEUE_PLUGIN = 'NativeDestinationQueuePlugin';\n\nexport { DEFAULT_QUEUE_OPTIONS, QUEUE_NAME, NATIVE_DESTINATION_QUEUE_PLUGIN };\n","/* eslint-disable @typescript-eslint/no-unused-vars */\nimport { mergeDeepRight } from '@rudderstack/analytics-js-common/utilities/object';\nimport type { DestinationsQueueOpts } from '@rudderstack/analytics-js-common/types/LoadOptions';\nimport type { Destination } from '@rudderstack/analytics-js-common/types/Destination';\nimport type { RudderEvent } from '@rudderstack/analytics-js-common/types/Event';\nimport type { IErrorHandler } from '@rudderstack/analytics-js-common/types/ErrorHandler';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type { Nullable } from '@rudderstack/analytics-js-common/types/Nullable';\nimport type { RudderEventType } from '../types/plugins';\nimport { DEFAULT_QUEUE_OPTIONS, NATIVE_DESTINATION_QUEUE_PLUGIN } from './constants';\nimport { DESTINATION_EVENT_FORWARDING_ERROR } from './logMessages';\n\nconst getNormalizedQueueOptions = (queueOpts: DestinationsQueueOpts): DestinationsQueueOpts =>\n  mergeDeepRight(DEFAULT_QUEUE_OPTIONS, queueOpts);\n\nconst isValidEventName = (eventName: Nullable<string>) =>\n  eventName && typeof eventName === 'string';\n\nconst isEventDenyListed = (\n  eventType: RudderEventType,\n  eventName: Nullable<string>,\n  dest: Destination,\n) => {\n  if (eventType !== 'track') {\n    return false;\n  }\n\n  const { blacklistedEvents, whitelistedEvents, eventFilteringOption } = dest.config;\n\n  switch (eventFilteringOption) {\n    // Blacklist is chosen for filtering events\n    case 'blacklistedEvents': {\n      if (!isValidEventName(eventName)) {\n        return false;\n      }\n      const trimmedEventName = (eventName as string).trim();\n      if (Array.isArray(blacklistedEvents)) {\n        return blacklistedEvents.some(eventObj => eventObj.eventName.trim() === trimmedEventName);\n      }\n      return false;\n    }\n\n    // Whitelist is chosen for filtering events\n    case 'whitelistedEvents': {\n      if (!isValidEventName(eventName)) {\n        return true;\n      }\n      const trimmedEventName = (eventName as string).trim();\n      if (Array.isArray(whitelistedEvents)) {\n        return !whitelistedEvents.some(eventObj => eventObj.eventName.trim() === trimmedEventName);\n      }\n      return true;\n    }\n\n    case 'disable':\n    default:\n      return false;\n  }\n};\n\nconst sendEventToDestination = (\n  item: RudderEvent,\n  dest: Destination,\n  errorHandler?: IErrorHandler,\n  logger?: ILogger,\n) => {\n  const methodName = item.type.toString();\n  try {\n    // Destinations expect the event to be wrapped under the `message` key\n    // This will remain until we update the destinations to accept the event directly\n    dest.instance?.[methodName]?.({ message: item });\n  } catch (err) {\n    errorHandler?.onError(\n      err,\n      NATIVE_DESTINATION_QUEUE_PLUGIN,\n      DESTINATION_EVENT_FORWARDING_ERROR(dest.userFriendlyId),\n    );\n  }\n};\n\nexport { getNormalizedQueueOptions, isEventDenyListed, sendEventToDestination };\n","import { LOG_CONTEXT_SEPARATOR } from '@rudderstack/analytics-js-common/constants/logMessages';\nimport type { Nullable } from '@rudderstack/analytics-js-common/types/Nullable';\n\nconst DESTINATION_EVENT_FILTERING_WARNING = (\n  context: string,\n  eventName: Nullable<string>,\n  destUserFriendlyId: string,\n): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}The \"${eventName}\" track event has been filtered for the \"${destUserFriendlyId}\" destination.`;\n\nconst DESTINATION_EVENT_FORWARDING_ERROR = (destUserFriendlyId: string): string =>\n  `Failed to forward event to destination \"${destUserFriendlyId}\".`;\n\nexport { DESTINATION_EVENT_FILTERING_WARNING, DESTINATION_EVENT_FORWARDING_ERROR };\n","/* eslint-disable @typescript-eslint/no-unused-vars */\n/* eslint-disable no-param-reassign */\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type {\n  IPluginsManager,\n  PluginName,\n} from '@rudderstack/analytics-js-common/types/PluginsManager';\nimport type { IStoreManager } from '@rudderstack/analytics-js-common/types/Store';\nimport type { IErrorHandler } from '@rudderstack/analytics-js-common/types/ErrorHandler';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type { QueueOpts } from '@rudderstack/analytics-js-common/types/LoadOptions';\nimport type { RudderEvent } from '@rudderstack/analytics-js-common/types/Event';\nimport type { Destination } from '@rudderstack/analytics-js-common/types/Destination';\nimport type { ExtensionPlugin } from '@rudderstack/analytics-js-common/types/PluginEngine';\nimport { clone } from 'ramda';\nimport { storages } from '../shared-chunks/common';\nimport type { DoneCallback, IQueue } from '../types/plugins';\nimport { RetryQueue } from '../utilities/retryQueue/RetryQueue';\nimport { getNormalizedQueueOptions, isEventDenyListed, sendEventToDestination } from './utilities';\nimport { NATIVE_DESTINATION_QUEUE_PLUGIN, QUEUE_NAME } from './constants';\nimport { DESTINATION_EVENT_FILTERING_WARNING } from './logMessages';\nimport { destinationUtils } from '../shared-chunks/deviceModeDestinations';\n\nconst pluginName: PluginName = 'NativeDestinationQueue';\n\nconst NativeDestinationQueue = (): ExtensionPlugin => ({\n  name: pluginName,\n  deps: [],\n  initialize: (state: ApplicationState) => {\n    state.plugins.loadedPlugins.value = [...state.plugins.loadedPlugins.value, pluginName];\n  },\n  destinationsEventsQueue: {\n    /**\n     * Initialize the queue for delivery to destinations\n     * @param state Application state\n     * @param pluginsManager PluginsManager instance\n     * @param storeManager StoreManager instance\n     * @param errorHandler Error handler instance\n     * @param logger Logger instance\n     * @returns IQueue instance\n     */\n    init(\n      state: ApplicationState,\n      pluginsManager: IPluginsManager,\n      storeManager: IStoreManager,\n      dmtQueue: IQueue,\n      errorHandler?: IErrorHandler,\n      logger?: ILogger,\n    ): IQueue {\n      const finalQOpts = getNormalizedQueueOptions(\n        state.loadOptions.value.destinationsQueueOptions as QueueOpts,\n      );\n\n      const writeKey = state.lifecycle.writeKey.value as string;\n      const eventsQueue = new RetryQueue(\n        // adding write key to the queue name to avoid conflicts\n        `${QUEUE_NAME}_${writeKey}`,\n        finalQOpts,\n        (rudderEvent: RudderEvent, done: DoneCallback) => {\n          const destinationsToSend = destinationUtils.filterDestinations(\n            rudderEvent.integrations,\n            state.nativeDestinations.initializedDestinations.value,\n          );\n\n          // list of destinations which are enable for DMT\n          const destWithTransformationEnabled: Destination[] = [];\n          const clonedRudderEvent = clone(rudderEvent);\n\n          destinationsToSend.forEach((dest: Destination) => {\n            try {\n              const sendEvent = !isEventDenyListed(\n                clonedRudderEvent.type,\n                clonedRudderEvent.event,\n                dest,\n              );\n              if (!sendEvent) {\n                logger?.warn(\n                  DESTINATION_EVENT_FILTERING_WARNING(\n                    NATIVE_DESTINATION_QUEUE_PLUGIN,\n                    clonedRudderEvent.event,\n                    dest.userFriendlyId,\n                  ),\n                );\n                return;\n              }\n\n              if (dest.shouldApplyDeviceModeTransformation) {\n                destWithTransformationEnabled.push(dest);\n              } else {\n                sendEventToDestination(clonedRudderEvent, dest, errorHandler, logger);\n              }\n            } catch (e) {\n              errorHandler?.onError(e, NATIVE_DESTINATION_QUEUE_PLUGIN);\n            }\n          });\n          if (destWithTransformationEnabled.length > 0) {\n            pluginsManager.invokeSingle(\n              'transformEvent.enqueue',\n              state,\n              dmtQueue,\n              clonedRudderEvent,\n              destWithTransformationEnabled,\n              errorHandler,\n              logger,\n            );\n          }\n\n          // Mark success always\n          done(null);\n        },\n        storeManager,\n        storages.MEMORY_STORAGE,\n      );\n\n      // TODO: This seems to not work as expected. Need to investigate\n      // effect(() => {\n      //   if (state.nativeDestinations.clientDestinationsReady.value === true) {\n      //     eventsQueue.start();\n      //   }\n      // });\n      return eventsQueue;\n    },\n\n    /**\n     * Add event to the queue for delivery to destinations\n     * @param state Application state\n     * @param eventsQueue IQueue instance\n     * @param event RudderEvent object\n     * @param errorHandler Error handler instance\n     * @param logger Logger instance\n     * @returns none\n     */\n    enqueue(\n      state: ApplicationState,\n      eventsQueue: IQueue,\n      event: RudderEvent,\n      errorHandler?: IErrorHandler,\n      logger?: ILogger,\n    ): void {\n      eventsQueue.addItem(event);\n    },\n\n    /**\n     * This extension point is used to directly send the transformed event to the destination\n     * @param state Application state\n     * @param event RudderEvent Object\n     * @param destination Destination Object\n     * @param errorHandler Error handler instance\n     * @param logger Logger instance\n     */\n    enqueueEventToDestination(state, event, destination, errorHandler, logger) {\n      sendEventToDestination(event, destination, errorHandler, logger);\n    },\n  },\n});\n\nexport { NativeDestinationQueue };\n\nexport default NativeDestinationQueue;\n"],"names":["DEFAULT_QUEUE_OPTIONS","maxItems","NATIVE_DESTINATION_QUEUE_PLUGIN","isValidEventName","eventName","sendEventToDestination","item","dest","errorHandler","logger","methodName","type","toString","_dest$instance","_dest$instance$method","instance","call","message","err","onError","userFriendlyId","pluginName","NativeDestinationQueue","name","deps","initialize","state","plugins","loadedPlugins","value","destinationsEventsQueue","init","pluginsManager","storeManager","dmtQueue","finalQOpts","queueOpts","loadOptions","destinationsQueueOptions","mergeDeepRight","writeKey","lifecycle","RetryQueue","rudderEvent","done","destinationsToSend","destinationUtils","integrations","nativeDestinations","initializedDestinations","destWithTransformationEnabled","clonedRudderEvent","clone","forEach","sendEvent","isEventDenyListed","eventType","blacklistedEvents","whitelistedEvents","eventFilteringOption","config","trimmedEventName","trim","Array","isArray","some","eventObj","event","warn","context","destUserFriendlyId","LOG_CONTEXT_SEPARATOR","shouldApplyDeviceModeTransformation","push","e","DESTINATION_EVENT_FILTERING_WARNING","length","invokeSingle","storages","enqueue","eventsQueue","addItem","enqueueEventToDestination","destination"],"mappings":"yLAAA,MAAMA,EAAwB,CAC5BC,SAAU,KAKNC,EAAkC,+BCSlCC,EAAoBC,GACxBA,GAAkC,iBAAdA,EA4ChBC,EAAyBA,CAC7BC,EACAC,EACAC,EACAC,KAEA,MAAMC,EAAaJ,EAAKK,KAAKC,WAC7B,IAAIC,IAAAA,EAAAC,EAGW,QAAbD,EAAAN,EAAKQ,gBAAQ,IAAAF,GAAcC,QAAdA,EAAbD,EAAgBH,UAAhBI,IAA2BA,GAA3BA,EAAAE,KAAAH,EAA8B,CAAEI,QAASX,GAC3C,CAAE,MAAOY,GACPV,SAAAA,EAAcW,QACZD,EACAhB,EC/DJ,2CDgEuCK,EAAKa,mBAE5C,GEtDIC,EAAyB,yBAEzBC,EAAyBA,MAC7BC,KAAMF,EACNG,KAAM,GACNC,WAAaC,IACXA,EAAMC,QAAQC,cAAcC,MAAQ,IAAIH,EAAMC,QAAQC,cAAcC,MAAOR,EAAW,EAExFS,wBAAyB,CAUvBC,IAAAA,CACEL,EACAM,EACAC,EACAC,EACA1B,EACAC,GAEA,MAAM0B,GFrCuBC,EEsC3BV,EAAMW,YAAYR,MAAMS,yBFrC9BC,EAAevC,EAAuBoC,IADLA,MEyC7B,MAAMI,EAAWd,EAAMe,UAAUD,SAASX,MAmE1C,OAlEoB,IAAIa,EAEtB,8BAAiBF,IACjBL,GACA,CAACQ,EAA0BC,KACzB,MAAMC,EAAqBC,EACzBH,EAAYI,aACZrB,EAAMsB,mBAAmBC,wBAAwBpB,OAI7CqB,EAA+C,GAC/CC,EAAoBC,EAAMT,GAEhCE,EAAmBQ,SAAS9C,IAC1B,IACE,MAAM+C,GFpDMC,EACxBC,EACApD,EACAG,KAEA,GAAkB,UAAdiD,EACF,SAGF,MAAMC,kBAAEA,EAAiBC,kBAAEA,EAAiBC,qBAAEA,GAAyBpD,EAAKqD,OAE5E,OAAQD,GAEN,IAAK,oBAAqB,CACxB,IAAKxD,EAAiBC,GACpB,OAAO,EAET,MAAMyD,EAAoBzD,EAAqB0D,OAC/C,QAAIC,MAAMC,QAAQP,IACTA,EAAkBQ,MAAKC,GAAYA,EAAS9D,UAAU0D,SAAWD,GAG5E,CAGA,IAAK,oBAAqB,CACxB,IAAK1D,EAAiBC,GACpB,OAAO,EAET,MAAMyD,EAAoBzD,EAAqB0D,OAC/C,OAAIC,MAAMC,QAAQN,KACRA,EAAkBO,MAAKC,GAAYA,EAAS9D,UAAU0D,SAAWD,GAG7E,CAGA,QACE,OAAY,EAChB,EEa+BN,CACjBJ,EAAkBxC,KAClBwC,EAAkBgB,MAClB5D,GAEF,IAAK+C,EAQH,YAPA7C,SAAAA,EAAQ2D,MDxEtBC,EC0EkBnE,EDzElBE,EC0EkB+C,EAAkBgB,MDzEpCG,EC0EkB/D,EAAKa,eDxEvB,GAAGiD,IAAUE,SAA6BnE,6CAAqDkE,qBC8E/E/D,EAAKiE,oCACPtB,EAA8BuB,KAAKlE,GAEnCF,EAAuB8C,EAAmB5C,EAAMC,EAEpD,CAAE,MAAOkE,GACPlE,SAAAA,EAAcW,QAAQuD,EAAGxE,EAC3B,CD1FgCyE,IAC1CN,EACAjE,EACAkE,CCuFU,IAEEpB,EAA8B0B,OAAS,GACzC5C,EAAe6C,aACb,yBACAnD,EACAQ,EACAiB,EACAD,EACA1C,EACAC,GAKJmC,EAAK,KAAK,GAEZX,EACA6C,EAUJ,EAWAC,OAAAA,CACErD,EACAsD,EACAb,EACA3D,EACAC,GAEAuE,EAAYC,QAAQd,EACtB,EAUAe,yBAAAA,CAA0BxD,EAAOyC,EAAOgB,EAAa3E,EAAcC,GACjEJ,EAAuB8D,EAAOgB,EAAa3E,EAC7C"}