{"version":3,"file":"rsa-plugins-remote-DeviceModeTransformation.min.js","sources":["../../../../src/deviceModeTransformation/constants.ts","../../../../src/deviceModeTransformation/logMessages.ts","../../../../src/deviceModeTransformation/utilities.ts","../../../../src/deviceModeTransformation/index.ts"],"sourcesContent":["const DEFAULT_TRANSFORMATION_QUEUE_OPTIONS = {\n  minRetryDelay: 500,\n  backoffFactor: 2,\n  maxAttempts: 3,\n};\n\nconst REQUEST_TIMEOUT_MS = 10 * 1000; // 10 seconds\n\nconst QUEUE_NAME = 'rudder';\nconst DMT_PLUGIN = 'DeviceModeTransformationPlugin';\n\nexport { DEFAULT_TRANSFORMATION_QUEUE_OPTIONS, REQUEST_TIMEOUT_MS, QUEUE_NAME, DMT_PLUGIN };\n","import { LOG_CONTEXT_SEPARATOR } from '@rudderstack/analytics-js-common/constants/logMessages';\n\nconst DMT_TRANSFORMATION_UNSUCCESSFUL_ERROR = (\n  context: string,\n  displayName: string,\n  reason: string,\n  action: string,\n): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}Event transformation unsuccessful for destination \"${displayName}\". Reason: ${reason}. ${action}.`;\n\nconst DMT_REQUEST_FAILED_ERROR = (\n  context: string,\n  displayName: string,\n  status: number | undefined,\n  action: string,\n): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}[Destination: ${displayName}].Transformation request failed with status: ${status}. Retries exhausted. ${action}.`;\n\nconst DMT_EXCEPTION = (displayName: string): string => `[Destination:${displayName}].`;\nconst DMT_SERVER_ACCESS_DENIED_WARNING = (context: string): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}Transformation server access is denied. The configuration data seems to be out of sync. Sending untransformed event to the destination.`;\n\nexport {\n  DMT_TRANSFORMATION_UNSUCCESSFUL_ERROR,\n  DMT_REQUEST_FAILED_ERROR,\n  DMT_EXCEPTION,\n  DMT_SERVER_ACCESS_DENIED_WARNING,\n};\n","import type { RudderEvent } from '@rudderstack/analytics-js-common/types/Event';\nimport type { Nullable } from '@rudderstack/analytics-js-common/types/Nullable';\nimport { isNonEmptyObject } from '@rudderstack/analytics-js-common/utilities/object';\nimport type { Destination } from '@rudderstack/analytics-js-common/types/Destination';\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type { IPluginsManager } from '@rudderstack/analytics-js-common/types/PluginsManager';\nimport type { IErrorHandler } from '@rudderstack/analytics-js-common/types/ErrorHandler';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type {\n  TransformationRequestPayload,\n  TransformationResponsePayload,\n  TransformedBatch,\n  TransformedEvent,\n  TransformedPayload,\n} from './types';\nimport { DMT_PLUGIN } from './constants';\nimport {\n  DMT_EXCEPTION,\n  DMT_REQUEST_FAILED_ERROR,\n  DMT_SERVER_ACCESS_DENIED_WARNING,\n  DMT_TRANSFORMATION_UNSUCCESSFUL_ERROR,\n} from './logMessages';\n\n/**\n * A helper function that will take rudderEvent and generate\n * a batch payload that will be sent to transformation server\n *\n */\nconst createPayload = (\n  event: RudderEvent,\n  destinationIds: string[],\n  token: Nullable<string>,\n): TransformationRequestPayload => {\n  const orderNo = Date.now();\n  const payload = {\n    metadata: {\n      'Custom-Authorization': token,\n    },\n    batch: [\n      {\n        orderNo,\n        destinationIds,\n        event,\n      },\n    ],\n  };\n  return payload;\n};\n\nconst sendTransformedEventToDestinations = (\n  state: ApplicationState,\n  pluginsManager: IPluginsManager,\n  destinationIds: string[],\n  result: any,\n  status: number | undefined,\n  event: RudderEvent,\n  errorHandler?: IErrorHandler,\n  logger?: ILogger,\n) => {\n  const NATIVE_DEST_EXT_POINT = 'destinationsEventsQueue.enqueueEventToDestination';\n  const ACTION_TO_SEND_UNTRANSFORMED_EVENT = 'Sending untransformed event';\n  const ACTION_TO_DROP_EVENT = 'Dropping the event';\n  const destinations: Destination[] = state.nativeDestinations.initializedDestinations.value.filter(\n    d => d && destinationIds.includes(d.id),\n  );\n\n  destinations.forEach(dest => {\n    try {\n      const eventsToSend: TransformedEvent[] = [];\n      switch (status) {\n        case 200: {\n          const response: TransformationResponsePayload = JSON.parse(result);\n          const destTransformedResult = response.transformedBatch.find(\n            (e: TransformedBatch) => e.id === dest.id,\n          );\n          destTransformedResult?.payload.forEach((tEvent: TransformedPayload) => {\n            if (tEvent.status === '200') {\n              eventsToSend.push(tEvent.event);\n            } else {\n              let reason = 'Unknown';\n              if (tEvent.status === '410') {\n                reason = 'Transformation is not available';\n              }\n\n              let action = ACTION_TO_DROP_EVENT;\n              if (dest.propagateEventsUntransformedOnError === true) {\n                action = ACTION_TO_SEND_UNTRANSFORMED_EVENT;\n                eventsToSend.push(event);\n                logger?.warn(\n                  DMT_TRANSFORMATION_UNSUCCESSFUL_ERROR(\n                    DMT_PLUGIN,\n                    dest.displayName,\n                    reason,\n                    action,\n                  ),\n                );\n              } else {\n                logger?.error(\n                  DMT_TRANSFORMATION_UNSUCCESSFUL_ERROR(\n                    DMT_PLUGIN,\n                    dest.displayName,\n                    reason,\n                    action,\n                  ),\n                );\n              }\n            }\n          });\n\n          break;\n        }\n        // Transformation server access denied\n        case 404: {\n          logger?.warn(DMT_SERVER_ACCESS_DENIED_WARNING(DMT_PLUGIN));\n          eventsToSend.push(event);\n          break;\n        }\n        default: {\n          if (dest.propagateEventsUntransformedOnError === true) {\n            logger?.warn(\n              DMT_REQUEST_FAILED_ERROR(\n                DMT_PLUGIN,\n                dest.displayName,\n                status,\n                ACTION_TO_SEND_UNTRANSFORMED_EVENT,\n              ),\n            );\n            eventsToSend.push(event);\n          } else {\n            logger?.error(\n              DMT_REQUEST_FAILED_ERROR(DMT_PLUGIN, dest.displayName, status, ACTION_TO_DROP_EVENT),\n            );\n          }\n          break;\n        }\n      }\n      eventsToSend?.forEach((tEvent?: TransformedEvent) => {\n        if (isNonEmptyObject(tEvent)) {\n          pluginsManager.invokeSingle(\n            NATIVE_DEST_EXT_POINT,\n            state,\n            tEvent,\n            dest,\n            errorHandler,\n            logger,\n          );\n        }\n      });\n    } catch (e) {\n      errorHandler?.onError(e, DMT_PLUGIN, DMT_EXCEPTION(dest.displayName));\n    }\n  });\n};\n\nexport { createPayload, sendTransformedEventToDestinations };\n","/* eslint-disable @typescript-eslint/no-unused-vars */\n/* eslint-disable no-param-reassign */\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type {\n  IPluginsManager,\n  PluginName,\n} from '@rudderstack/analytics-js-common/types/PluginsManager';\nimport type { RudderEvent } from '@rudderstack/analytics-js-common/types/Event';\nimport type { Destination } from '@rudderstack/analytics-js-common/types/Destination';\nimport type { IErrorHandler } from '@rudderstack/analytics-js-common/types/ErrorHandler';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type { ExtensionPlugin } from '@rudderstack/analytics-js-common/types/PluginEngine';\nimport type { IHttpClient } from '@rudderstack/analytics-js-common/types/HttpClient';\nimport { MEMORY_STORAGE } from '@rudderstack/analytics-js-common/constants/storages';\nimport type { IStoreManager } from '@rudderstack/analytics-js-common/types/Store';\nimport { isErrRetryable } from '@rudderstack/analytics-js-common/utilities/http';\nimport { createPayload, sendTransformedEventToDestinations } from './utilities';\nimport { getDMTDeliveryPayload } from '../utilities/eventsDelivery';\nimport { DEFAULT_TRANSFORMATION_QUEUE_OPTIONS, QUEUE_NAME, REQUEST_TIMEOUT_MS } from './constants';\nimport { RetryQueue } from '../utilities/retryQueue/RetryQueue';\nimport type { DoneCallback, IQueue } from '../types/plugins';\nimport type { TransformationQueueItemData } from './types';\n\nconst pluginName: PluginName = 'DeviceModeTransformation';\n\nconst DeviceModeTransformation = (): ExtensionPlugin => ({\n  name: pluginName,\n  deps: [],\n  initialize: (state: ApplicationState) => {\n    state.plugins.loadedPlugins.value = [...state.plugins.loadedPlugins.value, pluginName];\n  },\n  transformEvent: {\n    init(\n      state: ApplicationState,\n      pluginsManager: IPluginsManager,\n      httpClient: IHttpClient,\n      storeManager: IStoreManager,\n      errorHandler?: IErrorHandler,\n      logger?: ILogger,\n    ) {\n      const writeKey = state.lifecycle.writeKey.value as string;\n      httpClient.setAuthHeader(writeKey);\n\n      const eventsQueue = new RetryQueue(\n        // adding write key to the queue name to avoid conflicts\n        `${QUEUE_NAME}_${writeKey}`,\n        DEFAULT_TRANSFORMATION_QUEUE_OPTIONS,\n        (\n          item: TransformationQueueItemData,\n          done: DoneCallback,\n          attemptNumber?: number,\n          maxRetryAttempts?: number,\n        ) => {\n          const payload = createPayload(item.event, item.destinationIds, item.token);\n\n          httpClient.getAsyncData({\n            url: `${state.lifecycle.activeDataplaneUrl.value}/transform`,\n            options: {\n              method: 'POST',\n              data: getDMTDeliveryPayload(payload) as string,\n              sendRawData: true,\n            },\n            isRawResponse: true,\n            timeout: REQUEST_TIMEOUT_MS,\n            callback: (result, details) => {\n              // null means item will not be requeued\n              const queueErrResp = isErrRetryable(details) ? details : null;\n\n              if (!queueErrResp || attemptNumber === maxRetryAttempts) {\n                sendTransformedEventToDestinations(\n                  state,\n                  pluginsManager,\n                  item.destinationIds,\n                  result,\n                  details?.xhr?.status,\n                  item.event,\n                  errorHandler,\n                  logger,\n                );\n              }\n\n              done(queueErrResp, result);\n            },\n          });\n        },\n        storeManager,\n        MEMORY_STORAGE,\n      );\n\n      return eventsQueue;\n    },\n\n    enqueue(\n      state: ApplicationState,\n      eventsQueue: IQueue,\n      event: RudderEvent,\n      destinations: Destination[],\n    ) {\n      const destinationIds = destinations.map(d => d.id);\n      eventsQueue.addItem({\n        event,\n        destinationIds,\n        token: state.session.authToken.value,\n      } as TransformationQueueItemData);\n    },\n  },\n});\n\nexport { DeviceModeTransformation };\n\nexport default DeviceModeTransformation;\n"],"names":["DEFAULT_TRANSFORMATION_QUEUE_OPTIONS","minRetryDelay","backoffFactor","maxAttempts","DMT_PLUGIN","DMT_TRANSFORMATION_UNSUCCESSFUL_ERROR","context","displayName","reason","action","LOG_CONTEXT_SEPARATOR","DMT_REQUEST_FAILED_ERROR","status","sendTransformedEventToDestinations","state","pluginsManager","destinationIds","result","event","errorHandler","logger","ACTION_TO_SEND_UNTRANSFORMED_EVENT","ACTION_TO_DROP_EVENT","nativeDestinations","initializedDestinations","value","filter","d","includes","id","forEach","dest","eventsToSend","destTransformedResult","JSON","parse","transformedBatch","find","e","payload","tEvent","push","propagateEventsUntransformedOnError","warn","error","isNonEmptyObject","invokeSingle","onError","pluginName","DeviceModeTransformation","name","deps","initialize","plugins","loadedPlugins","transformEvent","init","httpClient","storeManager","writeKey","lifecycle","setAuthHeader","RetryQueue","item","done","attemptNumber","maxRetryAttempts","metadata","token","batch","orderNo","Date","now","createPayload","getAsyncData","url","activeDataplaneUrl","options","method","data","getDMTDeliveryPayload","sendRawData","isRawResponse","timeout","callback","details","queueErrResp","isErrRetryable","_details$xhr","xhr","MEMORY_STORAGE","enqueue","eventsQueue","destinations","map","addItem","session","authToken"],"mappings":"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"}