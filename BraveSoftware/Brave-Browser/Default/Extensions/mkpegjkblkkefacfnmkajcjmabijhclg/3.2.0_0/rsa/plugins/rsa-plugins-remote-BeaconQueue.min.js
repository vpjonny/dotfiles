import{k as e,s as n,m as t,r as a,L as l,n as s,v as o,o as r}from"./rsa-plugins-common.min.js";import{R as u}from"./rsa-plugins-RetryQueue.min.js";const i={maxItems:10,flushQueueInterval:6e5},c="v1",d="BeaconQueuePlugin",v=(t,a,l)=>{const s={batch:t,sentAt:a};try{const t=n(s,!0);if(t)return new Blob([t],{type:"text/plain"});null==l||l.error(`${d}${e}Failed to convert events batch object to string.`)}catch(n){null==l||l.error((n=>`${n}${e}Failed to convert events batch object to Blob.`)(d),n)}},b="BeaconQueue",m=()=>({name:b,deps:[],initialize:e=>{e.plugins.loadedPlugins.value=[...e.plugins.loadedPlugins.value,b]},dataplaneEventsQueue:{init(n,o,b,m,p){var h;const f=n.lifecycle.writeKey.value,g=((e,n)=>{const t=new URL(e);return new URL(a([t.pathname,"/","beacon","/",c,"/",`batch?writeKey=${n}`].join("")),t).href})(n.lifecycle.activeDataplaneUrl.value,f),$=(w=null!==(h=n.loadOptions.value.beaconQueueOptions)&&void 0!==h?h:{},t(i,w));var w;const y=new u(`rudder_beacon_${f}`,{batch:{enabled:!0,flushInterval:$.flushQueueInterval,maxSize:65536,maxItems:$.maxItems}},((n,t)=>{null==p||p.debug(`${d}${e}Sending events to data plane.`);const a=s(),l=n.map((e=>r(e.event,a))),o=v(l,a,p);if(o)try{const n=navigator.sendBeacon(g,o);n||null==p||p.error((n=>`${n}${e}Failed to send events batch data to the browser's beacon queue. The events will be dropped.`)(d)),t(null,n)}catch(e){null==m||m.onError(e,d,(e=>`Failed to send events batch data to the browser's beacon queue for URL ${e}.`)(g)),t(null)}else t(null)}),b,l,p,(e=>{const n=s(),t=e.map((e=>e.event));return v(t,n,p).size}));return y},enqueue(e,n,t,a,l){t.sentAt=s(),o(t,l),n.addItem({event:t})}}});export{m as BeaconQueue,m as default};
//# sourceMappingURL=rsa-plugins-remote-BeaconQueue.min.js.map
