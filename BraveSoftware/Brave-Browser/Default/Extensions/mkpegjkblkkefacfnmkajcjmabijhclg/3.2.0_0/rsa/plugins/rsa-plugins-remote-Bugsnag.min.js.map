{"version":3,"file":"rsa-plugins-remote-Bugsnag.min.js","sources":["../../../../src/bugsnag/logMessages.ts","../../../../src/bugsnag/constants.ts","../../../../src/bugsnag/utils.ts","../../../../src/bugsnag/index.ts"],"sourcesContent":["import { LOG_CONTEXT_SEPARATOR } from '@rudderstack/analytics-js-common/constants/logMessages';\n\nconst BUGSNAG_API_KEY_VALIDATION_ERROR = (apiKey: string): string =>\n  `The Bugsnag API key (${apiKey}) is invalid or not provided.`;\n\nconst BUGSNAG_SDK_LOAD_TIMEOUT_ERROR = (timeout: number): string =>\n  `A timeout ${timeout} ms occurred while trying to load the Bugsnag SDK.`;\n\nconst BUGSNAG_SDK_LOAD_ERROR = (context: string): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}Failed to load the Bugsnag SDK.`;\n\nconst BUGSNAG_SDK_URL_ERROR = 'The Bugsnag SDK URL is invalid. Failed to load the Bugsnag SDK.';\n\nconst FAILED_TO_FILTER_ERROR = (context: string): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}Failed to filter the error.`;\n\nexport {\n  BUGSNAG_API_KEY_VALIDATION_ERROR,\n  BUGSNAG_SDK_LOAD_TIMEOUT_ERROR,\n  BUGSNAG_SDK_LOAD_ERROR,\n  BUGSNAG_SDK_URL_ERROR,\n  FAILED_TO_FILTER_ERROR,\n};\n","const BUGSNAG_LIB_INSTANCE_GLOBAL_KEY_NAME = 'bugsnag'; // For version 6 and below\nconst BUGSNAG_LIB_V7_INSTANCE_GLOBAL_KEY_NAME = 'Bugsnag';\nconst GLOBAL_LIBRARY_OBJECT_NAMES = [\n  BUGSNAG_LIB_V7_INSTANCE_GLOBAL_KEY_NAME,\n  BUGSNAG_LIB_INSTANCE_GLOBAL_KEY_NAME,\n];\nconst BUGSNAG_CDN_URL = '__RS_BUGSNAG_SDK_URL__';\nconst ERROR_REPORT_PROVIDER_NAME_BUGSNAG = 'rs-bugsnag';\n// This API key token is parsed in the CI pipeline\nconst API_KEY = '__RS_BUGSNAG_API_KEY__';\nconst BUGSNAG_VALID_MAJOR_VERSION = '6';\nconst SDK_LOAD_POLL_INTERVAL_MS = 100; // ms\nconst MAX_WAIT_FOR_SDK_LOAD_MS = 100 * SDK_LOAD_POLL_INTERVAL_MS; // ms\n\n// Errors from the below scripts are NOT allowed to reach Bugsnag\nconst SDK_FILE_NAME_PREFIXES = (): string[] => [\n  'rsa', // Prefix for all the SDK scripts including plugins and module federated chunks\n];\n\nconst DEV_HOSTS = ['www.test-host.com', 'localhost', '127.0.0.1', '[::1]'];\n\n// List of keys to exclude from the metadata\n// Potential PII or sensitive data\nconst APP_STATE_EXCLUDE_KEYS = [\n  'userId',\n  'userTraits',\n  'groupId',\n  'groupTraits',\n  'anonymousId',\n  'config',\n  'instance', // destination instance objects\n  'eventBuffer', // pre-load event buffer (may contain PII)\n  'traits',\n];\n\nconst BUGSNAG_PLUGIN = 'BugsnagPlugin';\n\nexport {\n  BUGSNAG_LIB_INSTANCE_GLOBAL_KEY_NAME,\n  BUGSNAG_LIB_V7_INSTANCE_GLOBAL_KEY_NAME,\n  GLOBAL_LIBRARY_OBJECT_NAMES,\n  BUGSNAG_CDN_URL,\n  ERROR_REPORT_PROVIDER_NAME_BUGSNAG,\n  API_KEY,\n  BUGSNAG_VALID_MAJOR_VERSION,\n  MAX_WAIT_FOR_SDK_LOAD_MS,\n  SDK_FILE_NAME_PREFIXES,\n  SDK_LOAD_POLL_INTERVAL_MS,\n  DEV_HOSTS,\n  APP_STATE_EXCLUDE_KEYS,\n  BUGSNAG_PLUGIN,\n};\n","import type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type { IExternalSrcLoader } from '@rudderstack/analytics-js-common/services/ExternalSrcLoader/types';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport { CDN_INT_DIR } from '@rudderstack/analytics-js-common/constants/urls';\nimport { json } from '../shared-chunks/common';\nimport type { BugsnagLib } from '../types/plugins';\nimport {\n  BUGSNAG_SDK_LOAD_ERROR,\n  BUGSNAG_SDK_LOAD_TIMEOUT_ERROR,\n  FAILED_TO_FILTER_ERROR,\n} from './logMessages';\nimport {\n  API_KEY,\n  APP_STATE_EXCLUDE_KEYS,\n  BUGSNAG_CDN_URL,\n  BUGSNAG_LIB_INSTANCE_GLOBAL_KEY_NAME,\n  BUGSNAG_PLUGIN,\n  BUGSNAG_VALID_MAJOR_VERSION,\n  DEV_HOSTS,\n  ERROR_REPORT_PROVIDER_NAME_BUGSNAG,\n  GLOBAL_LIBRARY_OBJECT_NAMES,\n  MAX_WAIT_FOR_SDK_LOAD_MS,\n  SDK_FILE_NAME_PREFIXES,\n  SDK_LOAD_POLL_INTERVAL_MS,\n} from './constants';\n\nconst isValidVersion = (globalLibInstance: any) => {\n  // For version 7\n  // eslint-disable-next-line no-underscore-dangle\n  let version = globalLibInstance?._client?._notifier?.version;\n\n  // For versions older than 7\n  if (!version) {\n    const tempInstance = globalLibInstance({\n      apiKey: API_KEY,\n      releaseStage: 'version-test',\n      // eslint-disable-next-line func-names, object-shorthand\n      beforeSend: function () {\n        return false;\n      },\n    });\n    version = tempInstance.notifier?.version;\n  }\n\n  return version && version.charAt(0) === BUGSNAG_VALID_MAJOR_VERSION;\n};\n\nconst isRudderSDKError = (event: BugsnagLib.Report) => {\n  const errorOrigin = event.stacktrace?.[0]?.file;\n\n  if (!errorOrigin || typeof errorOrigin !== 'string') {\n    return false;\n  }\n\n  // Prefix folder for all the destination SDK scripts\n  const isDestinationIntegrationBundle = errorOrigin.includes(CDN_INT_DIR);\n  const srcFileName = errorOrigin.substring(errorOrigin.lastIndexOf('/') + 1);\n\n  return (\n    isDestinationIntegrationBundle ||\n    SDK_FILE_NAME_PREFIXES().some(\n      prefix => srcFileName.startsWith(prefix) && srcFileName.endsWith('.js'),\n    )\n  );\n};\n\nconst getAppStateForMetadata = (state: ApplicationState): Record<string, any> | undefined => {\n  const stateStr = json.stringifyWithoutCircular(state, false, APP_STATE_EXCLUDE_KEYS);\n  return stateStr !== null ? JSON.parse(stateStr) : undefined;\n};\n\nconst enhanceErrorEventMutator = (state: ApplicationState, event: BugsnagLib.Report): void => {\n  event.updateMetaData('source', {\n    snippetVersion: (globalThis as typeof window).RudderSnippetVersion,\n  });\n  event.updateMetaData('state', getAppStateForMetadata(state) ?? {});\n\n  const { errorMessage } = event;\n  // eslint-disable-next-line no-param-reassign\n  event.context = errorMessage;\n\n  // Hack for easily grouping the script load errors\n  // on the dashboard\n  if (errorMessage.includes('error in script loading')) {\n    // eslint-disable-next-line no-param-reassign\n    event.context = 'Script load failures';\n  }\n\n  // eslint-disable-next-line no-param-reassign\n  event.severity = 'error';\n};\n\nconst onError =\n  (state: ApplicationState, logger?: ILogger): BugsnagLib.BeforeSend =>\n  (event: BugsnagLib.Report): boolean => {\n    try {\n      // Discard the event if it's not originated at the SDK\n      if (!isRudderSDKError(event)) {\n        return false;\n      }\n\n      enhanceErrorEventMutator(state, event);\n\n      return true;\n    } catch {\n      logger?.error(FAILED_TO_FILTER_ERROR(BUGSNAG_PLUGIN));\n      // Drop the error event if it couldn't be filtered as\n      // it is most likely a non-SDK error\n      return false;\n    }\n  };\n\nconst getReleaseStage = () => {\n  const host = globalThis.location.hostname;\n  return host && DEV_HOSTS.includes(host) ? 'development' : '__RS_BUGSNAG_RELEASE_STAGE__';\n};\n\nconst getGlobalBugsnagLibInstance = () => (globalThis as any)[BUGSNAG_LIB_INSTANCE_GLOBAL_KEY_NAME];\n\nconst getNewClient = (state: ApplicationState, logger?: ILogger): BugsnagLib.Client => {\n  const globalBugsnagLibInstance = getGlobalBugsnagLibInstance();\n\n  const clientConfig: BugsnagLib.IConfig = {\n    apiKey: API_KEY,\n    appVersion: state.context.app.value.version,\n    metaData: {\n      SDK: {\n        name: 'JS',\n        installType: state.context.app.value.installType,\n      },\n    },\n    beforeSend: onError(state, logger),\n    autoCaptureSessions: false, // auto capture sessions is disabled\n    collectUserIp: false, // collecting user's IP is disabled\n    // enabledBreadcrumbTypes: ['error', 'log', 'user'], // for v7 and above\n    maxEvents: 100,\n    maxBreadcrumbs: 40,\n    releaseStage: getReleaseStage(),\n    user: {\n      id: state.source.value?.id || state.lifecycle.writeKey.value,\n    },\n    logger,\n    networkBreadcrumbsEnabled: false,\n  };\n\n  const client: BugsnagLib.Client = globalBugsnagLibInstance(clientConfig);\n\n  return client;\n};\n\nconst isApiKeyValid = (apiKey: string): boolean => {\n  const isAPIKeyValid = !(apiKey.startsWith('{{') || apiKey.endsWith('}}') || apiKey.length === 0);\n  return isAPIKeyValid;\n};\n\nconst loadBugsnagSDK = (externalSrcLoader: IExternalSrcLoader, logger?: ILogger) => {\n  const isNotLoaded = GLOBAL_LIBRARY_OBJECT_NAMES.every(\n    globalKeyName => !(globalThis as any)[globalKeyName],\n  );\n\n  if (!isNotLoaded) {\n    return;\n  }\n\n  externalSrcLoader.loadJSFile({\n    url: BUGSNAG_CDN_URL,\n    id: ERROR_REPORT_PROVIDER_NAME_BUGSNAG,\n    callback: id => {\n      if (!id) {\n        logger?.error(BUGSNAG_SDK_LOAD_ERROR(BUGSNAG_PLUGIN));\n      }\n    },\n  });\n};\n\nconst initBugsnagClient = (\n  state: ApplicationState,\n  promiseResolve: (value: BugsnagLib.Client) => void,\n  promiseReject: (reason?: Error) => void,\n  logger?: ILogger,\n  time = 0,\n): void => {\n  const globalBugsnagLibInstance = getGlobalBugsnagLibInstance();\n  if (typeof globalBugsnagLibInstance === 'function') {\n    if (isValidVersion(globalBugsnagLibInstance)) {\n      const client = getNewClient(state, logger);\n      promiseResolve(client);\n    }\n  } else if (time >= MAX_WAIT_FOR_SDK_LOAD_MS) {\n    promiseReject(new Error(BUGSNAG_SDK_LOAD_TIMEOUT_ERROR(MAX_WAIT_FOR_SDK_LOAD_MS)));\n  } else {\n    // Try to initialize the client after a delay\n    (globalThis as typeof window).setTimeout(\n      initBugsnagClient,\n      SDK_LOAD_POLL_INTERVAL_MS,\n      state,\n      promiseResolve,\n      promiseReject,\n      logger,\n      time + SDK_LOAD_POLL_INTERVAL_MS,\n    );\n  }\n};\n\nexport {\n  isValidVersion,\n  getNewClient,\n  isApiKeyValid,\n  loadBugsnagSDK,\n  getGlobalBugsnagLibInstance,\n  initBugsnagClient,\n  getReleaseStage,\n  isRudderSDKError,\n  enhanceErrorEventMutator,\n  onError,\n  getAppStateForMetadata,\n};\n","/* eslint-disable @typescript-eslint/no-unused-vars */\n/* eslint-disable no-param-reassign */\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type { IExternalSrcLoader } from '@rudderstack/analytics-js-common/services/ExternalSrcLoader/types';\nimport type { ExtensionPlugin } from '@rudderstack/analytics-js-common/types/PluginEngine';\nimport type { PluginName } from '@rudderstack/analytics-js-common/types/PluginsManager';\nimport type { BugsnagLib } from '../types/plugins';\nimport { BUGSNAG_API_KEY_VALIDATION_ERROR, BUGSNAG_SDK_URL_ERROR } from './logMessages';\nimport { API_KEY } from './constants';\nimport { initBugsnagClient, loadBugsnagSDK, isApiKeyValid } from './utils';\n\nconst pluginName: PluginName = 'Bugsnag';\n\nconst Bugsnag = (): ExtensionPlugin => ({\n  name: pluginName,\n  deps: [],\n  initialize: (state: ApplicationState) => {\n    state.plugins.loadedPlugins.value = [...state.plugins.loadedPlugins.value, pluginName];\n  },\n  errorReportingProvider: {\n    init: (\n      state: ApplicationState,\n      externalSrcLoader: IExternalSrcLoader,\n      logger?: ILogger,\n    ): Promise<BugsnagLib.Client> =>\n      new Promise((resolve, reject) => {\n        // If API key token is not parsed or invalid, don't proceed to initialize the client\n        if (!isApiKeyValid(API_KEY)) {\n          reject(new Error(BUGSNAG_API_KEY_VALIDATION_ERROR(API_KEY)));\n          return;\n        }\n\n        // If SDK URL is empty, don't proceed to initialize the client\n        // eslint-disable-next-line no-constant-condition\n        if (!'__RS_BUGSNAG_SDK_URL__') {\n          reject(new Error(BUGSNAG_SDK_URL_ERROR));\n          return;\n        }\n\n        loadBugsnagSDK(externalSrcLoader, logger);\n\n        initBugsnagClient(state, resolve, reject, logger);\n      }),\n    notify: (\n      client: BugsnagLib.Client,\n      error: Error,\n      state: ApplicationState,\n      logger?: ILogger,\n    ): void => {\n      client.notify(error);\n    },\n    breadcrumb: (client: BugsnagLib.Client, message: string, logger?: ILogger): void => {\n      client?.leaveBreadcrumb(message);\n    },\n  },\n});\n\nexport { Bugsnag };\n\nexport default Bugsnag;\n"],"names":["BUGSNAG_LIB_INSTANCE_GLOBAL_KEY_NAME","GLOBAL_LIBRARY_OBJECT_NAMES","API_KEY","DEV_HOSTS","APP_STATE_EXCLUDE_KEYS","BUGSNAG_PLUGIN","enhanceErrorEventMutator","state","event","_getAppStateForMetada","updateMetaData","snippetVersion","globalThis","RudderSnippetVersion","stateStr","json","JSON","parse","undefined","getAppStateForMetadata","errorMessage","context","includes","severity","onError","logger","_event$stacktrace","errorOrigin","stacktrace","file","isDestinationIntegrationBundle","CDN_INT_DIR","srcFileName","substring","lastIndexOf","some","prefix","startsWith","endsWith","isRudderSDKError","_unused","error","LOG_CONTEXT_SEPARATOR","getReleaseStage","host","location","hostname","getGlobalBugsnagLibInstance","loadBugsnagSDK","externalSrcLoader","every","globalKeyName","loadJSFile","url","id","callback","initBugsnagClient","promiseResolve","promiseReject","time","globalBugsnagLibInstance","globalLibInstance","_globalLibInstance$_c","version","_client","_notifier","_tempInstance$notifie","apiKey","releaseStage","beforeSend","notifier","charAt","isValidVersion","client","getNewClient","_state$source$value","appVersion","app","value","metaData","SDK","name","installType","autoCaptureSessions","collectUserIp","maxEvents","maxBreadcrumbs","user","source","lifecycle","writeKey","networkBreadcrumbsEnabled","Error","setTimeout","pluginName","Bugsnag","deps","initialize","plugins","loadedPlugins","errorReportingProvider","init","Promise","resolve","reject","length","BUGSNAG_API_KEY_VALIDATION_ERROR","notify","breadcrumb","message","leaveBreadcrumb"],"mappings":"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"}