{"version":3,"file":"rsa-plugins-remote-XhrQueue.min.js","sources":["../../../../src/xhrQueue/constants.ts","../../../../src/xhrQueue/utilities.ts","../../../../src/xhrQueue/logMessages.ts","../../../../src/xhrQueue/index.ts"],"sourcesContent":["const DEFAULT_RETRY_QUEUE_OPTIONS = {\n  maxRetryDelay: 360000,\n  minRetryDelay: 1000,\n  backoffFactor: 2,\n  maxAttempts: 10,\n  maxItems: 100,\n};\n\nconst REQUEST_TIMEOUT_MS = 30 * 1000; // 30 seconds\n\nconst DATA_PLANE_API_VERSION = 'v1';\n\nconst QUEUE_NAME = 'rudder';\n\nconst XHR_QUEUE_PLUGIN = 'XhrQueuePlugin';\n\nexport {\n  DEFAULT_RETRY_QUEUE_OPTIONS,\n  REQUEST_TIMEOUT_MS,\n  DATA_PLANE_API_VERSION,\n  QUEUE_NAME,\n  XHR_QUEUE_PLUGIN,\n};\n","import { mergeDeepRight } from '@rudderstack/analytics-js-common/utilities/object';\nimport type { QueueOpts } from '@rudderstack/analytics-js-common/types/LoadOptions';\nimport type { ResponseDetails } from '@rudderstack/analytics-js-common/types/HttpClient';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type { RudderEvent } from '@rudderstack/analytics-js-common/types/Event';\nimport type { Nullable } from '@rudderstack/analytics-js-common/types/Nullable';\nimport { clone } from 'ramda';\nimport { getCurrentTimeFormatted } from '@rudderstack/analytics-js-common/utilities/timestamp';\nimport { checks, http, url, json, eventsDelivery } from '../shared-chunks/common';\nimport { DATA_PLANE_API_VERSION, DEFAULT_RETRY_QUEUE_OPTIONS, XHR_QUEUE_PLUGIN } from './constants';\nimport type { XHRRetryQueueItemData, XHRQueueItemData, XHRBatchPayload } from './types';\nimport { EVENT_DELIVERY_FAILURE_ERROR_PREFIX } from './logMessages';\n\nconst getBatchDeliveryPayload = (\n  events: RudderEvent[],\n  currentTime: string,\n  logger?: ILogger,\n): Nullable<string> => {\n  const batchPayload: XHRBatchPayload = { batch: events, sentAt: currentTime };\n  return json.stringifyWithoutCircular(batchPayload, true, undefined, logger);\n};\n\nconst getNormalizedQueueOptions = (queueOpts: QueueOpts): QueueOpts =>\n  mergeDeepRight(DEFAULT_RETRY_QUEUE_OPTIONS, queueOpts);\n\nconst getDeliveryUrl = (dataplaneUrl: string, endpoint: string): string => {\n  const dpUrl = new URL(dataplaneUrl);\n  return new URL(\n    url.removeDuplicateSlashes(\n      [dpUrl.pathname, '/', DATA_PLANE_API_VERSION, '/', endpoint].join(''),\n    ),\n    dpUrl,\n  ).href;\n};\n\nconst getBatchDeliveryUrl = (dataplaneUrl: string): string => getDeliveryUrl(dataplaneUrl, 'batch');\n\nconst logErrorOnFailure = (\n  details: ResponseDetails | undefined,\n  url: string,\n  willBeRetried?: boolean,\n  attemptNumber?: number,\n  maxRetryAttempts?: number,\n  logger?: ILogger,\n) => {\n  if (checks.isUndefined(details?.error) || checks.isUndefined(logger)) {\n    return;\n  }\n\n  const isRetryableFailure = http.isErrRetryable(details);\n  let errMsg = EVENT_DELIVERY_FAILURE_ERROR_PREFIX(XHR_QUEUE_PLUGIN, url);\n  const dropMsg = `The event(s) will be dropped.`;\n  if (isRetryableFailure) {\n    if (willBeRetried) {\n      errMsg = `${errMsg} It/they will be retried.`;\n      if ((attemptNumber as number) > 0) {\n        errMsg = `${errMsg} Retry attempt ${attemptNumber} of ${maxRetryAttempts}.`;\n      }\n    } else {\n      errMsg = `${errMsg} Retries exhausted (${maxRetryAttempts}). ${dropMsg}`;\n    }\n  } else {\n    errMsg = `${errMsg} ${dropMsg}`;\n  }\n  logger?.error(errMsg);\n};\n\nconst getRequestInfo = (\n  itemData: XHRRetryQueueItemData,\n  state: ApplicationState,\n  logger?: ILogger,\n) => {\n  let data;\n  let headers;\n  let url: string;\n  const currentTime = getCurrentTimeFormatted();\n  if (Array.isArray(itemData)) {\n    const finalEvents = itemData.map((queueItemData: XHRQueueItemData) =>\n      eventsDelivery.getFinalEventForDeliveryMutator(queueItemData.event, currentTime),\n    );\n    data = getBatchDeliveryPayload(finalEvents, currentTime, logger);\n    headers = itemData[0] ? clone(itemData[0].headers) : {};\n    url = getBatchDeliveryUrl(state.lifecycle.activeDataplaneUrl.value as string);\n  } else {\n    const { url: eventUrl, event, headers: eventHeaders } = itemData;\n    const finalEvent = eventsDelivery.getFinalEventForDeliveryMutator(event, currentTime);\n\n    data = eventsDelivery.getDeliveryPayload(finalEvent, logger);\n    headers = clone(eventHeaders);\n    url = eventUrl;\n  }\n  return { data, headers, url };\n};\n\nexport {\n  getNormalizedQueueOptions,\n  getDeliveryUrl,\n  logErrorOnFailure,\n  getBatchDeliveryUrl,\n  getRequestInfo,\n  getBatchDeliveryPayload,\n};\n","import { LOG_CONTEXT_SEPARATOR } from '@rudderstack/analytics-js-common/constants/logMessages';\n\nconst EVENT_DELIVERY_FAILURE_ERROR_PREFIX = (context: string, url: string): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}Failed to deliver event(s) to ${url}.`;\n\nexport { EVENT_DELIVERY_FAILURE_ERROR_PREFIX };\n","/* eslint-disable @typescript-eslint/no-unused-vars */\n/* eslint-disable no-param-reassign */\nimport type { ExtensionPlugin } from '@rudderstack/analytics-js-common/types/PluginEngine';\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type { IHttpClient } from '@rudderstack/analytics-js-common/types/HttpClient';\nimport type { IErrorHandler } from '@rudderstack/analytics-js-common/types/ErrorHandler';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type { IStoreManager } from '@rudderstack/analytics-js-common/types/Store';\nimport type { QueueOpts } from '@rudderstack/analytics-js-common/types/LoadOptions';\nimport type { RudderEvent } from '@rudderstack/analytics-js-common/types/Event';\nimport type { PluginName } from '@rudderstack/analytics-js-common/types/PluginsManager';\nimport { getCurrentTimeFormatted } from '@rudderstack/analytics-js-common/utilities/timestamp';\nimport { storages, http, timestamp, string, eventsDelivery } from '../shared-chunks/common';\nimport {\n  getNormalizedQueueOptions,\n  getDeliveryUrl,\n  logErrorOnFailure,\n  getRequestInfo,\n  getBatchDeliveryPayload,\n} from './utilities';\nimport type { DoneCallback, IQueue, QueueItemData } from '../types/plugins';\nimport { RetryQueue } from '../utilities/retryQueue/RetryQueue';\nimport { QUEUE_NAME, REQUEST_TIMEOUT_MS } from './constants';\nimport type { XHRRetryQueueItemData, XHRQueueItemData } from './types';\n\nconst pluginName: PluginName = 'XhrQueue';\n\nconst XhrQueue = (): ExtensionPlugin => ({\n  name: pluginName,\n  deps: [],\n  initialize: (state: ApplicationState) => {\n    state.plugins.loadedPlugins.value = [...state.plugins.loadedPlugins.value, pluginName];\n  },\n  dataplaneEventsQueue: {\n    /**\n     * Initialize the queue for delivery\n     * @param state Application state\n     * @param httpClient http client instance\n     * @param storeManager Store Manager instance\n     * @param errorHandler Error handler instance\n     * @param logger Logger instance\n     * @returns RetryQueue instance\n     */\n    init(\n      state: ApplicationState,\n      httpClient: IHttpClient,\n      storeManager: IStoreManager,\n      errorHandler?: IErrorHandler,\n      logger?: ILogger,\n    ): IQueue {\n      const writeKey = state.lifecycle.writeKey.value as string;\n      httpClient.setAuthHeader(writeKey);\n\n      const finalQOpts = getNormalizedQueueOptions(\n        state.loadOptions.value.queueOptions as QueueOpts,\n      );\n\n      const eventsQueue = new RetryQueue(\n        // adding write key to the queue name to avoid conflicts\n        `${QUEUE_NAME}_${writeKey}`,\n        finalQOpts,\n        (\n          itemData: QueueItemData,\n          done: DoneCallback,\n          attemptNumber?: number,\n          maxRetryAttempts?: number,\n          willBeRetried?: boolean,\n        ) => {\n          const { data, url, headers } = getRequestInfo(\n            itemData as XHRRetryQueueItemData,\n            state,\n            logger,\n          );\n\n          httpClient.getAsyncData({\n            url,\n            options: {\n              method: 'POST',\n              headers,\n              data: data as string,\n              sendRawData: true,\n            },\n            isRawResponse: true,\n            timeout: REQUEST_TIMEOUT_MS,\n            callback: (result, details) => {\n              // null means item will not be requeued\n              const queueErrResp = http.isErrRetryable(details) ? details : null;\n\n              logErrorOnFailure(\n                details,\n                url,\n                willBeRetried,\n                attemptNumber,\n                maxRetryAttempts,\n                logger,\n              );\n\n              done(queueErrResp, result);\n            },\n          });\n        },\n        storeManager,\n        storages.LOCAL_STORAGE,\n        logger,\n        (itemData: XHRQueueItemData[]): number => {\n          const currentTime = getCurrentTimeFormatted();\n          const events = itemData.map((queueItemData: XHRQueueItemData) => queueItemData.event);\n          // type casting to string as we know that the event has already been validated prior to enqueue\n          return (getBatchDeliveryPayload(events, currentTime, logger) as string)?.length;\n        },\n      );\n\n      return eventsQueue;\n    },\n\n    /**\n     * Add event to the queue for delivery\n     * @param state Application state\n     * @param eventsQueue RetryQueue instance\n     * @param event RudderEvent object\n     * @param errorHandler Error handler instance\n     * @param logger Logger instance\n     * @returns none\n     */\n    enqueue(\n      state: ApplicationState,\n      eventsQueue: IQueue,\n      event: RudderEvent,\n      errorHandler?: IErrorHandler,\n      logger?: ILogger,\n    ): void {\n      // sentAt is only added here for the validation step\n      // It'll be updated to the latest timestamp during actual delivery\n      event.sentAt = timestamp.getCurrentTimeFormatted();\n      eventsDelivery.validateEventPayloadSize(event, logger);\n\n      const dataplaneUrl = state.lifecycle.activeDataplaneUrl.value as string;\n      const url = getDeliveryUrl(dataplaneUrl, event.type);\n      // Other default headers are added by the HttpClient\n      // Auth header is added during initialization\n      const headers = {\n        // To maintain event ordering while using the HTTP API as per is documentation,\n        // make sure to include anonymousId as a header\n        AnonymousId: string.toBase64(event.anonymousId),\n      };\n\n      eventsQueue.addItem({\n        url,\n        headers,\n        event,\n      } as XHRRetryQueueItemData);\n    },\n  },\n});\n\nexport { XhrQueue };\n\nexport default XhrQueue;\n"],"names":["DEFAULT_RETRY_QUEUE_OPTIONS","maxRetryDelay","minRetryDelay","backoffFactor","maxAttempts","maxItems","DATA_PLANE_API_VERSION","getBatchDeliveryPayload","events","currentTime","logger","json","batch","sentAt","undefined","getDeliveryUrl","dataplaneUrl","endpoint","dpUrl","URL","url","pathname","join","href","logErrorOnFailure","details","willBeRetried","attemptNumber","maxRetryAttempts","checks","error","isRetryableFailure","http","errMsg","EVENT_DELIVERY_FAILURE_ERROR_PREFIX","context","LOG_CONTEXT_SEPARATOR","dropMsg","getRequestInfo","itemData","state","data","headers","getCurrentTimeFormatted","Array","isArray","finalEvents","map","queueItemData","eventsDelivery","event","clone","lifecycle","activeDataplaneUrl","value","eventUrl","eventHeaders","finalEvent","pluginName","XhrQueue","name","deps","initialize","plugins","loadedPlugins","dataplaneEventsQueue","init","httpClient","storeManager","errorHandler","writeKey","setAuthHeader","finalQOpts","queueOpts","loadOptions","queueOptions","mergeDeepRight","RetryQueue","done","getAsyncData","options","method","sendRawData","isRawResponse","timeout","callback","result","queueErrResp","storages","_getBatchDeliveryPayl","length","enqueue","eventsQueue","timestamp","type","AnonymousId","string","anonymousId","addItem"],"mappings":"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"}