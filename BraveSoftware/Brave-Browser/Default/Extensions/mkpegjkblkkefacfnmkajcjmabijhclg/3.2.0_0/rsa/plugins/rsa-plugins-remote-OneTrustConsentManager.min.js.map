{"version":3,"file":"rsa-plugins-remote-OneTrustConsentManager.min.js","sources":["../../../../src/oneTrustConsentManager/logMessages.ts","../../../../src/oneTrustConsentManager/constants.ts","../../../../src/oneTrustConsentManager/index.ts"],"sourcesContent":["import { LOG_CONTEXT_SEPARATOR } from '@rudderstack/analytics-js-common/constants/logMessages';\n\nconst ONETRUST_ACCESS_ERROR = (context: string): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}Failed to access OneTrust SDK resources. Please ensure that the OneTrust SDK is loaded successfully before RudderStack SDK.`;\n\nconst DESTINATION_CONSENT_STATUS_ERROR = `Failed to determine the consent status for the destination. Please check the destination configuration and try again.`;\n\nexport { ONETRUST_ACCESS_ERROR, DESTINATION_CONSENT_STATUS_ERROR };\n","const ONETRUST_CONSENT_MANAGER_PLUGIN = 'OneTrustConsentManagerPlugin';\n\nexport { ONETRUST_CONSENT_MANAGER_PLUGIN };\n","/* eslint-disable @typescript-eslint/no-unused-vars */\n/* eslint-disable no-param-reassign */\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type { DestinationConfig } from '@rudderstack/analytics-js-common/types/Destination';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type { ExtensionPlugin } from '@rudderstack/analytics-js-common/types/PluginEngine';\nimport type { IStoreManager } from '@rudderstack/analytics-js-common/types/Store';\nimport type { IErrorHandler } from '@rudderstack/analytics-js-common/types/ErrorHandler';\nimport type { PluginName } from '@rudderstack/analytics-js-common/types/PluginsManager';\nimport { DESTINATION_CONSENT_STATUS_ERROR, ONETRUST_ACCESS_ERROR } from './logMessages';\nimport { ONETRUST_CONSENT_MANAGER_PLUGIN } from './constants';\nimport type { OneTrustGroup } from './types';\n\nconst pluginName: PluginName = 'OneTrustConsentManager';\n\nconst OneTrustConsentManager = (): ExtensionPlugin => ({\n  name: pluginName,\n  deps: [],\n  initialize: (state: ApplicationState) => {\n    state.plugins.loadedPlugins.value = [...state.plugins.loadedPlugins.value, pluginName];\n  },\n  consentManager: {\n    init(state: ApplicationState, logger?: ILogger): void {\n      // Nothing to initialize\n    },\n\n    updateConsentsInfo(\n      state: ApplicationState,\n      storeManager?: IStoreManager,\n      logger?: ILogger,\n    ): void {\n      if (!(globalThis as any).OneTrust || !(globalThis as any).OnetrustActiveGroups) {\n        logger?.error(ONETRUST_ACCESS_ERROR(ONETRUST_CONSENT_MANAGER_PLUGIN));\n        state.consents.initialized.value = false;\n        return;\n      }\n\n      // Get the groups (cookie categorization), user has created in OneTrust account.\n      const oneTrustAllGroupsInfo: OneTrustGroup[] = (globalThis as any).OneTrust.GetDomainData()\n        .Groups;\n\n      // OneTrustConsentManager SDK populates a data layer object OnetrustActiveGroups with\n      // the cookie categories Ids that the user has consented to.\n      // Eg: ',C0001,C0003,'\n      // We split it and save it as an array.\n      const allowedConsentIds = (globalThis as any).OnetrustActiveGroups.split(',').filter(\n        (n: string) => n,\n      );\n\n      const deniedConsentIds: string[] = [];\n      oneTrustAllGroupsInfo.forEach(({ CustomGroupId }: OneTrustGroup) => {\n        if (!allowedConsentIds.includes(CustomGroupId)) {\n          deniedConsentIds.push(CustomGroupId);\n        }\n      });\n\n      state.consents.initialized.value = true;\n      state.consents.data.value = { allowedConsentIds, deniedConsentIds };\n    },\n\n    isDestinationConsented(\n      state: ApplicationState,\n      destConfig: DestinationConfig,\n      errorHandler?: IErrorHandler,\n      logger?: ILogger,\n    ): boolean {\n      if (!state.consents.initialized.value) {\n        return true;\n      }\n      const allowedConsentIds = state.consents.data.value.allowedConsentIds as string[];\n\n      try {\n        // mapping of the destination with the consent group name\n        const { oneTrustCookieCategories, consentManagement } = destConfig;\n\n        const matchPredicate = (consent: string) => allowedConsentIds.includes(consent);\n\n        // Generic consent management\n        if (consentManagement) {\n          // Get the corresponding consents for the destination\n          const cmpConsents = consentManagement.find(\n            c => c.provider === state.consents.provider.value,\n          )?.consents;\n\n          // If there are no consents configured for the destination for the current provider, events should be sent.\n          if (!cmpConsents) {\n            return true;\n          }\n\n          const configuredConsents = cmpConsents.map(c => c.consent.trim()).filter(n => n);\n\n          // match the configured consents with user provided consents as per\n          // the configured resolution strategy\n          switch (state.consents.resolutionStrategy.value) {\n            case 'or':\n              return configuredConsents.some(matchPredicate) || configuredConsents.length === 0;\n            case 'and':\n            default:\n              return configuredConsents.every(matchPredicate);\n          }\n          // Legacy cookie consent management\n          // TODO: To be removed once the source config API is updated to support generic consent management\n        } else if (oneTrustCookieCategories) {\n          // Change the structure of oneTrustConsentGroup as an array and filter values if empty string\n          // Eg:\n          // [\"Performance Cookies\", \"Functional Cookies\"]\n          const configuredConsents = oneTrustCookieCategories\n            .map(c => c.oneTrustCookieCategory.trim())\n            .filter(n => n);\n\n          // Check if all the destination's mapped cookie categories are consented by the user in the browser.\n          return configuredConsents.every(matchPredicate);\n        }\n\n        // If there are no consents configured for the destination for the current provider, events should be sent.\n        return true;\n      } catch (err) {\n        errorHandler?.onError(\n          err,\n          ONETRUST_CONSENT_MANAGER_PLUGIN,\n          DESTINATION_CONSENT_STATUS_ERROR,\n        );\n        return true;\n      }\n    },\n  },\n});\n\nexport { OneTrustConsentManager };\n\nexport default OneTrustConsentManager;\n"],"names":["ONETRUST_CONSENT_MANAGER_PLUGIN","pluginName","OneTrustConsentManager","name","deps","initialize","state","plugins","loadedPlugins","value","consentManager","init","logger","updateConsentsInfo","storeManager","globalThis","OneTrust","OnetrustActiveGroups","error","LOG_CONTEXT_SEPARATOR","consents","initialized","oneTrustAllGroupsInfo","GetDomainData","Groups","allowedConsentIds","split","filter","n","deniedConsentIds","forEach","CustomGroupId","includes","push","data","isDestinationConsented","destConfig","errorHandler","oneTrustCookieCategories","consentManagement","matchPredicate","consent","_consentManagement$fi","cmpConsents","find","c","provider","configuredConsents","map","trim","resolutionStrategy","some","length","every","oneTrustCookieCategory","err","onError"],"mappings":"gDAEA,MCFMA,EAAkC,+BCalCC,EAAyB,yBAEzBC,EAAyBA,KAAAA,CAC7BC,KAAMF,EACNG,KAAM,GACNC,WAAaC,IACXA,EAAMC,QAAQC,cAAcC,MAAQ,IAAIH,EAAMC,QAAQC,cAAcC,MAAOR,EAAW,EAExFS,eAAgB,CACdC,IAAAA,CAAKL,EAAyBM,GAC5B,EAGFC,kBAAAA,CACEP,EACAQ,EACAF,GAEA,IAAMG,WAAmBC,WAAcD,WAAmBE,qBAGxD,OAFAL,SAAAA,EAAQM,MF7Bd,GE6B0ClB,IF7B7BmB,qIE8BPb,EAAMc,SAASC,YAAYZ,OAAQ,GAKrC,MAAMa,EAA0CP,WAAmBC,SAASO,gBACzEC,OAMGC,EAAqBV,WAAmBE,qBAAqBS,MAAM,KAAKC,QAC3EC,GAAcA,IAGXC,EAA6B,GACnCP,EAAsBQ,SAAQ,EAAGC,oBAC1BN,EAAkBO,SAASD,IAC9BF,EAAiBI,KAAKF,EACxB,IAGFzB,EAAMc,SAASC,YAAYZ,OAAQ,EACnCH,EAAMc,SAASc,KAAKzB,MAAQ,CAAEgB,oBAAmBI,mBACnD,EAEAM,sBAAAA,CACE7B,EACA8B,EACAC,EACAzB,GAEA,IAAKN,EAAMc,SAASC,YAAYZ,MAC9B,OAAW,EAEb,MAAMgB,EAAoBnB,EAAMc,SAASc,KAAKzB,MAAMgB,kBAEpD,IAEE,MAAMa,yBAAEA,EAAwBC,kBAAEA,GAAsBH,EAElDI,EAAkBC,GAAoBhB,EAAkBO,SAASS,GAGvE,GAAIF,EAAmB,CAAAG,IAAAA,EAErB,MAAMC,EAEL,QAFgBD,EAAGH,EAAkBK,MACpCC,GAAKA,EAAEC,WAAaxC,EAAMc,SAAS0B,SAASrC,eAC7C,IAAAiC,OAAA,EAFmBA,EAEjBtB,SAGH,IAAKuB,EACH,OAAW,EAGb,MAAMI,EAAqBJ,EAAYK,KAAIH,GAAKA,EAAEJ,QAAQQ,SAAQtB,QAAOC,GAAKA,IAI9E,MACO,OADCtB,EAAMc,SAAS8B,mBAAmBzC,MAE/BsC,EAAmBI,KAAKX,IAAiD,IAA9BO,EAAmBK,OAG9DL,EAAmBM,MAAMb,EAItC,CAAO,GAAIF,EAA0B,CASnC,OAL2BA,EACxBU,KAAIH,GAAKA,EAAES,uBAAuBL,SAClCtB,QAAOC,GAAKA,IAGWyB,MAAMb,EAClC,CAGA,QACF,CAAE,MAAOe,GAMP,OALAlB,SAAAA,EAAcmB,QACZD,EACAvD,EFlH+B,0HEqHtB,CACb,CACF"}