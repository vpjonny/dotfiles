{"version":3,"file":"rsa-plugins-remote-StorageMigrator.min.js","sources":["../../../../src/storageMigrator/logMessages.ts","../../../../src/storageMigrator/index.ts","../../../../src/storageMigrator/constants.ts"],"sourcesContent":["const STORAGE_MIGRATION_ERROR = (key: string): string =>\n  `Failed to retrieve or parse data for ${key} from storage.`;\n\nexport { STORAGE_MIGRATION_ERROR };\n","/* eslint-disable @typescript-eslint/no-unused-vars */\n/* eslint-disable no-param-reassign */\nimport type { ExtensionPlugin } from '@rudderstack/analytics-js-common/types/PluginEngine';\nimport type { IStorage } from '@rudderstack/analytics-js-common/types/Store';\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type { Nullable } from '@rudderstack/analytics-js-common/types/Nullable';\nimport type { IErrorHandler } from '@rudderstack/analytics-js-common/types/ErrorHandler';\nimport type { PluginName } from '@rudderstack/analytics-js-common/types/PluginsManager';\nimport { checks, decrypt } from '../shared-chunks/common';\nimport { decrypt as decryptLegacy } from '../storageEncryptionLegacy/legacyEncryptionUtils';\nimport { STORAGE_MIGRATION_ERROR } from './logMessages';\nimport { STORAGE_MIGRATOR_PLUGIN } from './constants';\n\nconst pluginName: PluginName = 'StorageMigrator';\n\nconst StorageMigrator = (): ExtensionPlugin => ({\n  name: pluginName,\n  initialize: (state: ApplicationState) => {\n    state.plugins.loadedPlugins.value = [...state.plugins.loadedPlugins.value, pluginName];\n  },\n  storage: {\n    migrate(\n      key: string,\n      storageEngine: IStorage,\n      errorHandler?: IErrorHandler,\n      logger?: ILogger,\n    ): Nullable<string> {\n      try {\n        const storedVal = storageEngine.getItem(key);\n        if (checks.isNullOrUndefined(storedVal)) {\n          return null;\n        }\n\n        let decryptedVal: string | undefined = decryptLegacy(storedVal as string);\n\n        // The value is not encrypted using legacy encryption\n        // Try latest\n        if (decryptedVal === storedVal) {\n          decryptedVal = decrypt(storedVal);\n        }\n\n        if (checks.isNullOrUndefined(decryptedVal)) {\n          return null;\n        }\n\n        // storejs that is used in localstorage engine already deserializes json strings but swallows errors\n        return JSON.parse(decryptedVal as string);\n      } catch (err) {\n        errorHandler?.onError(err, STORAGE_MIGRATOR_PLUGIN, STORAGE_MIGRATION_ERROR(key));\n        return null;\n      }\n    },\n  },\n});\n\nexport { StorageMigrator };\n\nexport default StorageMigrator;\n","const STORAGE_MIGRATOR_PLUGIN = 'StorageMigratorPlugin';\n\nexport { STORAGE_MIGRATOR_PLUGIN };\n"],"names":["pluginName","StorageMigrator","name","initialize","state","plugins","loadedPlugins","value","storage","migrate","key","storageEngine","errorHandler","logger","storedVal","getItem","checks","decryptedVal","decryptLegacy","decrypt","JSON","parse","err","onError","STORAGE_MIGRATION_ERROR"],"mappings":"sHAAA,MCcMA,EAAyB,kBAEzBC,EAAkBA,KAAwB,CAC9CC,KAAMF,EACNG,WAAaC,IACXA,EAAMC,QAAQC,cAAcC,MAAQ,IAAIH,EAAMC,QAAQC,cAAcC,MAAOP,EAAW,EAExFQ,QAAS,CACPC,OAAAA,CACEC,EACAC,EACAC,EACAC,GAEA,IACE,MAAMC,EAAYH,EAAcI,QAAQL,GACxC,GAAIM,EAAyBF,GAC3B,OAAO,KAGT,IAAIG,EAAmCC,EAAcJ,GAQrD,OAJIG,IAAiBH,IACnBG,EAAeE,EAAQL,IAGrBE,EAAyBC,GAChB,KAING,KAAKC,MAAMJ,EACpB,CAAE,MAAOK,GAEP,OADAV,SAAAA,EAAcW,QAAQD,ECjDE,wBFACZ,IAC/B,wCAAwCA,kBCgDkBc,CAAwBd,IACjE,IACb,CACF"}