{"version":3,"file":"rsa-plugins-remote-BeaconQueue.min.js","sources":["../../../../src/beaconQueue/logMessages.ts","../../../../src/beaconQueue/constants.ts","../../../../src/beaconQueue/utilities.ts","../../../../src/beaconQueue/index.ts"],"sourcesContent":["import { LOG_CONTEXT_SEPARATOR } from '@rudderstack/analytics-js-common/constants/logMessages';\n\nconst BEACON_PLUGIN_EVENTS_QUEUE_DEBUG = (context: string): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}Sending events to data plane.`;\n\nconst BEACON_QUEUE_STRING_CONVERSION_FAILURE_ERROR = (context: string): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}Failed to convert events batch object to string.`;\n\nconst BEACON_QUEUE_BLOB_CONVERSION_FAILURE_ERROR = (context: string): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}Failed to convert events batch object to Blob.`;\n\nconst BEACON_QUEUE_SEND_ERROR = (context: string): string =>\n  `${context}${LOG_CONTEXT_SEPARATOR}Failed to send events batch data to the browser's beacon queue. The events will be dropped.`;\n\nconst BEACON_QUEUE_DELIVERY_ERROR = (url: string): string =>\n  `Failed to send events batch data to the browser's beacon queue for URL ${url}.`;\n\nexport {\n  BEACON_PLUGIN_EVENTS_QUEUE_DEBUG,\n  BEACON_QUEUE_STRING_CONVERSION_FAILURE_ERROR,\n  BEACON_QUEUE_BLOB_CONVERSION_FAILURE_ERROR,\n  BEACON_QUEUE_SEND_ERROR,\n  BEACON_QUEUE_DELIVERY_ERROR,\n};\n","const DEFAULT_BEACON_QUEUE_MAX_SIZE = 10;\nconst DEFAULT_BEACON_QUEUE_FLUSH_INTERVAL_MS = 10 * 60 * 1000; // 10 minutes\n\n// Limit of the Beacon transfer mechanism on the browsers\nconst MAX_BATCH_PAYLOAD_SIZE_BYTES = 64 * 1024; // 64 KB\n\nconst DEFAULT_BEACON_QUEUE_OPTIONS = {\n  maxItems: DEFAULT_BEACON_QUEUE_MAX_SIZE,\n  flushQueueInterval: DEFAULT_BEACON_QUEUE_FLUSH_INTERVAL_MS,\n};\n\nconst REQUEST_TIMEOUT_MS = 10 * 1000; // 10 seconds\n\nconst DATA_PLANE_API_VERSION = 'v1';\n\nconst QUEUE_NAME = 'rudder_beacon';\n\nconst BEACON_QUEUE_PLUGIN = 'BeaconQueuePlugin';\n\nexport {\n  MAX_BATCH_PAYLOAD_SIZE_BYTES,\n  DEFAULT_BEACON_QUEUE_OPTIONS,\n  REQUEST_TIMEOUT_MS,\n  DATA_PLANE_API_VERSION,\n  QUEUE_NAME,\n  BEACON_QUEUE_PLUGIN,\n};\n","import { mergeDeepRight } from '@rudderstack/analytics-js-common/utilities/object';\nimport type { RudderEvent } from '@rudderstack/analytics-js-common/types/Event';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type { BeaconQueueOpts } from '@rudderstack/analytics-js-common/types/LoadOptions';\nimport { json, url } from '../shared-chunks/common';\nimport {\n  BEACON_QUEUE_STRING_CONVERSION_FAILURE_ERROR,\n  BEACON_QUEUE_BLOB_CONVERSION_FAILURE_ERROR,\n} from './logMessages';\nimport {\n  BEACON_QUEUE_PLUGIN,\n  DATA_PLANE_API_VERSION,\n  DEFAULT_BEACON_QUEUE_OPTIONS,\n} from './constants';\nimport type { BeaconBatchData } from './types';\n\n/**\n * Utility to get the stringified event payload as Blob\n * @param events RudderEvent object array\n * @param logger Logger instance\n * @returns stringified events payload as Blob, undefined if error occurs.\n */\nconst getBatchDeliveryPayload = (\n  events: RudderEvent[],\n  currentTime: string,\n  logger?: ILogger,\n): Blob | undefined => {\n  const data: BeaconBatchData = {\n    batch: events,\n    sentAt: currentTime,\n  };\n\n  try {\n    const blobPayload = json.stringifyWithoutCircular(data, true);\n    const blobOptions: BlobPropertyBag = { type: 'text/plain' };\n\n    if (blobPayload) {\n      return new Blob([blobPayload], blobOptions);\n    }\n    logger?.error(BEACON_QUEUE_STRING_CONVERSION_FAILURE_ERROR(BEACON_QUEUE_PLUGIN));\n  } catch (err) {\n    logger?.error(BEACON_QUEUE_BLOB_CONVERSION_FAILURE_ERROR(BEACON_QUEUE_PLUGIN), err);\n  }\n  return undefined;\n};\n\nconst getNormalizedBeaconQueueOptions = (queueOpts: BeaconQueueOpts): BeaconQueueOpts =>\n  mergeDeepRight(DEFAULT_BEACON_QUEUE_OPTIONS, queueOpts);\n\nconst getDeliveryUrl = (dataplaneUrl: string, writeKey: string): string => {\n  const dpUrl = new URL(dataplaneUrl);\n  return new URL(\n    url.removeDuplicateSlashes(\n      [\n        dpUrl.pathname,\n        '/',\n        'beacon',\n        '/',\n        DATA_PLANE_API_VERSION,\n        '/',\n        `batch?writeKey=${writeKey}`,\n      ].join(''),\n    ),\n    dpUrl,\n  ).href;\n};\n\nexport { getBatchDeliveryPayload, getDeliveryUrl, getNormalizedBeaconQueueOptions };\n","/* eslint-disable no-param-reassign */\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type { IHttpClient } from '@rudderstack/analytics-js-common/types/HttpClient';\nimport type { IStoreManager } from '@rudderstack/analytics-js-common/types/Store';\nimport type { IErrorHandler } from '@rudderstack/analytics-js-common/types/ErrorHandler';\nimport type { ILogger } from '@rudderstack/analytics-js-common/types/Logger';\nimport type {\n  BeaconQueueOpts,\n  QueueOpts,\n} from '@rudderstack/analytics-js-common/types/LoadOptions';\nimport type { RudderEvent } from '@rudderstack/analytics-js-common/types/Event';\nimport type { ExtensionPlugin } from '@rudderstack/analytics-js-common/types/PluginEngine';\nimport type { PluginName } from '@rudderstack/analytics-js-common/types/PluginsManager';\nimport { getCurrentTimeFormatted } from '@rudderstack/analytics-js-common/utilities/timestamp';\nimport type { DoneCallback, IQueue } from '../types/plugins';\nimport {\n  getNormalizedBeaconQueueOptions,\n  getDeliveryUrl,\n  getBatchDeliveryPayload,\n} from './utilities';\nimport { eventsDelivery, timestamp, storages } from '../shared-chunks/common';\nimport { BEACON_QUEUE_PLUGIN, MAX_BATCH_PAYLOAD_SIZE_BYTES, QUEUE_NAME } from './constants';\nimport type { BeaconQueueBatchItemData, BeaconQueueItemData } from './types';\nimport {\n  BEACON_PLUGIN_EVENTS_QUEUE_DEBUG,\n  BEACON_QUEUE_SEND_ERROR,\n  BEACON_QUEUE_DELIVERY_ERROR,\n} from './logMessages';\nimport { RetryQueue } from '../utilities/retryQueue/RetryQueue';\n\nconst pluginName: PluginName = 'BeaconQueue';\n\nconst BeaconQueue = (): ExtensionPlugin => ({\n  name: pluginName,\n  deps: [],\n  initialize: (state: ApplicationState) => {\n    state.plugins.loadedPlugins.value = [...state.plugins.loadedPlugins.value, pluginName];\n  },\n  dataplaneEventsQueue: {\n    /**\n     * Initialize the queue for delivery\n     * @param state Application state\n     * @param httpClient http client instance\n     * @param storeManager Store Manager instance\n     * @param errorHandler Error handler instance\n     * @param logger Logger instance\n     * @returns BeaconItemsQueue instance\n     */\n    init(\n      state: ApplicationState,\n      httpClient: IHttpClient,\n      storeManager: IStoreManager,\n      errorHandler?: IErrorHandler,\n      logger?: ILogger,\n    ): IQueue {\n      const writeKey = state.lifecycle.writeKey.value as string;\n      const dataplaneUrl = state.lifecycle.activeDataplaneUrl.value as string;\n      const url = getDeliveryUrl(dataplaneUrl, writeKey);\n\n      const finalQOpts: BeaconQueueOpts = getNormalizedBeaconQueueOptions(\n        state.loadOptions.value.beaconQueueOptions ?? {},\n      );\n\n      const queueProcessCallback = (itemData: BeaconQueueBatchItemData, done: DoneCallback) => {\n        logger?.debug(BEACON_PLUGIN_EVENTS_QUEUE_DEBUG(BEACON_QUEUE_PLUGIN));\n        const currentTime = getCurrentTimeFormatted();\n        const finalEvents = itemData.map((queueItemData: BeaconQueueItemData) =>\n          eventsDelivery.getFinalEventForDeliveryMutator(queueItemData.event, currentTime),\n        );\n        const data = getBatchDeliveryPayload(finalEvents, currentTime, logger);\n\n        if (data) {\n          try {\n            const isEnqueuedInBeacon = navigator.sendBeacon(url, data);\n            if (!isEnqueuedInBeacon) {\n              logger?.error(BEACON_QUEUE_SEND_ERROR(BEACON_QUEUE_PLUGIN));\n            }\n\n            done(null, isEnqueuedInBeacon);\n          } catch (err) {\n            errorHandler?.onError(err, BEACON_QUEUE_PLUGIN, BEACON_QUEUE_DELIVERY_ERROR(url));\n            // Remove the item from queue\n            done(null);\n          }\n        } else {\n          // Mark the item as done so that it can be removed from the queue\n          done(null);\n        }\n      };\n\n      const eventsQueue = new RetryQueue(\n        `${QUEUE_NAME}_${writeKey}`,\n        {\n          batch: {\n            enabled: true,\n            flushInterval: finalQOpts.flushQueueInterval,\n            maxSize: MAX_BATCH_PAYLOAD_SIZE_BYTES, // set the hard limit\n            maxItems: finalQOpts.maxItems,\n          },\n        } as QueueOpts,\n        queueProcessCallback,\n        storeManager,\n        storages.LOCAL_STORAGE,\n        logger,\n        (itemData: BeaconQueueItemData[]): number => {\n          const currentTime = getCurrentTimeFormatted();\n          const events = itemData.map((queueItemData: BeaconQueueItemData) => queueItemData.event);\n          // type casting to Blob as we know that the event has already been validated prior to enqueue\n          return (getBatchDeliveryPayload(events, currentTime, logger) as Blob).size;\n        },\n      );\n\n      return eventsQueue;\n    },\n\n    /**\n     * Add event to the queue for delivery\n     * @param state Application state\n     * @param eventsQueue IQueue instance\n     * @param event RudderEvent object\n     * @param errorHandler Error handler instance\n     * @param logger Logger instance\n     * @returns none\n     */\n    enqueue(\n      state: ApplicationState,\n      eventsQueue: IQueue,\n      event: RudderEvent,\n      errorHandler?: IErrorHandler,\n      logger?: ILogger,\n    ): void {\n      // sentAt is only added here for the validation step\n      // It'll be updated to the latest timestamp during actual delivery\n      event.sentAt = timestamp.getCurrentTimeFormatted();\n      eventsDelivery.validateEventPayloadSize(event, logger);\n\n      eventsQueue.addItem({\n        event,\n      } as BeaconQueueItemData);\n    },\n  },\n});\n\nexport { BeaconQueue };\n\nexport default BeaconQueue;\n"],"names":["DEFAULT_BEACON_QUEUE_OPTIONS","maxItems","flushQueueInterval","DATA_PLANE_API_VERSION","BEACON_QUEUE_PLUGIN","getBatchDeliveryPayload","events","currentTime","logger","data","batch","sentAt","blobPayload","json","Blob","type","error","LOG_CONTEXT_SEPARATOR","err","context","BEACON_QUEUE_BLOB_CONVERSION_FAILURE_ERROR","pluginName","BeaconQueue","name","deps","initialize","state","plugins","loadedPlugins","value","dataplaneEventsQueue","init","httpClient","storeManager","errorHandler","_state$loadOptions$va","writeKey","lifecycle","url","getDeliveryUrl","dataplaneUrl","dpUrl","URL","pathname","join","href","activeDataplaneUrl","finalQOpts","queueOpts","loadOptions","beaconQueueOptions","mergeDeepRight","eventsQueue","RetryQueue","enabled","flushInterval","maxSize","queueProcessCallback","itemData","done","debug","getCurrentTimeFormatted","finalEvents","map","queueItemData","eventsDelivery","event","isEnqueuedInBeacon","navigator","sendBeacon","BEACON_QUEUE_SEND_ERROR","onError","BEACON_QUEUE_DELIVERY_ERROR","storages","size","enqueue","timestamp","addItem"],"mappings":"qJAEA,MCIMA,EAA+B,CACnCC,SAPoC,GAQpCC,mBAP6C,KAYzCC,EAAyB,KAIzBC,EAAsB,oBCKtBC,EAA0BA,CAC9BC,EACAC,EACAC,KAEA,MAAMC,EAAwB,CAC5BC,MAAOJ,EACPK,OAAQJ,GAGV,IACE,MAAMK,EAAcC,EAA8BJ,GAAM,GAGxD,GAAIG,EACF,OAAW,IAAAE,KAAK,CAACF,GAHkB,CAAEG,KAAM,eAK7CP,SAAAA,EAAQQ,MFjCV,GEiC6DZ,IFjChDa,oDEkCb,CAAE,MAAOC,GACPV,SAAAA,EAAQQ,MFjCwCG,IAClD,GAAGA,IAAUF,kDEgCGG,CAA2ChB,GAAsBc,EACjF,CACgB,ECbZG,EAAyB,cAEzBC,EAAcA,MAClBC,KAAMF,EACNG,KAAM,GACNC,WAAaC,IACXA,EAAMC,QAAQC,cAAcC,MAAQ,IAAIH,EAAMC,QAAQC,cAAcC,MAAOR,EAAW,EAExFS,qBAAsB,CAUpBC,IAAAA,CACEL,EACAM,EACAC,EACAC,EACA1B,GACQ2B,IAAAA,EACR,MAAMC,EAAWV,EAAMW,UAAUD,SAASP,MAEpCS,EDRWC,EAACC,EAAsBJ,KAC5C,MAAMK,EAAQ,IAAIC,IAAIF,GACtB,OAAW,IAAAE,IACTJ,EACE,CACEG,EAAME,SACN,IACA,SACA,IACAxC,EACA,IACA,kBAAkBiC,KAClBQ,KAAK,KAETH,GACAI,IAAI,ECPUN,CADSb,EAAMW,UAAUS,mBAAmBjB,MACfO,GAEnCW,GDb6BC,ECcSb,QADuBA,EACjET,EAAMuB,YAAYpB,MAAMqB,8BAAkBf,EAAAA,EAAI,CAAA,EDbpDgB,EAAenD,EAA8BgD,IADNA,MCiBnC,MA2BMI,EAAc,IAAIC,EACtB,iBAAiBjB,IACjB,CACE1B,MAAO,CACL4C,SAAS,EACTC,cAAeR,EAAW7C,mBAC1BsD,QF5FyB,ME6FzBvD,SAAU8C,EAAW9C,YAlCEwD,CAACC,EAAoCC,KAChEnD,SAAAA,EAAQoD,MH7Dd,GG6DqDxD,IH7DxCa,kCG8DP,MAAMV,EAAcsD,IACdC,EAAcJ,EAASK,KAAKC,GAChCC,EAA+CD,EAAcE,MAAO3D,KAEhEE,EAAOJ,EAAwByD,EAAavD,EAAaC,GAE/D,GAAIC,EACF,IACE,MAAM0D,EAAqBC,UAAUC,WAAW/B,EAAK7B,GAChD0D,GACH3D,SAAAA,EAAQQ,MHhEWG,IAC/B,GAAGA,IAAUF,+FG+DaqD,CAAwBlE,IAGxCuD,EAAK,KAAMQ,EACb,CAAE,MAAOjD,GACPgB,SAAAA,EAAcqC,QAAQrD,EAAKd,EHlEFkC,IACnC,0EAA0EA,KGiEhBkC,CAA4BlC,IAE5EqB,EAAK,KACP,MAGAA,EAAK,KACP,GAcA1B,EACAwC,EACAjE,GACCkD,IACC,MAAMnD,EAAcsD,IACdvD,EAASoD,EAASK,KAAKC,GAAuCA,EAAcE,QAElF,OAAQ7D,EAAwBC,EAAQC,EAAaC,GAAiBkE,IAAI,IAI9E,OAAOtB,CACT,EAWAuB,OAAAA,CACEjD,EACA0B,EACAc,EACAhC,EACA1B,GAIA0D,EAAMvD,OAASiE,IACfX,EAAwCC,EAAO1D,GAE/C4C,EAAYyB,QAAQ,CAClBX,SAEJ"}