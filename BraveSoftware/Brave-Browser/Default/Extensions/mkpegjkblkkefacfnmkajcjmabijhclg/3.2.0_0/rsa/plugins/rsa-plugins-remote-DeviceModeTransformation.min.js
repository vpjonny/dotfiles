import{k as e,q as n,u as t,w as a,M as s}from"./rsa-plugins-common.min.js";import{R as i}from"./rsa-plugins-RetryQueue.min.js";const o={minRetryDelay:500,backoffFactor:2,maxAttempts:3},r="DeviceModeTransformationPlugin",l=(n,t,a,s)=>`${n}${e}Event transformation unsuccessful for destination "${t}". Reason: ${a}. ${s}.`,u=(n,t,a,s)=>`${n}${e}[Destination: ${t}].Transformation request failed with status: ${a}. Retries exhausted. ${s}.`,d=(t,a,s,i,o,d,c,m)=>{const f="Sending untransformed event",v="Dropping the event";t.nativeDestinations.initializedDestinations.value.filter((e=>e&&s.includes(e.id))).forEach((s=>{try{const p=[];switch(o){case 200:{const e=JSON.parse(i).transformedBatch.find((e=>e.id===s.id));null==e||e.payload.forEach((e=>{if("200"===e.status)p.push(e.event);else{let n="Unknown";"410"===e.status&&(n="Transformation is not available");let t=v;!0===s.propagateEventsUntransformedOnError?(t=f,p.push(d),null==m||m.warn(l(r,s.displayName,n,t))):null==m||m.error(l(r,s.displayName,n,t))}}));break}case 404:null==m||m.warn(`${r}${e}Transformation server access is denied. The configuration data seems to be out of sync. Sending untransformed event to the destination.`),p.push(d);break;default:!0===s.propagateEventsUntransformedOnError?(null==m||m.warn(u(r,s.displayName,o,f)),p.push(d)):null==m||m.error(u(r,s.displayName,o,v))}null==p||p.forEach((e=>{n(e)&&a.invokeSingle("destinationsEventsQueue.enqueueEventToDestination",t,e,s,c,m)}))}catch(e){null==c||c.onError(e,r,`[Destination:${s.displayName}].`)}}))},c="DeviceModeTransformation",m=()=>({name:c,deps:[],initialize:e=>{e.plugins.loadedPlugins.value=[...e.plugins.loadedPlugins.value,c]},transformEvent:{init(e,n,r,l,u,c){const m=e.lifecycle.writeKey.value;r.setAuthHeader(m);return new i(`rudder_${m}`,o,((s,i,o,l)=>{const m=(f=s.event,v=s.destinationIds,{metadata:{"Custom-Authorization":s.token},batch:[{orderNo:Date.now(),destinationIds:v,event:f}]});var f,v;r.getAsyncData({url:`${e.lifecycle.activeDataplaneUrl.value}/transform`,options:{method:"POST",data:t(m),sendRawData:!0},isRawResponse:!0,timeout:1e4,callback:(t,r)=>{const m=a(r)?r:null;var f;m&&o!==l||d(e,n,s.destinationIds,t,null==r||null===(f=r.xhr)||void 0===f?void 0:f.status,s.event,u,c);i(m,t)}})}),l,s)},enqueue(e,n,t,a){const s=a.map((e=>e.id));n.addItem({event:t,destinationIds:s,token:e.session.authToken.value})}}});export{m as DeviceModeTransformation,m as default};
//# sourceMappingURL=rsa-plugins-remote-DeviceModeTransformation.min.js.map
