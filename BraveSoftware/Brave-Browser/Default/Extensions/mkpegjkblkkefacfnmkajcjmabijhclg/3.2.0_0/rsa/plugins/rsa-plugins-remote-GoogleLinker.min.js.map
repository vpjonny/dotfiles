{"version":3,"file":"rsa-plugins-remote-GoogleLinker.min.js","sources":["../../../../src/googleLinker/constants.ts","../../../../src/googleLinker/userLib.ts","../../../../src/googleLinker/base64Decoder.ts","../../../../src/googleLinker/utils.ts","../../../../src/googleLinker/crc32.ts","../../../../src/googleLinker/index.ts"],"sourcesContent":["export const AMP_LINKER_ANONYMOUS_ID_KEY = 'rs_amp_id';\n","/**\n * An interface to fetch user device details.\n */\nconst USER_INTERFACE = {\n  /**\n   * @returns {string} user language\n   */\n  getUserLanguage: (): string => navigator?.language,\n\n  /**\n   * @returns {string} userAgent\n   */\n  getUserAgent: (): string => navigator?.userAgent,\n};\n\nexport { USER_INTERFACE };\n","/**\n * This is utility function for decoding from base 64 to utf8\n *\n * @param {string} str base64\n *\n * @returns {string} utf8\n */\nconst b64DecodeUnicode = (str: string): string =>\n  // Going backwards: from bytestream, to percent-encoding, to original string.\n  decodeURIComponent(\n    globalThis\n      .atob(str)\n      .split('')\n      .map(c => {\n        const percentEncodingChar = `00${c.charCodeAt(0).toString(16)}`;\n        return `%${percentEncodingChar.slice(-2)}`;\n      })\n      .join(''),\n  );\n\n/**\n * This is utility function for decoding from base 64 to utf8\n *\n * @param {string} data\n *\n * @return {string}\n */\nconst decode = (data = ''): string => {\n  const decodedData = data.endsWith('..') ? data.substring(0, data.length - 2) : data;\n  return b64DecodeUnicode(decodedData);\n};\n\nexport { decode };\n","import type { Nullable } from '@rudderstack/analytics-js-common/types/Nullable';\nimport { crc32 } from './crc32';\nimport { USER_INTERFACE } from './userLib';\nimport { decode } from './base64Decoder';\n\nconst KEY_VALIDATOR = /^[\\w.-]+$/;\nconst CHECKSUM_OFFSET_MAX_MIN = 1;\nconst VALID_VERSION = 1;\nconst DELIMITER = '*';\n\n/**\n * Parse the linker param value to version checksum and serializedParams\n *\n * @param {string} value\n *\n * @return {?Object}\n */\nconst parseLinkerParamValue = (value: string): Nullable<Record<string, string>> => {\n  const parts = value.split(DELIMITER);\n  const isEven = parts.length % 2 === 0;\n\n  if (parts.length < 4 || !isEven) {\n    // Format <version>*<checksum>*<key1>*<value1>\n    // Note: linker makes sure there's at least one pair of non empty key value\n    // Make sure there is at least three delimiters.\n    return null;\n  }\n\n  const version = Number(parts.shift());\n  if (version !== VALID_VERSION) {\n    return null;\n  }\n\n  const checksum = parts.shift();\n  const serializedIds = parts.join(DELIMITER);\n\n  return {\n    checksum: checksum ?? '',\n    serializedIds,\n  };\n};\n\n/**\n * Deserialize the serializedIds and return keyValue pairs.\n *\n * @param {string} serializedIds\n *\n * @return {!Object<string, string>}\n */\nconst deserialize = (serializedIds?: string): Record<string, string> => {\n  if (!serializedIds) {\n    return {};\n  }\n\n  const keyValuePairs: Record<string, string> = {};\n  const params = serializedIds.split(DELIMITER);\n  for (let i = 0; i < params.length; i += 2) {\n    const key = params[i] as string;\n    const valid = KEY_VALIDATOR.test(key);\n    if (valid) {\n      keyValuePairs[key] = decode(params[i + 1]);\n    }\n  }\n  return keyValuePairs;\n};\n\n/**\n * Generates a semi-unique value for page visitor.\n *\n * @return {string}\n */\nconst getFingerprint = (userAgent: string, language: string): string => {\n  const date = new Date();\n  const timezone = date.getTimezoneOffset();\n  return [userAgent, timezone, language].join(DELIMITER);\n};\n\n/**\n * Rounded time used to check if t2 - t1 is within our time tolerance.\n * Timestamp in minutes, floored.\n *\n * @return {number}\n */\nconst getMinSinceEpoch = (): number => Math.floor(Date.now() / 60000);\n\n/**\n * Create a unique checksum hashing the fingerprint and a few other values.\n *\n * @param {string} serializedIds\n * @param {number=} optOffsetMin\n * @param {string} userAgent\n * @param {string} language\n *\n * @return {string}\n */\nconst getCheckSum = (\n  serializedIds: string,\n  optOffsetMin: number,\n  userAgent: string,\n  language: string,\n): string => {\n  const fingerprint = getFingerprint(userAgent, language);\n  const offset = optOffsetMin || 0;\n  const timestamp = getMinSinceEpoch() - offset;\n  const crc = crc32([fingerprint, timestamp, serializedIds].join(DELIMITER));\n\n  // Encoded to base36 for fewer bytes.\n  return crc.toString(36);\n};\n\n/**\n * Check if the checksum is valid with time offset tolerance.\n *\n * @param {string} serializedIds\n * @param {string} checksum\n *\n * @return {boolean}\n */\nconst isCheckSumValid = (serializedIds: string, checksum: string): boolean => {\n  const userAgent = USER_INTERFACE.getUserAgent();\n  const language = USER_INTERFACE.getUserLanguage();\n\n  for (let i = 0; i <= CHECKSUM_OFFSET_MAX_MIN; i += 1) {\n    const calculateCheckSum = getCheckSum(serializedIds, i, userAgent, language);\n    if (calculateCheckSum === checksum) {\n      return true;\n    }\n  }\n\n  return false;\n};\n\n/**\n * AMP Linker Parser (works for Rudder, GA or any other linker created by following Google's linker standard.)\n *\n * @param {string} value\n *\n * @return {?Object<string, string>}\n */\nconst parseLinker = (value: string): Nullable<Record<string, string>> => {\n  const linkerObj = parseLinkerParamValue(value);\n\n  if (!linkerObj) {\n    return null;\n  }\n\n  const { checksum, serializedIds } = linkerObj;\n\n  if (!serializedIds || !checksum || !isCheckSumValid(serializedIds, checksum)) {\n    return null;\n  }\n\n  return deserialize(serializedIds);\n};\n\nexport { parseLinker };\n","/* eslint-disable no-bitwise */\n\n/**\n * generate crc table\n *\n * @params none\n * @returns array of CRC table\n */\n\nconst makeCRCTable = (): number[] => {\n  const crcTable = [];\n  let c;\n\n  for (let n = 0; n < 256; n++) {\n    c = n;\n    for (let k = 0; k < 8; k++) {\n      c = c & 1 ? 0xedb88320 ^ (c >>> 1) : c >>> 1;\n    }\n    crcTable[n] = c;\n  }\n\n  return crcTable;\n};\n\n/**\n * This is utility function for crc32 algorithm\n *\n * @param {string} str\n * @returns {number} crc32\n */\nconst crc32 = (str: string): number => {\n  const crcTable = makeCRCTable();\n  let crc = 0 ^ -1;\n\n  for (let i = 0; i < str.length; i++) {\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore\n    crc = (crc >>> 8) ^ crcTable[(crc ^ str.charCodeAt(i)) & 0xff];\n  }\n\n  return (crc ^ -1) >>> 0;\n};\n\nexport { crc32 };\n","/* eslint-disable no-param-reassign */\nimport type { ApplicationState } from '@rudderstack/analytics-js-common/types/ApplicationState';\nimport type { Nullable } from '@rudderstack/analytics-js-common/types/Nullable';\nimport type { ExtensionPlugin } from '@rudderstack/analytics-js-common/types/PluginEngine';\nimport type { PluginName } from '@rudderstack/analytics-js-common/types/PluginsManager';\nimport { AMP_LINKER_ANONYMOUS_ID_KEY } from './constants';\nimport { parseLinker } from './utils';\n\nconst pluginName: PluginName = 'GoogleLinker';\n\nconst GoogleLinker = (): ExtensionPlugin => ({\n  name: pluginName,\n  initialize: (state: ApplicationState) => {\n    state.plugins.loadedPlugins.value = [...state.plugins.loadedPlugins.value, pluginName];\n  },\n  userSession: {\n    anonymousIdGoogleLinker(rudderAmpLinkerParam?: Nullable<string>): Nullable<string | undefined> {\n      if (!rudderAmpLinkerParam) {\n        return null;\n      }\n\n      const parsedAnonymousIdObj = rudderAmpLinkerParam ? parseLinker(rudderAmpLinkerParam) : null;\n      return parsedAnonymousIdObj ? parsedAnonymousIdObj[AMP_LINKER_ANONYMOUS_ID_KEY] : null;\n    },\n  },\n});\n\nexport { GoogleLinker };\n\nexport default GoogleLinker;\n"],"names":["USER_INTERFACE","getUserLanguage","_navigator","navigator","language","getUserAgent","_navigator2","userAgent","decode","data","decodedData","endsWith","substring","length","str","decodeURIComponent","globalThis","atob","split","map","c","charCodeAt","toString","slice","join","KEY_VALIDATOR","DELIMITER","getCheckSum","serializedIds","optOffsetMin","fingerprint","getFingerprint","Date","getTimezoneOffset","offset","crcTable","makeCRCTable","n","k","crc","i","crc32","Math","floor","now","parseLinker","value","linkerObj","parts","isEven","Number","shift","checksum","parseLinkerParamValue","isCheckSumValid","keyValuePairs","params","key","test","deserialize","pluginName","GoogleLinker","name","initialize","state","plugins","loadedPlugins","userSession","anonymousIdGoogleLinker","rudderAmpLinkerParam","parsedAnonymousIdObj"],"mappings":"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"}