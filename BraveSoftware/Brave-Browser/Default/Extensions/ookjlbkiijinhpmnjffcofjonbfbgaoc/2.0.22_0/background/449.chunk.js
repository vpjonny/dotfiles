"use strict";(self.webpackChunktemple_wallet=self.webpackChunktemple_wallet||[]).push([[449,905],{13983:(e,t,r)=>{r.d(t,{Ay:()=>u});var i=r(37007),n=r.n(i),s=r(24450),o=r(13648),c=r(48287).Buffer,a=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{a(i.next(e))}catch(e){s(e)}}function c(e){try{a(i.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,c)}a((i=i.apply(e,t||[])).next())}))};class h{constructor({context:e,logType:t}={}){this.exchangeTimeout=3e4,this.unresponsiveTimeout=15e3,this.deviceModel=null,this._events=new(n()),this.send=(e,t,r,i,n=c.alloc(0),o=[s.vi.OK],{abortTimeoutMs:h}={})=>a(this,void 0,void 0,(function*(){const a=this.tracer.withUpdatedContext({function:"send"});if(n.length>=256)throw a.trace("data.length exceeded 256 bytes limit",{dataLength:n.length}),new s.TransportError("data.length exceed 256 bytes limit. Got: "+n.length,"DataLengthTooBig");a.trace("Starting an exchange",{abortTimeoutMs:h});const u=yield this.exchange(c.concat([c.from([e,t,r,i]),c.from([n.length]),n]),{abortTimeoutMs:h});a.trace("Received response from exchange");const l=u.readUInt16BE(u.length-2);if(!o.some((e=>e===l)))throw new s._3(l);return u})),this._appAPIlock=null,this.tracer=new o.PR(null!==t&&void 0!==t?t:"transport",e)}exchange(e,{abortTimeoutMs:t}={}){throw new Error("exchange not implemented")}exchangeBulk(e,t){let r=!1;return(()=>a(this,void 0,void 0,(function*(){if(!r)for(const i of e){const e=yield this.exchange(i);if(r)return;const n=e.readUInt16BE(e.length-2);if(n!==s.vi.OK)throw new s._3(n);t.next(e)}})))().then((()=>!r&&t.complete()),(e=>!r&&t.error(e))),{unsubscribe:()=>{r=!0}}}setScrambleKey(e){}close(){return Promise.resolve()}on(e,t){this._events.on(e,t)}off(e,t){this._events.removeListener(e,t)}emit(e,...t){this._events.emit(e,...t)}setDebugMode(){}setExchangeTimeout(e){this.exchangeTimeout=e}setExchangeUnresponsiveTimeout(e){this.unresponsiveTimeout=e}static create(e=3e3,t){return new Promise(((r,i)=>{let n=!1;const o=this.listen({next:t=>{n=!0,o&&o.unsubscribe(),c&&clearTimeout(c),this.open(t.descriptor,e).then(r,i)},error:e=>{c&&clearTimeout(c),i(e)},complete:()=>{c&&clearTimeout(c),n||i(new s.TransportError(this.ErrorMessage_NoDeviceFound,"NoDeviceFound"))}}),c=t?setTimeout((()=>{o.unsubscribe(),i(new s.TransportError(this.ErrorMessage_ListenTimeout,"ListenTimeout"))}),t):null}))}exchangeAtomicImpl(e){return a(this,void 0,void 0,(function*(){const t=this.tracer.withUpdatedContext({function:"exchangeAtomicImpl",unresponsiveTimeout:this.unresponsiveTimeout});if(this.exchangeBusyPromise)throw t.trace("Atomic exchange is already busy"),new s.IO("An action was already pending on the Ledger device. Please deny or reconnect.");let r;const i=new Promise((e=>{r=e}));this.exchangeBusyPromise=i;let n=!1;const o=setTimeout((()=>{t.trace('Timeout reached, emitting Transport event "unresponsive"',{unresponsiveTimeout:this.unresponsiveTimeout}),n=!0,this.emit("unresponsive")}),this.unresponsiveTimeout);try{const r=yield e();return n&&(t.trace("Device was unresponsive, emitting responsive"),this.emit("responsive")),r}finally{t.trace("Finalize, clearing busy guard"),clearTimeout(o),r&&r(),this.exchangeBusyPromise=null}}))}decorateAppAPIMethods(e,t,r){for(const i of t)e[i]=this.decorateAppAPIMethod(i,e[i],e,r)}decorateAppAPIMethod(e,t,r,i){return(...n)=>a(this,void 0,void 0,(function*(){const{_appAPIlock:o}=this;if(o)return Promise.reject(new s.TransportError("Ledger Device is busy (lock "+o+")","TransportLocked"));try{return this._appAPIlock=e,this.setScrambleKey(i),yield t.apply(r,n)}finally{this._appAPIlock=null}}))}setTraceContext(e){this.tracer=this.tracer.withContext(e)}updateTraceContext(e){this.tracer.updateContext(e)}getTraceContext(){return this.tracer.getContext()}}h.ErrorMessage_ListenTimeout="No Ledger device found (timeout)",h.ErrorMessage_NoDeviceFound="No Ledger device found";const u=h},13648:(e,t,r)=>{r.d(t,{PR:()=>o,Rm:()=>s});let i=0;const n=[],s=(e,t,r)=>{const n={type:e,id:String(++i),date:new Date};t&&(n.message=t),r&&(n.data=r),a(n)};class o{constructor(e,t){this.type=e,this.context=t}trace(e,t){(({type:e,message:t,data:r,context:n})=>{const s={type:e,id:String(++i),date:new Date};t&&(s.message=t),r&&(s.data=r),n&&(s.context=n),a(s)})({type:this.type,message:e,data:t,context:this.context})}getContext(){return this.context}setContext(e){this.context=e}updateContext(e){this.context=Object.assign(Object.assign({},this.context),e)}getType(){return this.type}setType(e){this.type=e}withType(e){return new o(e,this.context)}withContext(e){return new o(this.type,e)}withUpdatedContext(e){return new o(this.type,Object.assign(Object.assign({},this.context),e))}}const c=e=>(n.push(e),()=>{const t=n.indexOf(e);-1!==t&&(n[t]=n[n.length-1],n.pop())});function a(e){for(let t=0;t<n.length;t++)try{n[t](e)}catch(e){}}"undefined"!==typeof window&&(window.__ledgerLogsListen=c)},69905:(e,t,r)=>{r.r(t),r.d(t,{getLedgerTransportType:()=>o,isPkRetrievalError:()=>u,isPkhRetrievalError:()=>l,removeMFromDerivationPath:()=>s,toLedgerError:()=>h});var i=r(10495),n=r(37287);const s=e=>e.startsWith("m/")?e.substring(2):e,o=()=>c()?n.Y.WEBHID:a()?n.Y.WEBAUTHN:n.Y.U2F,c=()=>Boolean(navigator?.hid),a=()=>Boolean(navigator?.credentials),h=e=>{const t="object"===typeof e?e.message:e;return new i.I(`Ledger error. ${t}`)},u=e=>e instanceof Error&&"PublicKeyRetrievalError"===e.name,l=e=>e instanceof Error&&"PublicKeyHashRetrievalError"===e.name},14449:(e,t,r)=>{r.r(t),r.d(t,{createLedgerSigner:()=>B});var i=r(69905),n=r(48110),s=r(19444),o=r(17432),c=r(48287).Buffer;function a(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{a(i.next(e))}catch(e){s(e)}}function c(e){try{a(i.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,c)}a((i=i.apply(e,t||[])).next())}))}"function"===typeof SuppressedError&&SuppressedError;function h(e){const t=[];e.split("/").forEach((e=>{let r=parseInt(e,10);Number.isNaN(r)||(e.length>1&&"'"===e[e.length-1]&&(r+=2147483648),t.push(r))}));const r=c.alloc(1+4*t.length);return r[0]=t.length,t.forEach(((e,t)=>{r.writeUInt32BE(e,1+4*t)})),r}function u(e,t){const r=c.alloc(32);r.fill(0);let i=t[e],n=e+1;return i>32&&(n+=i-32,i=32),t.copy(r,32-i,n,n+i),{buffer:r,idxValueStart:n,length:i}}class l extends o.TaquitoError{constructor(e){super(),this.message=e,this.name="InvalidLedgerResponseError"}}class p extends o.TaquitoError{constructor(e){super(),this.cause=e,this.name="PublicKeyRetrievalError",this.message="Unable to retrieve Public Key from Ledger"}}class d extends o.TaquitoError{constructor(){super(),this.name="PublicKeyHashRetrievalError",this.message="Unable to retrieve Public Key Hash from Ledger"}}class g extends o.ParameterValidationError{constructor(e){super(),this.derivationType=e,this.name="InvalidDerivationTypeError",this.message=`Invalid derivation type ${e} expecting one of the following: DerivationType.ED25519, DerivationType.SECP256K1, DerivationType.P256 or DerivationType.BIP32_ED25519`}}var y;!function(e){e[e.ED25519=0]="ED25519",e[e.SECP256K1=1]="SECP256K1",e[e.P256=2]="P256",e[e.BIP32_ED25519=3]="BIP32_ED25519"}(y||(y={}));class f{constructor(e,t="44'/1729'/0'/0'",r=!0,i=y.ED25519){if(this.transport=e,this.path=t,this.prompt=r,this.derivationType=i,this.CLA=128,this.INS_GET_PUBLIC_KEY=2,this.INS_PROMPT_PUBLIC_KEY=3,this.INS_SIGN=4,this.FIRST_MESSAGE_SEQUENCE=0,this.LAST_MESSAGE_SEQUENCE=129,this.OTHER_MESSAGE_SEQUENCE=1,this.transport.setScrambleKey("XTZ"),!t.startsWith("44'/1729'"))throw new o.InvalidDerivationPathError(t,"expecting prefix \"44'/1729'\".");if(!Object.values(y).includes(i))throw new g(i.toString())}publicKeyHash(){return a(this,void 0,void 0,(function*(){if(this._publicKeyHash||(yield this.publicKey()),this._publicKeyHash)return this._publicKeyHash;throw new d}))}publicKey(){return a(this,void 0,void 0,(function*(){if(this._publicKey)return this._publicKey;const e=yield this.getLedgerPublicKey(),t=e[0],r=function(e,t){return 0===t||3===t?e=e.slice(1):(e[0]=2+(1&e[64]),e=e.slice(0,33)),e}(e.slice(1,1+t),this.derivationType),i=this.getPrefixes(),o=(0,n.aP)(r,i.prefPk),c=(0,n.aP)((0,s.tW)(r,20),i.prefPkh);return this._publicKey=o,this._publicKeyHash=c,o}))}getLedgerPublicKey(){return a(this,void 0,void 0,(function*(){try{let e=this.INS_PROMPT_PUBLIC_KEY;!1===this.prompt&&(e=this.INS_GET_PUBLIC_KEY);return yield this.transport.send(this.CLA,e,this.FIRST_MESSAGE_SEQUENCE,this.derivationType,h(this.path))}catch(e){throw new p(e)}}))}secretKey(){return a(this,void 0,void 0,(function*(){throw new o.ProhibitedActionError("Secret key cannot be exposed")}))}sign(e,t){return a(this,void 0,void 0,(function*(){const r=function(e,t){let r=e;"undefined"!==typeof t&&(r=c.from(t).toString("hex").concat(e));return r}(e,t),i=c.from(r,"hex");let s=[];s.push(h(this.path)),s=function(e,t){let r=0;for(;r!==t.length;){const i=r+230>=t.length?t.length-r:230,n=c.alloc(i);t.copy(n,0,r,r+i),e.push(n),r+=i}return e}(s,i);const o=yield this.signWithLedger(s);let a;if(this.derivationType===y.ED25519||this.derivationType===y.BIP32_ED25519)a=o.slice(0,o.length-2).toString("hex");else{if(!function(e){let t=!0;49!==e[0]&&48!==e[0]&&(t=!1),e[1]+4!==e.length&&(t=!1),2!==e[2]&&(t=!1);const r=e[3];2!==e[4+r]&&(t=!1);const i=5+r;return i+1+e[i]+2!==e.length&&(t=!1),t}(o))throw new l("Invalid signature return by ledger unable to parse the response");const e=u(3,o),t=u(e.idxValueStart+e.length+1,o);a=c.concat([e.buffer,t.buffer]).toString("hex")}return{bytes:e,sig:(0,n.aP)(a,n.Rk.GenericSignature),prefixSig:(0,n.aP)(a,this.getPrefixes().prefSig),sbytes:e+a}}))}signWithLedger(e){return a(this,void 0,void 0,(function*(){let t=yield this.transport.send(this.CLA,this.INS_SIGN,this.FIRST_MESSAGE_SEQUENCE,this.derivationType,e[0]);for(let r=1;r<e.length;r++){const i=r===e.length-1?this.LAST_MESSAGE_SEQUENCE:this.OTHER_MESSAGE_SEQUENCE;t=yield this.transport.send(this.CLA,this.INS_SIGN,i,this.derivationType,e[r])}return t}))}getPrefixes(){return this.derivationType===y.ED25519||this.derivationType===y.BIP32_ED25519?{prefPk:n.Rk.Ed25519PublicKey,prefPkh:n.Rk.Ed25519PublicKeyHash,prefSig:n.Rk.Ed25519Signature}:this.derivationType===y.SECP256K1?{prefPk:n.Rk.Secp256k1PublicKey,prefPkh:n.Rk.Secp256k1PublicKeyHash,prefSig:n.Rk.Secp256k1Signature}:{prefPk:n.Rk.P256PublicKey,prefPkh:n.Rk.P256PublicKeyHash,prefSig:n.Rk.P256Signature}}}var E=r(86729),v=r(48402),m=r(64527),b=r.n(m),w=r(52781);class P extends f{accPublicKey;accPublicKeyHash;constructor(e,t=w.m7,r=!0,i=y.ED25519,n,s){super(e,t,r,i),this.accPublicKey=n,this.accPublicKeyHash=s}async publicKey(){return this.accPublicKey??this.withErrorCauseThrow((()=>super.publicKey()),i.isPkRetrievalError)}async publicKeyHash(){return this.accPublicKeyHash??this.withErrorCauseThrow((()=>super.publicKeyHash()),i.isPkhRetrievalError)}async withErrorCauseThrow(e,t){return e().catch((e=>{if(t(e)&&e.cause instanceof Error)throw e.cause;throw e}))}async sign(e,t){const r=await super.sign(e,t).catch((e=>{throw(0,i.toLedgerError)(e)}));let s=(0,n.$$)(e);"undefined"!==typeof t&&(s=(0,n.m6)(t,s));const o=(0,n.hi)(b()(s));if(!await this.verify(o,r.prefixSig))throw(0,i.toLedgerError)(new Error("Signature failed verification against public key. Maybe the account on your device does not match the account from which you are trying to perform the action."));return r}async verify(e,t){await v.ready;const r=await this.publicKey(),i=await this.publicKeyHash();return x(e,t,r,i)}}const T={ed:{pk:n.Rk.Ed25519PublicKey,sk:n.Rk.Ed25519SecretKey,pkh:n.Rk.Ed25519PublicKeyHash,sig:n.Rk.Ed25519Signature},p2:{pk:n.Rk.P256PublicKey,sk:n.Rk.P256SecretKey,pkh:n.Rk.P256PublicKeyHash,sig:n.Rk.P256Signature},sp:{pk:n.Rk.Secp256k1PublicKey,sk:n.Rk.Secp256k1SecretKey,pkh:n.Rk.Secp256k1PublicKeyHash,sig:n.Rk.Secp256k1Signature}},S=["sig","edsig","spsig","p2sig"],x=(e,t,r,i)=>{const s=r.substring(0,2),o=new Uint8Array(b()((0,n.$9)(r,[T[s].pk],!0))),c=t.startsWith("sig")?t.substring(0,3):t.substring(0,5);if(!S.includes(c))throw new Error(`Unsupported signature given by remote signer: ${t}`);if((0,n.aP)((0,v.crypto_generichash)(20,o),T[s].pkh)!==i)throw new Error(`Requested public key does not match the initialized public key hash: {\n          publicKey: ${r},\n          publicKeyHash: ${i}\n        }`);const a=new Uint8Array(k(t,s,T)),h=(0,v.crypto_generichash)(32,(0,n.$$)(e));if("ed"===s)return K(a,h,o);if("sp"===s)return _(a,h,o);if("p2"===s)return I(a,h,o);throw new Error(`Curve '${s}' not supported`)},k=(e,t,r)=>{let i;if("sig"===e.substring(0,3))i=(0,n.$9)(e,[n.Rk.GenericSignature],!0);else{if(e.substring(0,5)!==`${t}sig`)throw new Error(`Invalid signature provided: ${e}`);i=(0,n.$9)(e,[r[t].sig],!0)}return i},K=(e,t,r)=>{try{return(0,v.crypto_sign_verify_detached)(e,t,r)}catch(e){return!1}},_=(e,t,r)=>{const i=new E.ec("secp256k1").keyFromPublic(r),s=(0,n.hi)(b()(e)).match(/([a-f\d]{64})/gi);if(s)try{const[e,r]=s;return i.verify(t,{r:e,s:r})}catch(e){return!1}return!1},I=(e,t,r)=>{const i=new E.ec("p256").keyFromPublic(r),s=(0,n.hi)(b()(e)).match(/([a-f\d]{64})/gi);if(s)try{const[e,r]=s;return i.verify(t,{r:e,s:r})}catch(e){return!1}return!1};var R=r(24450),C=r(13983),L=r(37287),A=r(48287).Buffer;class D extends C.Ay{static async isSupported(){return!0}static async list(){return[]}static listen(){return{unsubscribe:()=>{}}}scrambleKey;transportType;bridge;constructor(e=L.Y.U2F){super(),this.transportType=e}async exchange(e){const t=await this.getBridge(),r={apdu:e.toString("hex"),scrambleKey:this.scrambleKey?.toString("ascii"),exchangeTimeout:this.exchangeTimeout,transportType:this.transportType};let i;try{i=await t.requestExchange(r)}catch(e){throw new R.TransportError(e.message,"id")}return A.from(i,"hex")}updateTransportType(e){this.transportType=e}setScrambleKey(e){this.scrambleKey=A.from(e,"ascii")}async close(){if(this.bridge)return this.bridge.close()}async getBridge(){if(this.bridge)return this.bridge;const e=new(0,(await Promise.all([r.e(589),r.e(628)]).then(r.bind(r,17628))).TransportBridge);return this.bridge=e}}const B=async(e,...[t,r,n,s])=>{const o=await H(e);return{signer:new P(o,(0,i.removeMFromDerivationPath)(t),!0,r,n,s),cleanup:()=>{}}};let U;const H=async e=>(U&&await U.close(),U=new D(e),U)},37287:(e,t,r)=>{var i;r.d(t,{Y:()=>i}),function(e){e.U2F="u2f",e.WEBHID="webhid",e.WEBAUTHN="webauthn"}(i||(i={}))}}]);