(()=>{"use strict";class e{static sendMessageToBackground(t,n){return e.sendMessageToAnywhere(t,n)}static sendMessageToAppUi(t,n){return e.sendMessageToAnywhere(t,n)}static sendMessageToAnywhere(e,t){try{globalThis.chrome?.runtime?.sendMessage(e,t)}catch(e){console.error(e)}}static addEventListenerFromBackground(t){return e.addEventListenerFromAnywhere(t)}static addEventListenerFromAppUi(t){return e.addEventListenerFromAnywhere(t)}static addEventListenerFromAnywhere(e){return globalThis.chrome?.runtime?.onMessage?.addListener(e)}static async getLocalStorage(t){return new Promise(((n,o)=>globalThis.chrome?.storage?.local?.get(t,(r=>{const s=e.checkForError();s?o(s):n(r[t])}))))}static async getAllLocalStorage(){return new Promise(((t,n)=>globalThis.chrome?.storage?.local?.get((o=>{const r=e.checkForError();r?n(r):t(o)}))))}static async removeLocalStorage(e){return globalThis.chrome?.storage?.local?.remove(e)}static async setLocalStorage(t,n){return new Promise(((o,r)=>{const s={};s[t]=n,globalThis.chrome?.storage?.local?.set(s,(()=>{const t=e.checkForError();t?r(t):o()}))}))}static async setAllLocalStorage(t){return new Promise(((n,o)=>{globalThis.chrome?.storage.local.clear((()=>{globalThis.chrome?.storage?.local?.set(t,(()=>{const t=e.checkForError();t?o(t):n()}))}))}))}static async clearLocalStorage(){return new Promise(((t,n)=>{globalThis.chrome?.storage.local.clear((()=>{const o=e.checkForError();o?n(o):t()}))}))}static async getSessionStorage(t){return new Promise(((n,o)=>globalThis.chrome?.storage?.session?.get(t,(r=>{const s=e.checkForError();s?o(s):n(r[t])}))))}static async getAllSessionStorage(){return new Promise(((t,n)=>globalThis.chrome?.storage?.session?.get((o=>{const r=e.checkForError();r?n(r):t(o)}))))}static async removeSessionStorage(e){return globalThis.chrome?.storage?.session?.remove(e)}static async setSessionStorage(t,n){return new Promise(((o,r)=>{const s={};s[t]=n,globalThis.chrome?.storage?.session?.set(s,(()=>{const t=e.checkForError();t?r(t):o()}))}))}static async setAllSessionStorage(t){return new Promise(((n,o)=>{globalThis.chrome?.storage.session.clear((()=>{globalThis.chrome?.storage?.session?.set(t,(()=>{const t=e.checkForError();t?o(t):n()}))}))}))}static async clearSessionStorage(){return new Promise(((t,n)=>{globalThis.chrome?.storage.session.clear((()=>{const o=e.checkForError();o?n(o):t()}))}))}static checkForError(){const e=globalThis.chrome?.runtime?.lastError;return e?new Error(e.message):void 0}}class t{static getUrl(e){return globalThis.chrome?.runtime?.getURL(e)}static async openTab(t){return new Promise(((n,o)=>{chrome?.tabs.create(t,(t=>{const r=e.checkForError();return r?o(r):n(t)}))}))}}const n=globalThis.chrome?(()=>{try{const e=Number(navigator.userAgent.match(/Chrome\/(\d+)/)[1]);if(e>100)return e;throw`Invalid Chrome Version number, or too old (${e})`}catch(e){return console.error("Chrome Version",e.message),-1}})():-1;const o=globalThis;function r(){return"undefined"!=typeof chrome&&chrome.runtime?"undefined"!=typeof self&&o.clients&&o.clients.matchAll?"service-worker":"app":"not-supported"}function s(){return o.isMobileInjectedProvider}const i=(Object.freeze(Object.fromEntries(Object.entries({"0xbae207659db88bea0cbead6da0ed00aac12edcdda169e591cd41c94180b46f3b":!0,"0xaf88d065e77c8cC2239327C5EDb3A432268e5831":!0,"0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E":!0,"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913":!0,"0xd996633a415985DBd7D6D12f4A4343E31f5037cf":!0,"0xcebA9300f2b948710d2653dD7B07f33A8B32118C":!0,"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48":!0,"0xb88339CB7199b77E23DB6E890353E22632Ba630f":!0,"0x2D270e6886d130D724215A266106e6832161EAEd":!0,"0x176211869cA2b568f2A7D4EE941E073a821EE1ff":!0,"0x754704Bc059F8C67012fEd69BC8A327a5aafb603":!0,"17208628f84f5d6ad33f0da3bbbeb27ffcb398eac501a31bd6ad2011e36133a1":!0,"0x0b2C639c533813f4Aa9D7837CAf62653d097Ff85":!0,"0x222365EF19F7947e5484218551B56bb3965Aa7aF":!0,"0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359":!0,"0xe15fC38F6D8c56aF07bbCBe3BAf5708A2Bf42392":!0,EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v:!0,"0x29219dd400f2Bf60E5a23d13Be72B486D4038894":!0,"0xdba34672e30cb065b1f93e3ab55318768fd6fef66c15942c9f7cb846e2f900e7::usdc::USDC":!0,TEkxiTehnzSmSe2XqrBj4w32RUN966rdz8:!0,"0x078D782b760474a361dDA0AF3839290b0EF57AD6":!0,"0x79A02482A880bCe3F13E09da970dC34dB4cD24D1":!0,"0xfA2958CB79b0491CC627c1557F441eF849Ca8eb1":!0,"0x1d17CBcF0D6D143135aE902365D2E5e2A16538D4":!0}).map((([e,t])=>[e.toLowerCase(),t])))),new Map),a=new Map;class c{isMonitoring=!1;protectedElements=new Map;monitoringInterval=null;mutationObserver=null;config;statusCallbacks=[];scanInterval=500;isWebEnvironment(){return"undefined"!=typeof window&&"undefined"!=typeof document&&"undefined"!=typeof MutationObserver}constructor(e={}){this.config={popoverSelectors:['[data-testid*="popover"]','[data-testid*="modal"]','[data-testid*="dialog"]',".ant-modal",".ant-popover",".chakra-modal",".chakra-popover",".mantine-modal",".mantine-popover","[data-web-popover]","[data-page-popover]","[data-external-popover]",'[role="dialog"]','[role="alertdialog"]',"[data-wallet-popover]","[data-transaction-dialog]","[data-approval-dialog]",".wallet-popover",".transaction-dialog",".approval-dialog",".modal",".popover",".dialog",".overlay","[data-backpack-popover]","[data-extension-popover]"],context:"content-script",...e}}start(){this.isMonitoring||this.isWebEnvironment()&&(this.isMonitoring=!0,this.scanForVulnerableElements(),this.monitoringInterval=window.setInterval((()=>{this.scanForVulnerableElements()}),this.scanInterval),this.observeDOMChanges(),this.notifyStatusChange())}stop(){this.isMonitoring&&(this.isMonitoring=!1,this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.restoreAllElements(),this.notifyStatusChange())}getStatus(){return{isMonitoring:this.isMonitoring&&this.isWebEnvironment(),protectedCount:this.protectedElements.size,lastScanTime:Date.now(),context:this.config.context}}onStatusChange(e){return this.statusCallbacks.push(e),()=>{const t=this.statusCallbacks.indexOf(e);t>-1&&this.statusCallbacks.splice(t,1)}}scan(){this.scanForVulnerableElements()}updateConfig(e){this.config={...this.config,...e}}protectElement(e){if("none"===e.style.pointerEvents){if(this.isExtensionPopupElement(e))return!1;const t=e.style.pointerEvents||"";return e.style.pointerEvents="auto",this.protectedElements.set(e,t),!0}return!1}isExtensionPopupElement(e){if("app-extension"===this.config.context)return!e.hasAttribute("data-web-popover")&&!e.hasAttribute("data-page-popover")&&!e.hasAttribute("data-external-popover");let t=e.parentElement;for(;t;){if(t.id?.includes("extension")||t.className?.includes("extension")||t.className?.includes("popup")||t.className?.includes("backpack")||"BODY"===t.tagName&&t.id?.includes("extension"))return!0;t=t.parentElement}return!!(e.id?.includes("extension")||e.className?.includes("extension")||e.className?.includes("popup")||e.className?.includes("backpack"))}scanForVulnerableElements(){this.isMonitoring&&this.isWebEnvironment()&&this.config.popoverSelectors.forEach((e=>{try{document.querySelectorAll(e).forEach((e=>{this.protectedElements.has(e)||this.protectElement(e)}))}catch(e){}}))}observeDOMChanges(){this.isWebEnvironment()&&(this.mutationObserver=new MutationObserver((e=>{e.forEach((e=>{if("attributes"===e.type&&"style"===e.attributeName){const t=e.target;t.style&&"none"===t.style.pointerEvents&&this.isPopoverElement(t)&&this.protectElement(t)}}))})),this.mutationObserver.observe(document.body,{attributes:!0,attributeFilter:["style"],subtree:!0}))}isPopoverElement(e){return this.config.popoverSelectors.some((t=>{try{return e.matches(t)}catch{return!1}}))}restoreAllElements(){this.protectedElements.forEach(((e,t)=>{t.style.removeProperty("pointer-events")})),this.protectedElements.clear()}notifyStatusChange(){const e=this.getStatus();this.statusCallbacks.forEach((t=>{try{t(e)}catch(e){}}))}destroy(){this.stop(),this.statusCallbacks=[]}}const l=!1,d="channel-secure-background-request",u="mobile-logs";let h;const p=globalThis;function g(e,...t){h<=4&&m(`ERROR: ${e}`,...t)}function m(e,...t){l&&p.___toApp?function(...e){p.___toApp({channel:u,data:e})}(e,...t):l&&b()?async function(...e){(await self.clients.matchAll({includeUncontrolled:!0,type:"window"})).forEach((t=>{t.postMessage({channel:u,data:e})}))}(e,...t):function(e,...t){console.log(e,...t)}(e,...t)}function b(){return void 0!==p.clients}const E=["xnft","browser","solanaAction","mobileWalletAdapter"],f=("content-script",void 0===h&&(h=5),(()=>{const e="content-script",t=p.___toApp?"hidden-webview:":b()?"service-worker:":"";return{debug:(n,...o)=>function(e,...t){h<=1&&m(e,...t)}(`backpack:${t} ${e}: ${n}`,...o),error:(n,...o)=>function(e,...t){h<=4&&m(`ERROR: ${e}`,...t)}(`backpack:${t} ${e}: ${n}`,...o)}})());let w=null;try{w=new c({context:"content-script"}),w.start(),f.debug("Clickjacking protection initialized and started successfully")}catch(g){f.error("Failed to initialize clickjacking protection:",g)}f.debug("starting content script"),f.debug("pre injected.js"),function(e){try{const e=document.head||document.documentElement,n=document.createElement("script");n.setAttribute("async","false"),n.src=t.getUrl("injected.js"),e.insertBefore(n,e.children[0]),e.removeChild(n)}catch(e){f.error("provider injection failed.",e)}}(),f.debug("post injected.js"),f.debug("provider injected"),f.debug("creating content channel"),function(){try{f.debug("initChannels pre proxy"),t=d,n="channel-secure-background-response",window.addEventListener("message",(async o=>{if(!o.data||o.data.type!==t)return;if(!function(e){return e.isTrusted?e.origin&&"string"==typeof e.origin&&e.origin.includes("__proto__")?(console.debug("isValidEvent: proto pollution in event origin"),!1):"undefined"==typeof window||!e.origin||e.origin===window.location.origin||(console.debug("isValidEvent: origins don't match",e.origin,window.location.origin),!1):(console.debug("isValidEvent: untrusted event"),!1)}(o))return;if(o.data.type===d){const e=o.data?.detail?.params?.[0]?.origin;if(!e||e.address!==o.origin||(r=e.context,!E.includes(r)))throw console.error(e,window.document.title,o.origin),new Error("ChannelContentScript: SecureEvent - Invalid Origin")}var r;const s=o.data.detail,c=await async function(t,n){const{reqChannel:o,respChannel:r,originUrl:s}=n,c=t.detail,l=c?.params?.[0]||c;if("SECURE_USER_SET_ACTIVE_NETWORK"!==l?.name)return!1;const d={sendRequest:t=>new Promise((n=>{e.sendMessageToAnywhere({channel:o,data:"ContentScriptTransportSenderRequest"===c.method?{id:c.id,method:c.method,params:[t]}:t},(e=>{n(e)}))})),sendResponse:e=>{window.postMessage({type:r,detail:e},"*")}};return await async function(e,t,n){return"SECURE_USER_SET_ACTIVE_NETWORK"===e.name&&await async function(e,t,n){const o=e.request,r=`${o.blockchainId}:${o.blockchain}:${t}`,{sendRequest:s,sendResponse:c}=n,l=i.get(r);if(l)return c({...await l,id:e.id}),!0;const d=a.get(r);if(d){await d;const t=i.get(r);if(t)return c({...await t,id:e.id}),!0}let u;const h=new Promise((e=>{u=e}));a.set(r,h);const p=s(e);return i.set(r,p),u(),a.delete(r),p.then((()=>{i.delete(r)})).catch((()=>{i.delete(r)})),c(await p),!0}(e,t,n)}(l,s,d)}(o.data,{reqChannel:t,respChannel:n,originUrl:o.origin});c||e.sendMessageToAnywhere({channel:t,data:s},(e=>{e&&window.postMessage({type:n,detail:e},"*")}))})),f.debug("initChannels pre proxyReverse"),function(t){e.addEventListenerFromAnywhere(((e,n,i)=>{!("app"===r()?"extension-app":"service-worker"===r()?"extension-sw":s()?"mobile-injected-provider":"undefined"==typeof window||void 0===window.document?"mobile-app":"undefined"==typeof window||void 0===window.document||!o._backpack_injected_provider||s()?"unknown":"web-injected-provider").startsWith("mobile")&&globalThis.chrome?.runtime?.id&&n.id!==globalThis.chrome?.runtime?.id||e.channel===t&&(i({result:"success"}),window.postMessage({type:t,detail:e.data},"*"))}))}("channel-secure-background-notification"),f.debug("initChannels done")}catch(e){f.error("content script initChannels error",e)}var t,n}(),f.debug("content channel created");const v={};chrome.runtime.onMessage.addListener((e=>{Object.values(v).forEach((t=>{t(e)}))})),window.addEventListener("bpSidePanelEvent",(async e=>{if(!e.isTrusted)return null;let t=e.detail.action;const o=e.detail.id;if(globalThis?.chrome&&n>=118&&!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&function(){const{hostname:e,protocol:t}=new URL(window.location.href);return["http:","https:"].includes(t)&&["localhost","backpack.exchange","www.backpack.exchange"].includes(e)}())if(t){const e=await chrome.runtime.sendMessage({type:"IS_SIDE_PANEL_OPEN"});if("toggle"===t&&(t=e?"close":"open"),"open"===t){if(e)return void window.dispatchEvent(new CustomEvent("bpSidePanelEventResponse",{detail:{id:o}}));if(o){const e=e=>{"NOTIFICATION_SECURE_UI_CONNECTED"===e?.data?.name&&(window.dispatchEvent(new CustomEvent("bpSidePanelEventResponse",{detail:{id:o}})),delete v[o])};v[o]=e}await chrome.runtime.sendMessage({type:"OPEN_SIDE_PANEL"})}"close"===t&&(await chrome.runtime.sendMessage({type:"CLOSE_SIDE_PANEL"}),o&&window.dispatchEvent(new CustomEvent("bpSidePanelEventResponse",{detail:{id:o}})))}else{const t=document.getElementById(e.detail.elementId);if(!t)throw new Error(`Element not found (#${e.detail.elementId})`);t.onclick=async function(){await chrome.runtime.sendMessage({type:"CLOSE_SIDE_PANEL"})||await chrome.runtime.sendMessage({type:"OPEN_SIDE_PANEL"})}}else window.dispatchEvent(new CustomEvent("bpSidePanelEventResponse",{detail:{id:o,error:"Not a valid context for toggling the side panel"}}))}))})();