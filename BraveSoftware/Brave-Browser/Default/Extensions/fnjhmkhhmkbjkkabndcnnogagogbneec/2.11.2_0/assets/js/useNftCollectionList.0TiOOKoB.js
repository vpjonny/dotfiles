import{aj as k,am as T,N as p,l as I,R as M,a as O,c as j,a8 as _,an as K,ao as Y,E as G,O as L}from"./windowUtils.Ut7JS-rc.js";import{u as x,g as Q,d as q,U as S}from"./useActiveTimeStore.C3Wei7Oz.js";import{Y as V,i as Z,Z as H,_ as J,$ as v,a0 as D,a1 as P,a2 as U}from"./PopupLoading.D-LitESe.js";async function oa(t,r){const e=new k(r.rpcUrl),a=new T(t,["function supportsInterface(bytes4 interfaceID) view returns (bool)"],e),c="0x80ac58cd",d="0xd9b67a26";return await a.supportsInterface(c)?p.ERC721:await a.supportsInterface(d)?p.ERC1155:null}async function ia({contractAddress:t,tokenId:r,chainConfig:e,tokenType:a,accountAddress:c}){const d=new k(e.rpcUrl);return a===p.ERC1155?await new T(t,["function balanceOf(address account, uint256 tokenId) view returns (uint256)"],d).balanceOf(c,r)>BigInt(0):a===p.ERC721?(await new T(t,["function ownerOf(uint256 tokenId) view returns (address)"],d).ownerOf(r)).toLowerCase()===c.toLowerCase():!1}const z=1e3*60,W=(t,r)=>{var e,a;return t.itemAmount===r.itemAmount?(a=(e=t.name)==null?void 0:e.localeCompare)==null?void 0:a.call(e,r.name):r.itemAmount-t.itemAmount},X=({chainIds:t,addresses:r})=>{const{getChainByConfigId:e,data:a}=x(),{toast:c}=Q(),d=async o=>{if(I.isEmpty(o))return;const C=await Promise.all(o.map(async g=>{var w;const m=await e(g);return(w=m==null?void 0:m.chainConfig)==null?void 0:w.displayName}));c({icon:S,title:O.common.errors.failedToFetchNftBalance,content:`${O.home.chains} ${C.join(", ")}`})},{data:u,isFetching:h,isLoading:f,isError:l,refetch:i}=q({queryKey:[M.COLLECTION_BALANCE,r,t],staleTime:z,enabled:!I.isEmpty(r)&&!I.isEmpty(t),queryFn:async()=>{var o,C,g,m,w,R,E,b,A;try{const s=await V({addresses:r,chainIds:t});if(!I.isEmpty(s==null?void 0:s.chainErrors)){const n=(o=s==null?void 0:s.chainErrors)==null?void 0:o.map(y=>y.chainId);d(n)}return(((C=s==null?void 0:s.data)==null?void 0:C.items)??[]).sort(W)}catch(s){if(console.error("[COLLECTION-BALANCE-ERROR:]",s),a!=null&&a.isSingleChain){c({icon:S,title:O.common.errors.failedToFetchNftBalance,content:`${O.home.chains} ${(m=(g=a==null?void 0:a.activeChains[0])==null?void 0:g.chainConfig)==null?void 0:m.displayName}`});return}if(!I.isEmpty((R=(w=s==null?void 0:s.response)==null?void 0:w.data)==null?void 0:R.chainErrors)){const n=(A=(b=(E=s==null?void 0:s.response)==null?void 0:E.data)==null?void 0:b.chainErrors)==null?void 0:A.map(y=>y.chainId);d(n)}}}});return{data:u,isFetching:h,isLoading:f,isError:l,refetch:i}},aa=t=>{var b,A;const{data:r}=x(),e=(r==null?void 0:r.activeChains)??[],a=e.map(s=>s.chainConfig.chainId),c=e.filter(s=>!s.chainConfig.isCustom).map(s=>s.chainConfig.chainId),d=((A=(b=e[0])==null?void 0:b.chainConfig)==null?void 0:A.isCustom)===!0,{data:u}=Z(),{data:h,isLoading:f,isFetching:l,isError:i,refetch:o}=X({chainIds:c,addresses:t}),{data:C,isFetching:g,isLoading:m,isError:w,refetch:R}=q({queryKey:[M.NFT_LIST_MULTICHAIN,t,a],enabled:!f,queryFn:async()=>{const s={data:[],error:[],total:0};return d?t.forEach(async n=>{var F,B;const y=((F=u==null?void 0:u.customNftsList)==null?void 0:F[n].filter(N=>a.includes(N.chainConfigId)))??[];if((y==null?void 0:y.length)>0){const N=await na(n,(B=e[0])==null?void 0:B.chainConfig,y);s.data.push(...N),s.total=N==null?void 0:N.length}}):e&&s.data.push(...h.map(n=>({chainId:n==null?void 0:n.chainId,name:n==null?void 0:n.name,ownerAddress:t[0],collectionAddress:n==null?void 0:n.collectionAddress,itemAmount:n==null?void 0:n.itemAmount,standard:n==null?void 0:n.standard,logo:(n==null?void 0:n.logo)??"",banner:n==null?void 0:n.banner,isCustom:!1}))),h==null||h.map(n=>{s.total+=(n==null?void 0:n.itemAmount)??0}),s}});return{data:C,isFetching:l||g,isLoading:m||f,isError:w||i,refetch:async()=>{await o(),await R()},refetchNftListOnly:R}},ca=(t,r)=>{var c;const{data:e,isLoading:a}=aa(r);return{collection:(c=e==null?void 0:e.data)==null?void 0:c.find(d=>j(d==null?void 0:d.collectionAddress,t)),isLoading:a}},na=async(t,r,e)=>{if(!t)return[];const a=H(await J({chainId:r.chainId}),r.chainId),c=[],d=Math.ceil(e.length/v),u=[];for(let i=0;i<d;i++)u.push(e.slice(i*v,v));for(let i=0;i<u.length;i++){const o=[];u[i].forEach(C=>{const g=C.tokenType===p.ERC721?D.encodeFunctionData("balanceOf",[t]):P.encodeFunctionData("balanceOf",[t,C.tokenId]),m=ta(C.tokenType).encodeFunctionData("name");o.push({target:C.contractAddress,allowFailure:!0,callData:g},{target:C.contractAddress,allowFailure:!0,callData:m})}),c.push(a.aggregate3(o))}const h=(await Promise.all(c)).flat(),f=[],l={};for(let i=0;i<e.length;i++){const o=e[i],[C,g]=h[i*2],[m,w]=h[i*2+1],R=new _(g.slice(2),16).gt(new _(0));if(!C||!R)continue;let E=l[o==null?void 0:o.chainConfigId];E||(E=await K(o==null?void 0:o.chainConfigId),l[o==null?void 0:o.chainConfigId]=E);const b=O.common.unknownCollection,A=m?Y.defaultAbiCoder().decode(["string"],w)[0]:b,s={collectionAddress:o.contractAddress,chainId:(E==null?void 0:E.chainConfig.chainId)??G.RONIN,itemAmount:Number(new _(g.slice(2),16)),name:A,standard:o.tokenType.toLowerCase(),logo:"",isCustom:!0};f.push(s)}return f},ta=t=>{switch(t){case p.ERC20:return U;case p.ERC721:return D;case p.ERC1155:return P;default:return U}},$=async t=>{const r=L(t),a=await(await fetch(r)).json();return{tokenImage:L(I.get(a,"image","")),name:I.get(a,"name",""),tokenVideo:I.get(a,"animation_url",""),traits:I.get(a,"attributes",[])}},da=async({chainConfig:t,contractAddress:r,ownerAddress:e})=>{const a=new k(t.rpcUrl),c=[],d=["function balanceOf(address owner) view returns (uint256)","function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)","function tokenURI(uint256 tokenId) view returns (string)"],u=new T(r,d,a),h=await u.balanceOf(e);for(let f=0;f<h;f++){const l=await u.tokenOfOwnerByIndex(e,f),i=L(await u.tokenURI(l)),o=await $(i);c.push({metadata:o,tokenId:l==null?void 0:l.toString(),tokenUri:i,quantity:1,contractAddress:r,tokenName:o.name,tokenSymbol:"",tokenStandard:p.ERC721})}return c},ua=async({chainConfig:t,contractAddress:r,ownerAddress:e,tokenIds:a})=>{const c=new k(t.rpcUrl),d=[],u=["function balanceOf(address account, uint256 id) view returns (uint256)","function uri(uint256 tokenId) view returns (string)"],h=new T(r,u,c);for(let f=0;f<a.length;f++){const l=await h.balanceOf(e,a[f]);if(l>0){const i=L(await h.uri(a[f])),o=await $(i);d.push({metadata:o,tokenId:a[f],tokenUri:i,quantity:l.toString(),contractAddress:r,tokenName:o.name,tokenSymbol:"",tokenStandard:p.ERC1155})}}return d};export{ua as a,ca as b,da as f,oa as g,ia as i,aa as u};
