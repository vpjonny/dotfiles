import{j as e,a3 as X,a4 as Y,a5 as q,a6 as Z,i as M,d as _,f as ee,a7 as O,a8 as F,a9 as W,aa as L,ab as D,ac as H,h as k,ad as se,u as I,r as o,ae as P,af as te,ag as ne,ah as ae,ai as re,aj as oe,ak as ie,al as ce,am as de,an as le,ao as ue,ap as fe,B as R,aq as me,ar as he,n as pe,o as xe,as as Q,at as ge,au as G,av as K,aw as U,ax as Te,ay as Ae,az as $,aA as ye,aB as we,aC as Se,aD as Ce,aE as je,aF as Ne,aG as z,aH as Ee,aI as b,aJ as ke,aK as J,aL as be,aM as Be,aN as ve,s as Re,aO as Me,e as _e,g as Fe,aP as We,aQ as Le,aR as De,aS as He,aT as V,aU as Ve,aV as Oe,aW as Ie,aX as Pe,aY as Qe,aZ as Ge,a_ as Ke}from"./main.D-W_HyrW.js";import{T as Ue}from"./TransitionGroup.CMby87Kf.js";const $e=({onBack:n,onClose:s})=>e.jsxs(X,{children:[e.jsx(Y,{onClick:n,children:e.jsx(q,{})}),e.jsx(Z,{handleClose:s})]}),ze=({nftItem:n})=>{const{t:s}=M(),t=_(),a=ee();return e.jsxs(O,{fullWidth:!0,children:[n.collection&&e.jsx(F,{onClick:()=>t.copyToClipboard(k(n.collection.address,a,!0)),children:e.jsxs(W,{children:[e.jsx(L,{children:s("NFT_collection_id")}),e.jsx(D,{children:H(k(n.collection.address,a,!0))})]})}),e.jsx(F,{onClick:()=>t.copyToClipboard(k(n.address,a,!0)),children:e.jsxs(W,{children:[e.jsx(L,{children:s("NFT_item_id")}),e.jsx(D,{children:H(k(n.address,a,!0))})]})})]})},Je=new ae({asset:z,weiAmount:0}),Xe=(n,s,t)=>{const a=Q(),l=ge(),d=G(),f=o.useMemo(()=>{if(t){if(a.type==="ton-multisig")return{type:"multisig",ttlSeconds:5*60};if(t==="external")return K;if(t==="battery")return U;throw new Error(`Unsupported sender type for nft transfer ${t}`)}},[t,a]),x=Te(f),T=Ae(x),A=$();return ye([we.estimate,s?.address,l,T],async()=>{try{if(a.type==="watch-only")throw new Error("account not controllable");const r=new b(a.activeTonWallet.rawAddress),i=await x(),m=r.encodeNftTransfer({nftAddress:n.address,recipientAddress:s.toAccount.address,forwardPayload:s.comment?J.comment(s.comment):null,responseAddress:"excessAddress"in i&&i.excessAddress?i.excessAddress:void 0});return await A.estimate(i,m)}catch(r){throw await d(r),r}},{enabled:s!=null&&!!x&&f!==void 0})},Ye=(n,s,t,a)=>{const l=Q(),d=Se(),{mutateAsync:f}=Ce(),x=je(),T=$(),A=G();return Ne(async()=>{if(l.type==="watch-only")return console.error("Can't send a transfer using this account"),!1;if(!t)return!1;if(t.fee.type==="ton-asset"&&t.fee.extra.asset.id!==z.id)throw new Error(`Unexpected fee ${t.fee}`);try{let r;if(l.type==="ton-multisig"){if(a.multisigTTL===void 0)throw new Error("TTL must be specified for multisig sending");r={type:"multisig",ttlSeconds:60*Number(a.multisigTTL)}}else if(a.selectedSenderType==="external")r=K;else if(a.selectedSenderType==="battery")r=U;else throw new Error(`Unsupported sender type for nft transfer ${a.selectedSenderType}`);const i=await x(r);if(i instanceof Ee)await(await i.nftTransfer({to:n.toAccount.address,nftTransferAmount:b.nftTransferBase,nftAddress:s.address,comment:n.comment})).send();else{const m=new b(l.activeTonWallet.rawAddress),w=new ke(b.nftTransferBase.toString()).plus(Math.abs(t.event?.extra??0)),h=m.encodeNftTransfer({nftAddress:s.address,recipientAddress:n.toAccount.address,forwardPayload:n.comment?J.comment(n.comment):null,nftTransferAmountWei:w,responseAddress:"excessAddress"in i&&i.excessAddress?i.excessAddress:void 0});await T.send(i,be,h)}d("send-nft")}catch(r){await A(r)}return await f(),!0})},qe={type:"nfr_transfer"},Ze=({recipient:n,onClose:s,nftItem:t,headerBlock:a,mainButton:l,multisigTTL:d,isAnimationProcess:f})=>{const T=se()&&f,{standalone:A}=I(),[r,i]=o.useState(!1),{t:m}=M(),w=P(),{data:h}=te(qe),[y,S]=o.useState(),N=Xe(t,n,y),{mutateAsync:B,isLoading:g,error:C,reset:v,isIdle:E}=Ye(n,t,N.data,{multisigTTL:d,selectedSenderType:y});o.useEffect(()=>{E&&h&&S(h[0].type)},[JSON.stringify(h),E]);const j=t.previews?.find(u=>u.resolution==="100x100"),c=async()=>{if(g)return!1;try{v();const u=await B();return u&&(i(!0),setTimeout(s,2e3)),u}catch(u){return console.error(u),!1}},p=async u=>{u.stopPropagation(),u.preventDefault()};return e.jsx(ne.Provider,{value:{recipient:n,assetAmount:Je,estimation:N,formState:{done:r,isLoading:g,error:C},onClose:()=>s(),onBack:()=>{},handleSubmit:c},children:e.jsxs(re,{onSubmit:p,standalone:A,children:[a,e.jsxs(oe,{children:[j?e.jsx(ie,{src:j.url}):e.jsx(ce,{}),e.jsx(de,{children:t.dns??t.metadata.name}),e.jsx(le,{children:m("txActions_signRaw_types_nftItemTransfer")})]}),e.jsxs(O,{margin:!1,fullWidth:!0,children:[e.jsx(ue,{}),e.jsx(fe,{blockchain:R.TON,availableSendersOptions:h,selectedSenderType:y,onSenderTypeChange:S}),e.jsx(me,{})]}),e.jsx(ze,{nftItem:t}),e.jsx(he,{}),w&&d?e.jsx(ss,{ttl:d}):null,!T&&e.jsx(pe,{children:e.jsx(xe,{children:l})})]})})},es=Re(Me)`
    margin-bottom: 1rem;
`,ss=({ttl:n})=>{const{data:s}=Be(),{signerWallet:t}=ve();return s?e.jsx(es,{status:"progress",signedWallets:[],threshold:s.threshold,pendingWallets:s.signers,hostAddress:t.rawAddress,secondsLeft:Number(n)*60}):null},ts=({nftItem:n,onClose:s})=>{const t=_(),{t:a}=M(),{standalone:l,extension:d}=I(),f=o.useRef(null),x=o.useRef(null),T=o.useRef(null),[A,r]=o.useState(!0),[i,m]=o.useState(),w=P(),{mutateAsync:h}=Fe(),y=async c=>{r(!0),m(c),C("confirm")},S=o.useCallback(()=>{r(!1),m(c=>c?{...c,done:!1}:void 0),C("recipient")},[m]),[N,B]=o.useState(),[g,C]=o.useState(w?"multisig-settings":"recipient"),v=o.useCallback(async({address:c})=>{const p={address:c},u=await h(p);y({address:{...p,blockchain:R.TON},toAccount:u,comment:"",done:!0})},[y,h]),E=async c=>{const p=Ke({url:c});if(p===null)return t.uiEvents.emit("copy",{method:"copy",params:a("Unexpected_QR_Code")});await v(p)},j={"multisig-settings":f,recipient:x,confirm:T}[g];return e.jsx(We,{standalone:l,extension:d,children:e.jsx(Ue,{childFactory:Le(A),children:e.jsx(De,{nodeRef:j,classNames:"right-to-left",addEndListener:c=>{setTimeout(c,Ge)},children:c=>e.jsxs("div",{ref:j,children:[g==="multisig-settings"&&e.jsx(He,{onSubmit:p=>{r(!0),B(p.lifetime),C("recipient")},isAnimationProcess:c==="exiting",header:e.jsx(Ve,{title:a("multisig_create_order_title"),onClose:s}),MainButton:V}),g==="recipient"&&e.jsx(Oe,{data:i,setRecipient:y,onScan:E,acceptBlockchains:[R.TON],MainButton:V,HeaderBlock:()=>e.jsx(Ie,{title:a("nft_transfer_title"),onClose:s,onBack:w?S:void 0}),isAnimationProcess:c==="exiting"}),g==="confirm"&&e.jsx(Ze,{onClose:s,recipient:i,nftItem:n,mainButton:e.jsx(Pe,{MainButton:Qe}),headerBlock:e.jsx($e,{onBack:S,onClose:s}),multisigTTL:N,isAnimationProcess:c==="exiting"})]})},g)})})},rs=()=>{const n=_(),[s,t]=o.useState(),a=o.useCallback(()=>{t(void 0)},[t]);o.useEffect(()=>{const d=f=>{t(f.params)};return n.uiEvents.on("transferNft",d),()=>{n.uiEvents.off("transferNft",d)}},[]);const l=o.useCallback(()=>{if(s)return e.jsx(ts,{onClose:a,nftItem:s})},[s,a]);return e.jsx(_e,{isOpen:!!s,handleClose:a,hideButton:!0,backShadow:!0,mobileFullScreen:!0,children:l})};export{rs as default};
