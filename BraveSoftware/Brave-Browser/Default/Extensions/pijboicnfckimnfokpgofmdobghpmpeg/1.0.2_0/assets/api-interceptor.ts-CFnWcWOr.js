var w=Object.defineProperty;var g=(o,e,t)=>e in o?w(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var r=(o,e,t)=>g(o,typeof e!="symbol"?e+"":e,t);import{E as l}from"./actions-CDg_QFWJ.js";import"./api-CJSKnqK3.js";import"./_commonjsHelpers-Cpj98o6Y.js";const u=(o,e)=>/^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)/i.test(o),a=(o,e)=>/^(https?:\/\/)?(www\.)?(twitter\.com|x\.com)/i.test(o);class p{constructor(){r(this,"interceptorInjected",!1);r(this,"messageHandler",null);r(this,"isInitialized",!1)}injectApiInterceptor(){if(this.interceptorInjected){console.log("[Twitteræ—¶é—´çº¿] æ‹¦æˆªå™¨å·²æ³¨å…¥ï¼Œè·³è¿‡");return}console.log("[Twitteræ—¶é—´çº¿] ğŸš€ å¼€å§‹æ³¨å…¥APIæ‹¦æˆªå™¨");try{const e=document.getElementById("trex-twitter-interceptor");e&&(console.log("[Twitteræ—¶é—´çº¿] å‘ç°å·²å­˜åœ¨çš„è„šæœ¬æ ‡ç­¾ï¼Œå…ˆç§»é™¤"),e.remove(),this.interceptorInjected=!1);const t=document.createElement("script");if(t.src=chrome.runtime.getURL("x-api-inject.js"),t.id="trex-twitter-interceptor",t.onload=()=>{console.log("[Twitteræ—¶é—´çº¿] âœ… è„šæœ¬åŠ è½½æˆåŠŸï¼Œå³å°†ç§»é™¤scriptæ ‡ç­¾"),t.remove(),window.postMessage({type:"TREX_INITIALIZE_TWITTER_INTERCEPTOR",timestamp:Date.now()},"*"),this.interceptorInjected=!0},t.onerror=i=>{console.error("[Twitteræ—¶é—´çº¿] âŒ è„šæœ¬åŠ è½½å¤±è´¥:",i)},document.documentElement)document.documentElement.appendChild(t);else{const i=new MutationObserver(()=>{document.documentElement&&(document.documentElement.appendChild(t),i.disconnect())});i.observe(document,{childList:!0,subtree:!0})}}catch(e){console.error("[Twitteræ—¶é—´çº¿] âŒ è„šæœ¬æ³¨å…¥å¤±è´¥:",e)}}async handleTwitterRequestData(e,t=0){try{await new Promise((i,n)=>{chrome.runtime.sendMessage({type:l.TwitterSendApiData,data:e},I=>{if(chrome.runtime.lastError){n(chrome.runtime.lastError);return}i()}),setTimeout(()=>{n(new Error("æ¶ˆæ¯å‘é€è¶…æ—¶"))},3e3)})}catch{if(t<2)return await new Promise(n=>setTimeout(n,1e3)),this.handleTwitterRequestData(e,t+1);console.log("[Twitteræ—¶é—´çº¿] âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ”¾å¼ƒå‘é€")}}async ensureInitialized(e){if(this.isInitialized){console.log("[Twitteræ—¶é—´çº¿] æ‹¦æˆªå™¨å·²åˆå§‹åŒ–ï¼Œæ— éœ€é‡å¤åˆå§‹åŒ–");return}await this.init(e)}async init(e){if(console.log("[Twitteræ—¶é—´çº¿] ğŸš€ å¼€å§‹åˆå§‹åŒ–ï¼ŒURL:",e),!e.includes("twitter.com")&&!e.includes("x.com")){console.log("[Twitteræ—¶é—´çº¿] âš ï¸ ä¸æ˜¯Twitter/Xç½‘ç«™ï¼Œè·³è¿‡åˆå§‹åŒ–");return}if(this.isInitialized){console.log("[Twitteræ—¶é—´çº¿] âš ï¸ å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡");return}try{this.cleanup(),this.injectApiInterceptor(),this.messageHandler=t=>{var i;t.source!==window||t.data.type!=="TREX_TWITTER_API_DATA"||this.handleTwitterRequestData((i=t.data)==null?void 0:i.content)},window.addEventListener("message",this.messageHandler),console.log("[Twitteræ—¶é—´çº¿] ğŸ‘‚ å·²æ·»åŠ æ¶ˆæ¯ç›‘å¬å™¨"),console.log("[Twitteræ—¶é—´çº¿] ğŸ“£ å‘é€åˆå§‹åŒ–æ¶ˆæ¯åˆ°é¡µé¢è„šæœ¬"),window.postMessage({type:"TREX_INITIALIZE_TWITTER_INTERCEPTOR",timestamp:Date.now()},"*"),this.isInitialized=!0,console.log("[Twitteræ—¶é—´çº¿] âœ… åˆå§‹åŒ–å®Œæˆ")}catch(t){console.error("[Twitteræ—¶é—´çº¿] âŒ åˆå§‹åŒ–å¤±è´¥:",t)}}cleanup(){console.log("[Twitteræ—¶é—´çº¿] å¼€å§‹æ¸…ç†"),window.postMessage({type:"TREX_CLEANUP_TWITTER_INTERCEPTOR",timestamp:Date.now()},"*"),this.messageHandler&&(console.log("[Twitteræ—¶é—´çº¿] ç§»é™¤æ¶ˆæ¯ç›‘å¬å™¨"),window.removeEventListener("message",this.messageHandler),this.messageHandler=null);const e=document.getElementById("trex-twitter-interceptor");e&&(console.log("[Twitteræ—¶é—´çº¿] ç§»é™¤è„šæœ¬æ ‡ç­¾"),e.remove()),this.interceptorInjected=!1,this.isInitialized=!1,console.log("[Twitteræ—¶é—´çº¿] æ¸…ç†å®Œæˆ")}}const s=new p;class h{constructor(){r(this,"interceptorInjected",!1);r(this,"messageHandler",null);r(this,"isInitialized",!1)}injectApiInterceptor(){if(!this.interceptorInjected)try{const e=document.getElementById("trex-youtube-interceptor");e&&(console.log("[YouTube API] å‘ç°å·²å­˜åœ¨çš„è„šæœ¬æ ‡ç­¾ï¼Œå…ˆç§»é™¤"),e.remove(),this.interceptorInjected=!1);const t=document.createElement("script");if(t.src=chrome.runtime.getURL("youtube-api-inject.js"),t.id="trex-youtube-interceptor",t.onload=()=>{console.log("[YouTube API] âœ… è„šæœ¬åŠ è½½æˆåŠŸï¼Œå³å°†ç§»é™¤scriptæ ‡ç­¾"),t.remove(),window.postMessage({type:"TREX_INITIALIZE_YOUTUBE_INTERCEPTOR",timestamp:Date.now()},"*"),this.interceptorInjected=!0},t.onerror=i=>{console.error("[YouTube API] âŒ è„šæœ¬åŠ è½½å¤±è´¥:",i)},document.documentElement)document.documentElement.appendChild(t);else{const i=new MutationObserver(()=>{document.documentElement&&(document.documentElement.appendChild(t),i.disconnect())});i.observe(document,{childList:!0,subtree:!0})}console.log("[YouTube API] ğŸ“ å·²æ·»åŠ è„šæœ¬æ ‡ç­¾æˆ–è®¾ç½®ç›‘å¬å™¨")}catch(e){console.error("[YouTube API] âŒ è„šæœ¬æ³¨å…¥å¤±è´¥:",e)}}async handleYouTubeRequestData(e,t=0){try{await new Promise((i,n)=>{chrome.runtime.sendMessage({type:l.YouTubeSendApiData,data:e},I=>{if(chrome.runtime.lastError){n(chrome.runtime.lastError);return}i()}),setTimeout(()=>{n(new Error("æ¶ˆæ¯å‘é€è¶…æ—¶"))},3e3)}),console.log("[YouTube API] âœ… æ•°æ®å‘é€æˆåŠŸ")}catch{if(t<2)return await new Promise(n=>setTimeout(n,1e3)),this.handleYouTubeRequestData(e,t+1);console.log("[YouTube API] âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ”¾å¼ƒå‘é€")}}async ensureInitialized(e){if(this.isInitialized){console.log("[YouTube API] æ‹¦æˆªå™¨å·²åˆå§‹åŒ–ï¼Œæ— éœ€é‡å¤åˆå§‹åŒ–");return}await this.init(e)}async init(e){if(console.log("[YouTube API] ğŸš€ å¼€å§‹åˆå§‹åŒ–ï¼ŒURL:",e),!e.includes("youtube.com")){console.log("[YouTube API] âš ï¸ ä¸æ˜¯YouTubeç½‘ç«™ï¼Œè·³è¿‡åˆå§‹åŒ–");return}if(this.isInitialized){console.log("[YouTube API] âš ï¸ å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡");return}try{this.cleanup(),this.injectApiInterceptor(),this.messageHandler=t=>{var i;t.source!==window||t.data.type!=="TREX_YOUTUBE_API_DATA"||this.handleYouTubeRequestData((i=t.data)==null?void 0:i.content)},window.addEventListener("message",this.messageHandler),console.log("[YouTube API] ğŸ‘‚ å·²æ·»åŠ æ¶ˆæ¯ç›‘å¬å™¨"),console.log("[YouTube API] ğŸ“£ å‘é€åˆå§‹åŒ–æ¶ˆæ¯åˆ°é¡µé¢è„šæœ¬"),window.postMessage({type:"TREX_INITIALIZE_YOUTUBE_INTERCEPTOR",timestamp:Date.now()},"*"),this.isInitialized=!0,console.log("[YouTube API] âœ… åˆå§‹åŒ–å®Œæˆ")}catch(t){console.error("[YouTube API] âŒ åˆå§‹åŒ–å¤±è´¥:",t)}}cleanup(){console.log("[YouTube API] å¼€å§‹æ¸…ç†"),window.postMessage({type:"TREX_CLEANUP_YOUTUBE_INTERCEPTOR",timestamp:Date.now()},"*"),this.messageHandler&&(console.log("[YouTube API] ç§»é™¤æ¶ˆæ¯ç›‘å¬å™¨"),window.removeEventListener("message",this.messageHandler),this.messageHandler=null);const e=document.getElementById("trex-youtube-interceptor");e&&(console.log("[YouTube API] ç§»é™¤è„šæœ¬æ ‡ç­¾"),e.remove()),this.interceptorInjected=!1,this.isInitialized=!1,console.log("[YouTube API] æ¸…ç†å®Œæˆ")}}const c=new h;let m=null,T=null;const A=()=>{console.log("[APIæ‹¦æˆªå™¨] å¼€å§‹åˆå§‹åŒ–APIæ‹¦æˆªå™¨..."),P(),f(),b()},P=()=>{chrome.runtime.sendMessage({type:l.CheckLoginStatus},o=>{const e=o==null?void 0:o.success;if(console.log("[APIæ‹¦æˆªå™¨] ç™»å½•çŠ¶æ€:",e),e){const t=window.location.href;d(t)}else console.log("[APIæ‹¦æˆªå™¨] ç”¨æˆ·æœªç™»å½•ï¼Œä¸åˆå§‹åŒ–APIæ‹¦æˆªå™¨")})},b=()=>{chrome.storage.onChanged.addListener((o,e)=>{if(e==="local"&&o.trex_login_data){const t=o.trex_login_data.newValue;if(t&&t.token){console.log("[APIæ‹¦æˆªå™¨] æ£€æµ‹åˆ°ç”¨æˆ·ç™»å½•ï¼Œåˆå§‹åŒ–APIæ‹¦æˆªå™¨");const i=window.location.href;d(i)}else t||(console.log("[APIæ‹¦æˆªå™¨] æ£€æµ‹åˆ°ç”¨æˆ·ç™»å‡ºï¼Œæ¸…ç†APIæ‹¦æˆªå™¨"),y(window.location.href))}if(e==="local"&&o.trex_twitter_permission){const t=o.trex_twitter_permission.newValue;m&&clearTimeout(m),m=setTimeout(()=>{Y(t)},100)}if(e==="local"&&o.trex_youtube_permission){const t=o.trex_youtube_permission.newValue;T&&clearTimeout(T),T=setTimeout(()=>{R(t)},100)}})},f=()=>{let o=window.location.href;new MutationObserver(()=>{const t=window.location.href;t!==o&&(console.log("[APIæ‹¦æˆªå™¨] URLå˜åŒ–:",{from:o,to:t}),o=t,E(t))}).observe(document,{subtree:!0,childList:!0})},E=o=>{chrome.runtime.sendMessage({type:l.CheckLoginStatus},e=>{(e==null?void 0:e.success)&&_(o)})},_=o=>{a(o)&&chrome.storage.local.get("trex_twitter_permission",e=>{const t=e.trex_twitter_permission;t===!0||t==="true"?(console.log("[APIæ‹¦æˆªå™¨] Twitteræƒé™å¼€å¯ï¼Œåˆå§‹åŒ–Twitter APIæ‹¦æˆªå™¨"),s.ensureInitialized(o)):console.log("[APIæ‹¦æˆªå™¨] Twitteræƒé™æœªå¼€å¯ï¼Œè·³è¿‡Twitter APIæ‹¦æˆªå™¨åˆå§‹åŒ–")}),u(o)&&chrome.storage.local.get("trex_youtube_permission",e=>{const t=e.trex_youtube_permission;t===!0||t==="true"?(console.log("[APIæ‹¦æˆªå™¨] YouTubeæƒé™å¼€å¯ï¼Œåˆå§‹åŒ–YouTube APIæ‹¦æˆªå™¨"),c.ensureInitialized(o)):console.log("[APIæ‹¦æˆªå™¨] YouTubeæƒé™æœªå¼€å¯ï¼Œè·³è¿‡YouTube APIæ‹¦æˆªå™¨åˆå§‹åŒ–")})},y=o=>{a(o)&&s.cleanup(),u(o)&&c.cleanup()},Y=o=>{const e=window.location.href;a(e)?o===!0||o==="true"?(console.log("[APIæ‹¦æˆªå™¨] Twitteræƒé™å¼€å¯ï¼Œåˆå§‹åŒ–Twitter APIæ‹¦æˆªå™¨"),s.init(e)):(console.log("[APIæ‹¦æˆªå™¨] Twitteræƒé™å…³é—­ï¼Œæ¸…ç†Twitter APIæ‹¦æˆªå™¨"),s.cleanup()):console.log("[APIæ‹¦æˆªå™¨] å½“å‰ä¸åœ¨Twitterç½‘ç«™ï¼Œè·³è¿‡Twitteræƒé™å¤„ç†")},R=o=>{const e=window.location.href;u(e)?o===!0||o==="true"?(console.log("[APIæ‹¦æˆªå™¨] YouTubeæƒé™å¼€å¯ï¼Œåˆå§‹åŒ–YouTube APIæ‹¦æˆªå™¨"),c.init(e)):(console.log("[APIæ‹¦æˆªå™¨] YouTubeæƒé™å…³é—­ï¼Œæ¸…ç†YouTube APIæ‹¦æˆªå™¨"),c.cleanup()):console.log("[APIæ‹¦æˆªå™¨] å½“å‰ä¸åœ¨YouTubeç½‘ç«™ï¼Œè·³è¿‡YouTubeæƒé™å¤„ç†")},d=o=>{a(o)&&chrome.storage.local.get("trex_twitter_permission",e=>{const t=e.trex_twitter_permission;t===!0||t==="true"?(console.log("[APIæ‹¦æˆªå™¨] æ£€æµ‹åˆ°Twitter/Xç½‘ç«™ï¼Œåˆå§‹åŒ–Twitter APIæ‹¦æˆªå™¨"),s.init(o)):console.log("[APIæ‹¦æˆªå™¨] Twitteræƒé™æœªå¼€å¯ï¼Œè·³è¿‡Twitter APIæ‹¦æˆªå™¨åˆå§‹åŒ–")}),u(o)&&chrome.storage.local.get("trex_youtube_permission",e=>{const t=e.trex_youtube_permission;t===!0||t==="true"?(console.log("[APIæ‹¦æˆªå™¨] æ£€æµ‹åˆ°YouTubeç½‘ç«™ï¼Œåˆå§‹åŒ–YouTube APIæ‹¦æˆªå™¨"),c.init(o)):console.log("[APIæ‹¦æˆªå™¨] YouTubeæƒé™æœªå¼€å¯ï¼Œè·³è¿‡YouTube APIæ‹¦æˆªå™¨åˆå§‹åŒ–")})};A();export{y as cleanupApiInterceptors,A as initApiInterceptors};
