import{n as P,s as w}from"./chunk-RPH2MNBW.js";import{Aa as J,ua as O}from"./chunk-4C5HF6J2.js";import{o as r,q as o}from"./chunk-UWURTNRY.js";r();o();var $="",q="hide_detail_alert";r();o();J();r();o();var C={JWT:"jwt",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",PING:"ping",PONG:"pong",LOGIN:"login",LOGOUT:"logout"},E=()=>{};r();o();r();o();r();o();function u(n,t){!n||n.forEach(e=>{e(t)})}function N(n,t){n?.has(t)&&n.delete(t)}function f(n,t){return P()||n.add(t),()=>N(n,t)}function m(n){return Array.isArray(n)?n:[n]}function k(n){if(!n)return"";let t={};return Object.keys(n).sort().forEach(e=>{t[e]=n[e]}),JSON.stringify(t)}var I=n=>n?n.split(",").map(e=>({token:e})):[];function U(n){switch(n){case"dex-token-candle1m":case"dex-token-candle15m":case"dex-token-candle4H":return n;default:return""}}var{SUBSCRIBE:T,UNSUBSCRIBE:Y,PING:K}=C,p=class{constructor(){this.wsInstance=null;this.baseUrl="";this.initDone=!1;this.authenticated=!0;this.disconnected=!1;this.dataFnsMap=new Map;this.channelCache=new Map;this.wsDataCache={};this.errorFnsList=new Set;this.setConfig=t=>{this.baseUrl=t.baseUrl||""}}connect(){let t=window.WebSocketCore;if(this.initDone||!t)return;this.initDone=!0;let e=this.getWsUrl();!e||(this.wsInstance=new t({connectUrl:e,reconnectTime:1e4,maxPendingTime:2e4}),this.wsInstance.onSocketConnected(this.connectedCallback.bind(this)),this.wsInstance.setPushDataResolver(this.dataCallback.bind(this)),this.wsInstance.onSocketError(this.errorCallback.bind(this)),this.wsInstance.onStatusChange(this.statusCallback.bind(this)),this.wsInstance.onPushDiscontinue(()=>{this.wsInstance.sendChannel(K)}),this.wsInstance.connect())}subscribe(t,{needLogin:e}={needLogin:!1}){let s=m(t),i=[];if(s.forEach(l=>{let d=k(l),a=this.channelCache.get(d);if(a){this.channelCache.set(d,a+1);let{channel:g}=l,L=U(g),S=this.wsDataCache[L]?.[d];S&&u(this.dataFnsMap.get(L),S);return}this.channelCache.set(d,1),i.push(l)}),!this.initDone){this.connect();return}!this.isConnected()||e&&!this.authenticated||this.sendChannel({op:T,args:i})}unsubscribe(t){let e=m(t),s=[];e.forEach(i=>{let l=k(i),d=this.channelCache.get(l);if(d>1){this.channelCache.set(l,d-1);return}this.channelCache.delete(l),s.push(i);let a=U(i.channel);a&&delete this.wsDataCache[a]?.[l]}),!(!this.initDone||!this.isConnected())&&this.sendChannel({op:Y,args:s})}sendChannel({op:t,args:e=[]}){this.isConnected()&&e.length&&this.wsInstance?.sendChannel(JSON.stringify({op:t,args:e}))}dataCallback(t={}){let{arg:e}=t;if(!e?.channel)return;u(this.dataFnsMap.get(e.channel),t);let s=U(e?.channel);if(!s)return;let i=k(e);this.wsDataCache[s]?this.wsDataCache[s][i]=t:this.wsDataCache[s]={[i]:t}}addListenerData(t,e,s){let{argsParam:i}=s||{},l=k(i);return this.channelCache.get(l)>1&&e({event:T}),this.dataFnsMap.get(t)||this.dataFnsMap.set(t,new Set),this.wsDataCache[t]&&Object.values(this.wsDataCache[t]).forEach(a=>{e(a)}),f(this.dataFnsMap.get(t),e)}remoteListenerData(t,e){return N(this.dataFnsMap.get(t),e)}addListenerError(t){return f(this.errorFnsList,t)}errorCallback(t){this.disconnected=!0,u(this.errorFnsList,t)}connectedCallback(){let t=[];this.channelCache.forEach((e,s)=>{try{t.push(JSON.parse(s))}catch{}}),this.sendChannel({op:T,args:t})}statusCallback(){}isConnected(){return!!this.wsInstance?.isConnected()}getWsUrl(){return""}};var D=class extends p{constructor(){super(...arguments);this.connectedFnsList=new Set;this.authenticated=!1;this.loginResolveFn=E;this.loginRejectFn=E;this.tokens=""}connectedCallback(){super.connectedCallback(),this.tokens&&this.login(this.tokens).then(()=>{this.authenticated=!0,super.connectedCallback(),u(this.connectedFnsList,{disconnected:this.disconnected})}).catch(()=>{})}addListenerConnected(e){return f(this.connectedFnsList,e)}dataCallback(e){let{event:s,code:i}=e;if(s===C.LOGIN){if(Number(i)===0){this.loginResolveFn();return}this.loginRejectFn()}else super.dataCallback(e)}login(e){return new Promise((s,i)=>{this.wsInstance.sendChannel(JSON.stringify({op:C.LOGIN,args:I(e)})),this.loginResolveFn=s,this.loginRejectFn=i})}logout(e){!this.authenticated||!this.isConnected()||(this.authenticated=!1,this.wsInstance.sendChannel(JSON.stringify({op:C.LOGOUT,args:I(e)})))}getWsUrl(){let e=localStorage.getItem("dev_ct_wsPress");if(e)return e;let s="";return this.baseUrl?s=this.baseUrl:s=w?.socketBaseUrls?.dex||"",s?`${s}/ws/v5/iprivate`:""}},c=new D;r();o();var F=class extends p{constructor(){super(...arguments);this.connectedFnsList=new Set;this.statusFnsList=new Set}connectedCallback(){super.connectedCallback(),u(this.connectedFnsList,{disconnected:this.disconnected})}addListenerConnected(e){return f(this.connectedFnsList,e)}addListenerStatus(e){return f(this.statusFnsList,e)}statusCallback(e){u(this.statusFnsList,e)}getWsUrl(){let e=localStorage.getItem("dev_ct_wsPress");if(e)return e;let s="";return this.baseUrl?s=this.baseUrl:s=w?.socketBaseUrls?.dex||"",s?`${s}/ws/v5/ipublic`:""}},_=new F;var W=({isPri:n=!1,subscribeParams:t,onSubscribeSuccess:e,onListenData:s,onListenError:i,onListenReconnected:l,needLogin:d=!1})=>{let a=n?c:_,g=m(t);if(g.length<=0||!t)return()=>{};a.subscribe(g,{needLogin:d});let S=O(g.map(h=>h.channel)).map((h,B)=>{let x=!1;return a.addListenerData(h,M=>{let{data:v,event:A,arg:V}=M;if(A===C.SUBSCRIBE){!x&&e?.(h),x=!0;return}!v||!x||s?.(v,V)},{argsParam:g[B]})}),y=a.addListenerError(h=>{i?.(h)}),G=a.addListenerConnected(h=>{h?.disconnected&&l?.()});return()=>{a.unsubscribe(g),S.forEach(h=>{h?.()}),y(),G()}};var R=n=>{let t=()=>{c.tokens="",c.logout(n)};return n===c.tokens||(c.tokens=n,c.connect(),c.isConnected()&&c.connectedCallback()),t},j=n=>{c.setConfig({baseUrl:n.baseUrl}),_.setConfig({baseUrl:n.baseUrl})};r();o();r();o();export{$ as a,q as b,c,W as d,R as e,j as f};
//# sourceMappingURL=chunk-A7FGCMOW.js.map
