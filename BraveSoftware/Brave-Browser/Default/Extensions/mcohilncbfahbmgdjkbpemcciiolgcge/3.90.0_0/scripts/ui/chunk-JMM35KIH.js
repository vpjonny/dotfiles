import{a as T,c as Q,d as Z}from"./chunk-5E7YC7OF.js";import{R as de}from"./chunk-NS5EW6UN.js";import{a as te,b as ne}from"./chunk-VUBIYSGX.js";import{b as me}from"./chunk-DU4RS7AX.js";import{a as ue}from"./chunk-5C7AUJM4.js";import{b as fe,c as pe}from"./chunk-N2N44VBE.js";import{I as W,b as z,h as ie}from"./chunk-MJDO2VHF.js";import{o as re}from"./chunk-KGMP5AO5.js";import{c as k}from"./chunk-EAE2NUFS.js";import{a as w,c as g,d as $}from"./chunk-EPDR6VAQ.js";import{c as B}from"./chunk-2O5TMJZM.js";import{K as ee,O as x}from"./chunk-UI4IZNSB.js";import{D as b,Kb as ce,Lb as le,a as Y,eb as ae,ub as oe,vb as se}from"./chunk-EQ34WRCJ.js";import{A as I,Aa as U,B as _,Q as X,g as J,p as H,q as P}from"./chunk-4C5HF6J2.js";import{o as m,q as d}from"./chunk-UWURTNRY.js";m();d();U();m();d();async function L(e){return!Array.isArray(e)||e.length===0?!1:(await b.assets).set(e)}m();d();m();d();async function j(e){return!Array.isArray(e)||e.length===0?!1:(await Promise.resolve(b.balance)).set(e,{clear:!0})}async function q(e){try{return await(await Promise.resolve(b.balance)).get(e)}catch{return null}}async function ge(){try{return await(await Promise.resolve(b.balance)).getAll()}catch{return null}}async function mt({accountId:e,coinId:t,balanceData:n,symbol:a,addressType:r,subBalanceType:s}){let o=await q(e);if(!o||o.walletId!==e)return!1;let c=o.coins.find(l=>s===1?l.symbol===a&&l.subBalanceType===s:l.coinId===t);if(!c)return null;if(c.childrenCoin){let l=c.childrenCoin.find(u=>s===2?u.addressType===r:u.coinId===t);if(l){if(l.coinAmount===n.coinAmount)return!1;Object.assign(l,n);let u={coinAmount:"0",coinAmountInt:"0",currencyAmountUSD:"0"};c.childrenCoin.forEach(p=>{u.coinAmount=g(u.coinAmount,p.coinAmount,{returnString:!0}),u.coinAmountInt=g(u.coinAmountInt,p.coinAmountInt,{returnString:!0}),u.currencyAmountUSD=g(u.currencyAmountUSD,p.currencyAmountUSD,{returnString:!0})}),Object.assign(c,u)}else return null}else{if(c.coinAmount===n.coinAmount)return!1;Object.assign(c,n)}return await j([o]),o}m();d();U();m();d();var Je=re({name:"balanceSlice",initialState:{balanceMap:{}},reducers:{setBalance:(e,t)=>{e.balanceMap=t.payload},setBalanceItem:(e,t)=>{e.balanceMap={...e.balanceMap,[t.payload.walletId]:t.payload}}}}),{actions:Ae,reducer:Xe}=Je;function $e(e){Y.captureEvent({message:"STORE_WARN_indexeddb_error",exception:{values:[{type:"STORE_WARN_indexeddb_error",value:e}]},level:"error"})}var St=()=>async e=>{let t=await ge();if(!t||t.filter?.(a=>!a).length>0){$e(`subscribe balance null, ${JSON.stringify(t)}`);return}let n=t.reduce((a,r)=>(a[r.walletId]=r,a),{});e(Ae.setBalance(n))},{setBalance:he,setBalanceItem:It}=Ae,yt=Xe;m();d();m();d();U();function Se({balanceCoins:e,coinsMap:t,flatten:n=!1}){let a=[];return e.forEach(r=>{if(r.childrenCoin){let s=r.childrenCoin.map(o=>({...o,...t.get(o.coinId)}));n?a.push(...s):a.push({...r,...t.get(r.coinId),childrenCoin:s})}else a.push({...r,childrenCoin:void 0,...t.get(r.coinId)})}),a}var Ce=(e,t)=>{let n=e.coinBalanceDetails.map(a=>t.address===a.userAddress&&a.coinId===t.coinId?{...a,coinAmount:String(t.coinAmountOriginalDec),coinAmountOrigin:String(t.coinAmount),currencyAmount:String(t.currencyAmount)}:a);return{...e,coinBalanceDetails:n,coinAmount:n.reduce((a,r)=>g(a,r.coinAmount),"0"),coinAmountOrigin:n.reduce((a,r)=>g(a,r.coinAmountOrigin),"0"),currencyAmount:n.reduce((a,r)=>g(a,r.currencyAmount),"0"),symbol:t.symbol,name:t.name,imageUrl:t.logo}};async function Ie({pushData:e,store:t,walletId:n,account:a}){let r=P(t),s=I(t.data.assets,i=>i.walletId===n),o=I(t.data.assets[s].tokens,i=>_(i.coinBalanceDetails,l=>l.coinId===e.coinId));if(o===-1){let i=await de(e.subBalanceType===1?{aggregationSymbol:e.symbol}:{coinId:e.coinId},e,n,a);if(!i)return!1;r.data.coins.push(...i.coins);let c=t.data.assets[s].tokens.length;r.data.assets[s].tokens[c]=Ce(i.token,e)}else r.data.assets[s].tokens[o]=Ce(t.data.assets[s].tokens[o],e);return r}function ye({pushData:e,store:t}){let n=P(t),a=t.data.assets[0].nfts,{receive:r,reduce:s}=e,o=(r||s)?.collectionItem.chainId,i=I(a,c=>_(c.networkValuations,l=>l.chainId===o));return i===-1?r&&n.data.assets[0].nfts.push({networkValuations:[{chainId:o,name:r.collectionItem.name,valuation:w(r.count,r.collectionItem.floorSalePrice?.usdPrice??0)}]}):n.data.assets[0].nfts[i]={...t.data.assets[0].nfts[i],networkValuations:t.data.assets[0].nfts[i].networkValuations.map(c=>({...c,valuation:r?g(c.valuation,w(r.count,r.collectionItem.floorSalePrice?.usdPrice??0)):s&&$(c.valuation,w(s.count,s.collectionItem.floorSalePrice?.usdPrice??0))}))},n}function we({pushData:e,store:t,walletId:n}){let a=P(t),r=I(t.data.assets,o=>o.walletId===n),s=I(t.data.assets[r].defis,o=>o.chainId===e.chainId&&o.platformId===e.analysisPlatformId);if(s!==-1){let{platform:o,network:i,url:c,web:l,logo:u,balance:p}=e;a.data.assets[r].defis[s]={...t.data.assets[r].defis[s],defiUrl:c,logo:u,platform:o,balance:p,web:l,network:i}}else a.data.assets[r].defis.push({accountId:n,balance:e.balance,chainId:e.chainId,chainName:e?.chainName,defiUrl:e.url,logo:e.logo,network:e.network,platform:e.platform,platformId:e.analysisPlatformId,walletId:n,web:e.web});return a.data.coins=t.data.coins.map(o=>!o.voucherToken&&_(e.lpTokenAddressList,i=>o.address?i.tokenAddress===o.address:i.chainId===o.chainId)?{...o,voucherToken:!0}:o),a}m();d();U();var v={};function M(){return v}function Be(e){v=e}function Tt(e){return!v?.data?.assets||!e?!1:I(v?.data?.assets,n=>n&&n.walletId===e)!==-1}async function be({data:e,channel:t,walletId:n,account:a}){try{return t==="wallet-asset"?await Ie({pushData:e,store:M(),walletId:n,account:a}):t==="invest-DeFi"?we({pushData:e?.data||e,store:M(),walletId:n}):ye({pushData:e,store:M()})}catch{return!1}}m();d();function ke(e){let t=e.reduce((n,a)=>{let{chainId:r,currencyAmountUSD:s}=a;return n.has(r)?n.set(r,g(n.get(r),s)):n.set(r,s),n},new Map);return Array.from(t).map(([n,a])=>({chainId:n,currencyAmountUSD:a}))}function ze(e,t,n){let{coinAmount:a,currencyAmount:r,coinAmountOrigin:s,...o}=e,i=t.get(e.coinId),c=n?.[e.coinId]?.coinToUSDRate;return{...o,coinAmount:a,coinAmountInt:s,currencyAmountUSD:c?w(a,c):r,baseCoinId:i?.baseCoinId}}function De(e,t,n){return e.map(r=>{let{defis:s,nfts:o,tokens:i,accountId:c}=r,l=i?.map(f=>{let{coinAmountOrigin:A,coinBalanceDetails:C,currencyAmount:S,subBalanceType:D,imageUrl:Ve,...Ge}=f,F=C.map(N=>ze(N,t,n)),Ke=F[0],G=D===1,K=D===2;return{...Ke,...Ge,image:Ve,currencyAmountUSD:F.reduce((N,Ye)=>g(N,Ye.currencyAmountUSD),"0"),coinAmountInt:A,aggregation:G,isAddressAggregation:K,childrenCoin:G||K?F:void 0}})??null,u=s?.map(f=>({currencyAmountUSD:f.balance,chainId:f.chainId}))??null,p=o?.reduce((f,A)=>f.concat(A.networkValuations||[]),[]).map(f=>({chainId:f.chainId,currencyAmountUSD:f.valuation}))??null;return{defi:u?ke(u):null,nft:p?ke(p):null,coins:l,walletId:c,v:2}})}function xe(e,t){let{coins:n,balanceData:a,walletId:r}=e,s=a?.coins??[],o=[];return s.forEach(i=>{if(i.childrenCoin){let c=[];i.childrenCoin.forEach(l=>{l.coinId===+t&&c.push(l)}),c.length>0&&(Object.assign(i,{...c[0],childrenCoin:c}),i.coinAmountInt=c.reduce((l,u)=>g(l,u.coinAmountInt),"0"),i.coinAmount=c.reduce((l,u)=>g(l,u.coinAmount),"0"),i.currencyAmountUSD=c.reduce((l,u)=>g(l,u.currencyAmountUSD),"0"),o.push(i))}else i.coinId===+t&&o.push(i)}),{walletId:r,balanceCoins:o,coins:n.filter(i=>i.coinId===+t)}}m();d();function y(e){return e?.keyring?.selectedWallet}function We(e,t){let{createdMap:n}=e.metamask;return Boolean(n[t])}function Pe(e){let{createdMap:t}=e.metamask;return Object.keys(t??{})}function R(e){return e.metamask.userUniqueId}function _e(e,t){let{createdMap:n}=e.metamask;return n[t]||[]}function Ue(e,t){let{addedCoins:n}=e.metamask;return n[t]||[]}function Te(e,t){let{reducedCoins:n}=e.metamask;return n[t]||[]}async function ve(){return k().getCustomCoins()}async function Me(e,t){return k().setAllCoins(e,t)}async function Re(){try{let{data:e={}}=await ee(B.getCoinApyUrl);return e}catch{return{}}}function Ee(e,t){if(!t||Object.keys(t).length===0)return e;let n=new Map;return e.forEach((a,r)=>{let s=String(r),o=t[s];o?n.set(r,{...a,minApy:o.minApy,maxApy:o.maxApy,investmentId:o.investmentId,showOnHomepage:o.showOnHomepage}):n.set(r,a)}),n}async function gn({accountIds:e,coinId:t,userUniqueId:n,addressType:a}){let r={userUniqueId:n,accountIds:e,coinId:t};a&&(r.addressTypes=[a]);let{data:s={}}=await x(B.getCoinBalanceUrl,r),o=s?.coinBalanceDetails?.find(i=>X(a)?i.coinId===t:i.coinId===t&&i.addressType===parseInt(a,10));return o?{symbol:o.symbol,subBalanceType:s.subBalanceType,logo:o.imageUrl,name:o.name,addressType:o.addressType,voucherToken:!!o.isVoucher,coinId:o.coinId,tokenAddress:o.tokenAddress,address:o.userAddress,coinAmountOriginalDec:o.coinAmount,coinAmount:o.coinAmountOrigin,currencyAmount:o.currencyAmount}:null}function Oe(e,t,n=null){return async(a,r)=>{let s=r(),o=y(s),i=R(s);try{let c;n?.channel&&(c=await be({...n,walletId:o,account:W(s,o)}));let{data:l={}}=c||await x(B.newGetAllAssetsUrl,{userUniqueId:i,accountIds:e,combinationCoins:!0,chainIndexes:t?[t]:void 0},{walletSignParams:{needXClientSign:!0,walletId:o}}),u=l.coins??[],p=l.assets??[],f=new Map(u.map(S=>[S.coinId,ie(S)]));Be({data:{coins:u,assets:p.filter(S=>S.walletId===o)}});let A=await me(ue.coinTickers);return{assets:De(p,f,A),coinsMap:f}}catch(c){return ne(c)}}}function E(e){return async t=>{let n={};e.forEach(a=>{n[a.walletId]=a});try{t(he(n)),await j(e)}catch{J()}}}m();d();m();d();m();d();function Fe(e,t){let n=[];return e.reduce((a,r)=>r.childrenCoin?a.concat(...r.childrenCoin):a.concat(r),[]).forEach(a=>{t&&ce.includes(a.coinId)&&n.push(a)}),n}async function Ne(e,t,n={}){let{needSetDefault:a}=n,r=Fe(e,a);r.length?k().updateWalletAddress(t,r.reduce((s,{coinId:o,userAddress:i})=>{let c=se({coinId:+o})?.localType,l=ae(c);return Object.entries(n.accountsMap?.[l]??{}).forEach(([u,p])=>{p.address===i&&(s[l]=u)}),s},{}),{needUpdateBalance:!1,needUpdateSegwitAddressType:!0,needSync:!0,needEmitChangeAddress:!1}):a&&k().updateWalletAddress(t,{},{needUpdateBalance:!1,needUpdateSegwitAddressType:!0,needSync:!0,needEmitChangeAddress:!1})}function He({walletData:e,coinsMap:t}){return(n,a)=>{let r=a(),s=e.walletId,o=_e(r,s),c=W(r,s)?.initialType===le.SIMPLE_KEYRING,l=Ue(r,s),u=Te(r,s),{open:p,amount:f}=T(r);return Q({isReady:!0,defaultBaseCoinsCoinIds:c?o||[]:[],addedCoins:l,reducedCoins:u,balanceCoins:Se({balanceCoins:e.coins,coinsMap:t,flatten:!1}),defi:e.defi,nft:e.nft,hiddenSmallAssets:p,smallAssetsAmount:f,networks:oe()})}}function V({coinsMap:e,walletData:t}){return async(n,a)=>{let r=a(),s=W(r,t.walletId);Ne(t.coins,t.walletId,s);let o=await ve();y(r)===t.walletId&&(Me(Array.from(e.values()),o),n(E([t])))}}var Le=50,O=!1;function Qe({apyPromise:e,walletsBalance:t,selectedWalletId:n,dispatch:a}){!e||e.then(async r=>{if(!r||Object.keys(r).length===0)return;let s=t.find(c=>c.walletId===n);if(!s)return;let o=new Map(s.coins.map(c=>[c.coinId,c])),i=Ee(o,r);a(V({coinsMap:i,walletData:s.balanceData}))}).catch(()=>{})}function je({walletIds:e,chainId:t,pushData:n}){return async(a,r)=>{let s=r(),o=[],i=!t,c=y(s),l=i?Re():null;return await Promise.all(H(e,Le).map(async u=>{let{assets:p,coinsMap:f}=await a(Oe(u,t,n)),A=[];p.forEach(C=>{let{walletId:S}=C;if(i){let D=a(He({walletData:C,coinsMap:f}));D&&A.push({walletId:S,...D}),S===c&&a(V({coinsMap:f,walletData:C}))}o.push({walletId:S,coins:Array.from(f.values()),balanceData:C})}),i&&L(A)})),Qe({apyPromise:l,walletsBalance:o,selectedWalletId:c,dispatch:a}),o}}function qe(e,t){return async(n,a)=>{let r=a(),s=t??y(r);if(!(!s||!We(r,s))){try{await n(je({walletIds:[s],pushData:e}))}catch(i){let c=await q(s);throw await n(E([{...c??{},walletId:s,error:!0,v:2}])),i}if(pe()){fe();let i=setTimeout(()=>{n(qe()),clearTimeout(i)},2e3)}}}}function nr(e){return async(t,n)=>{let a=n();y(a)===e&&await t(qe())}}function rr({walletIds:e,chainId:t,coinId:n}){return async a=>{let r=await a(je({walletIds:e,chainId:t}));return r?.length?r.map(s=>xe(s,n)):null}}function ar(){return async(e,t)=>{if(O)return;let n=t();O=!0;let a=Pe(n),r=z(n),{open:s,amount:o}=T(n),i=s?Number(o):null,c=R(n);try{await Promise.all(H(a,Le).map(async l=>{let{data:u=[]}=await x(B.getWalletManageAsset,{userUniqueId:c,accountIds:l,tinyThreshold:i,accountDetailList:l.map(A=>({accountId:A,filterCoinList:(r?.[A]??[]).map(C=>C.coinId)}))}),p=n.metamask.preferences.showNftAmount,f=u.map(A=>Z(A,p));L(f)})),O=!1}catch(l){throw O=!1,te[l?.message]?new Error(l?.message):new Error(l)}}}export{mt as a,St as b,It as c,yt as d,Tt as e,gn as f,je as g,qe as h,nr as i,rr as j,ar as k};
//# sourceMappingURL=chunk-JMM35KIH.js.map
