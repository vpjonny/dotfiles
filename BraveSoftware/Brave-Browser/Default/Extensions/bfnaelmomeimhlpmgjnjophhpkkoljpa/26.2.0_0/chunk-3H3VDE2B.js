import{a as H}from"./chunk-6L5OAXTQ.js";import{d as U,k as Te}from"./chunk-EAEMLYNM.js";import{A as ve,Ab as Ne,Na as be,Rb as F,ac as _e,o as ke}from"./chunk-44HH5QGP.js";import{a as E,b as M}from"./chunk-WVRYN4MY.js";import{R as Oe,a as Se,j as T}from"./chunk-HLWWEHZK.js";import{A as Ie,fb as Ke,h as Re,i as Ee,m as Me}from"./chunk-5JGASDWN.js";import{a as _,b as v}from"./chunk-NMTPXQAP.js";import{s as Ae}from"./chunk-N6SSDFMX.js";import{a as K}from"./chunk-YJCG6GWC.js";import{Ea as fe,G as me,Ka as m,O as q,Qb as ye,V as de,aa as ue,ba as he,ca as pe,ga as ge}from"./chunk-W7IWPUIQ.js";import{Za as we,b as Ce}from"./chunk-4SCKDS7G.js";import{H as ee,I as V,L as y,Me as le,S as te,Vd as W,Yc as re,Zc as se,ad as oe,ce,ee as k,id as ie,pd as ae,ud as ne,w as Z}from"./chunk-DJGGVTSJ.js";import{D as I,a as et,b as X,o as O}from"./chunk-LQZGQEJ6.js";import{a as o,g as f,i as n,j as l,n as c}from"./chunk-WKJYWAXG.js";n();c();var g=f(K());n();c();var tt=o(t=>typeof t=="object"&&t!==null&&"localVersion"in t&&"remoteVersion"in t&&"remoteState"in t&&"eventVersions"in t,"isNamespaceState"),B=o(t=>tt(t)?t:{localVersion:0,remoteVersion:0,remoteState:null,eventVersions:{change:0,idle:0}},"parseNamespaceState");var G=o(t=>typeof t=="object"&&t!==null?t:{},"parseNamespaceItems");var Q="mmkv:state:",$="mmkv:items:",rt="mmkv:",D=o(t=>`${Q}${t}`,"namespaceStateKey"),b=o(t=>`${$}${t}`,"namespaceItemsKey"),st=o(t=>t.startsWith(Q),"isNamespaceStateKey"),ot=o(t=>t.startsWith($),"isNamespaceItemsKey"),it=o(t=>typeof t=="object"&&t!==null&&"method"in t&&typeof t.method=="string"&&t.method.startsWith(rt),"isMMKVMessage"),x=class{static{o(this,"ExtensionBackingStore")}stateCache={};itemsCache={};callbacks={};config;constructor(e={isWriter:!1}){this.config=e}async init(e){let r=await g.default.storage.local.get([...e.map(s=>D(s.key)),...e.map(s=>b(s.key))]);for(let s of e){let i=s.key,a=D(i),u=b(i);this.stateCache[i]=B(r[a]),this.itemsCache[i]=G(r[u])}g.default.storage.local.onChanged.addListener(s=>{let i=[];for(let[a,u]of Object.entries(s))if(st(a)){let d=a.slice(Q.length);this.stateCache[d]=B(u.newValue),i.push(d)}else if(ot(a)){let d=a.slice($.length);this.itemsCache[d]=G(u.newValue)}for(let a of i)this.callbacks[a]?.forEach(d=>d(this.stateCache[a]))}),this.config.isWriter&&this.setupWriterMessageHandler()}setupWriterMessageHandler(){if(!this.config.onRegisterMessageHandler)throw new Error("ExtensionBackingStore: onRegisterMessageHandler callback is required for writer mode. The service worker should route MMKV messages to the handler to avoid race conditions from multiple browser.runtime.onMessage.addListener calls.");let e=o(r=>{let s;if(typeof r=="string")try{s=M(r)}catch{return}else s=r;if(it(s))return this.handleWriteMessage(s)},"handler");this.config.onRegisterMessageHandler(e)}async handleWriteMessage(e){try{switch(e.method){case"mmkv:setNamespace":await this.performSetNamespace(e.params.namespace,e.params.value);break;case"mmkv:setItem":await this.performSetItem(e.params.namespace,e.params.schema,e.params.item,e.params.value);break;case"mmkv:deleteItem":await this.performDeleteItem(e.params.namespace,e.params.schema,e.params.item);break;case"mmkv:clear":await this.performClear();break}return{success:!0}}catch(r){let s=r instanceof Error?r.message:String(r);return console.error("[MMKV] Write operation failed:",s),{success:!1,error:s}}}async sendWriteMessage(e){let r=await g.default.runtime.sendMessage(E(e)),s=this.extractWriteResponse(r);if(!s.success)throw new Error(s.error)}extractWriteResponse(e){let r=typeof e=="string"?M(e):e;if(typeof r=="object"&&r!==null&&"result"in r&&r.jsonrpc==="2.0"){let s=r.result;if(this.isMMKVWriteResponse(s))return s;throw new Error(`Invalid MMKV response in RPC result: ${JSON.stringify(s)}`)}if(this.isMMKVWriteResponse(r))return r;if(typeof r=="object"&&r!==null&&"error"in r&&r.jsonrpc==="2.0"){let s=r.error;throw new Error(`RPC error: ${s.message??"Unknown error"}`)}throw new Error(`Invalid response from writer: ${JSON.stringify(e)}`)}isMMKVWriteResponse(e){if(typeof e!="object"||e===null)return!1;let r=e;return r.success===!0||r.success===!1&&typeof r.error=="string"}onNamespaceChange(e,r){let s=r,i=this.callbacks[e]??(this.callbacks[e]=[]);return i.push(s),()=>{i.splice(i.indexOf(s),1)}}getNamespace(e){return this.stateCache[e]??null}async setNamespace(e,r){if(this.config.isWriter)await this.performSetNamespace(e,r);else{let s=this.stateCache[e];this.stateCache[e]=r;try{await this.sendWriteMessage({method:"mmkv:setNamespace",params:{namespace:e,value:r}})}catch(i){throw s!==void 0?this.stateCache[e]=s:delete this.stateCache[e],i}}}async performSetNamespace(e,r){this.stateCache[e]=r,await g.default.storage.local.set({[D(e)]:r})}getItem(e,r,s){let i=`${r}:${s}`;return(this.itemsCache[e]??{})[i]??null}async setItem(e,r,s,i){let a=`${r}:${s}`;if(this.config.isWriter)await this.performSetItem(e,r,s,i);else{let u=e in this.itemsCache,d=this.itemsCache[e]?.[a];this.itemsCache[e]||(this.itemsCache[e]={}),this.itemsCache[e][a]=i;try{await this.sendWriteMessage({method:"mmkv:setItem",params:{namespace:e,schema:r,item:s,value:i}})}catch(J){throw u?d!==void 0?this.itemsCache[e][a]=d:delete this.itemsCache[e][a]:delete this.itemsCache[e],J}}}async performSetItem(e,r,s,i){let a=`${r}:${s}`;this.itemsCache[e]||(this.itemsCache[e]={}),this.itemsCache[e][a]=i,await g.default.storage.local.set({[b(e)]:this.itemsCache[e]})}async deleteItem(e,r,s){let i=`${r}:${s}`;if(this.config.isWriter)await this.performDeleteItem(e,r,s);else{let a=this.itemsCache[e]?.[i];this.itemsCache[e]&&delete this.itemsCache[e][i];try{await this.sendWriteMessage({method:"mmkv:deleteItem",params:{namespace:e,schema:r,item:s}})}catch(u){throw a!==void 0&&(this.itemsCache[e]||(this.itemsCache[e]={}),this.itemsCache[e][i]=a),u}}}async performDeleteItem(e,r,s){let i=`${r}:${s}`;this.itemsCache[e]&&delete this.itemsCache[e][i],await g.default.storage.local.set({[b(e)]:this.itemsCache[e]})}async clear(){if(this.config.isWriter)await this.performClear();else{let e={...this.stateCache},r={...this.itemsCache},s={...this.callbacks};this.stateCache={},this.itemsCache={},this.callbacks={};try{await this.sendWriteMessage({method:"mmkv:clear"})}catch(i){throw this.stateCache=e,this.itemsCache=r,this.callbacks=s,i}}}async performClear(){await Promise.all([...Object.keys(this.stateCache).map(e=>g.default.storage.local.remove(D(e))),...Object.keys(this.itemsCache).map(e=>g.default.storage.local.remove(b(e)))]),this.stateCache={},this.itemsCache={},this.callbacks={}}};n();c();n();c();var C={Accounts:`${q}.accounts`,SecretIdentifiers:`${q}.secrets`},De=[{legacyKeys:[m.AccountsMetadata],targetSchema:"accounts",targetKey:m.AccountsMetadata,migrate:o(t=>t[m.AccountsMetadata],"migrate")}],xe=[{legacyKeys:[m.DeveloperMode],targetSchema:"accounts",targetKey:m.DeveloperMode,migrate:o(t=>t[m.DeveloperMode],"migrate")},{legacyKeys:[m.NetworkSetting],targetSchema:"accounts",targetKey:m.NetworkSetting,migrate:o(t=>t[m.NetworkSetting],"migrate")},{legacyKeys:[m.SelectedAccount],targetSchema:"accounts",targetKey:m.SelectedAccount,migrate:o(t=>t[m.SelectedAccount],"migrate")},{legacyKeys:[m.AccountsBalanceMetadata],targetSchema:"accounts",targetKey:m.AccountsBalanceMetadata,migrate:o(t=>t[m.AccountsBalanceMetadata],"migrate")},{legacyKeys:[m.MigratedWithInvalidChecksum],targetSchema:"accounts",targetKey:m.MigratedWithInvalidChecksum,migrate:o(t=>t[m.MigratedWithInvalidChecksum],"migrate")},{legacyKeys:[m.TermsHaveBeenAcknowledgedLastSeenVersion],targetSchema:"accounts",targetKey:m.TermsHaveBeenAcknowledgedLastSeenVersion,migrate:o(t=>t[m.TermsHaveBeenAcknowledgedLastSeenVersion],"migrate")},{legacyKeys:[m.NotificationsHaveBeenAcknowledgedLastSeenVersion],targetSchema:"accounts",targetKey:m.NotificationsHaveBeenAcknowledgedLastSeenVersion,migrate:o(t=>t[m.NotificationsHaveBeenAcknowledgedLastSeenVersion],"migrate")}],Le=[{legacyKeys:[C.Accounts],targetSchema:"vault",targetKey:C.Accounts,migrate:o(t=>t[C.Accounts],"migrate")},{legacyKeys:[C.SecretIdentifiers],targetSchema:"vault",targetKey:C.SecretIdentifiers,migrate:o(t=>t[C.SecretIdentifiers],"migrate")}];n();c();n();c();var h;(function(t){t.DismissedActionBanners="dismissedActionBanners",t.AppLaunchTimes="appLaunchTimes",t.LastOnboardedAt="lastOnboardedAt",t.DismissedContentCards=".phantom.interstitials.contentCards.dismissed"})(h||(h={}));var Pe=[{legacyKeys:[h.DismissedActionBanners],targetSchema:"interstitials",targetKey:T.DismissedActionBanners,migrate:o(t=>t[h.DismissedActionBanners],"migrate")},{legacyKeys:[h.AppLaunchTimes],targetSchema:"interstitials",targetKey:T.AppLaunchTimes,migrate:o(t=>t[h.AppLaunchTimes],"migrate")},{legacyKeys:[h.LastOnboardedAt],targetSchema:"interstitials",targetKey:T.LastOnboardedAt,migrate:o(t=>t[h.LastOnboardedAt],"migrate")},{legacyKeys:[h.DismissedContentCards],targetSchema:"interstitials",targetKey:T.DismissedContentCards,migrate:o(t=>t[h.DismissedContentCards],"migrate")}];n();c();var at={enabled:!0,clientToken:l.DATADOG_CLIENT_TOKEN,applicationId:"3f3bc3b0-8d80-4b31-b4b9-9909de4d243a",service:"browser-ext-frontend",traceSampleRate:1,sessionSampleRate:1},nt={enabled:!0,dsn:"https://pub5df2cf131c51c4215f2ca3aa32d4e4b7@sentry-intake.datadoghq.com/1",sampleRate:.1,tracesSampleRate:0,initialScope:{tags:{service:"browser-ext-background",version:I}}};async function Y(t,e){await y.init({appVersion:I,sentry:t==="frontend"?{enabled:!1}:nt,datadog:t==="frontend"?at:{enabled:!1}}),e&&await y.setUser({id:e})}o(Y,"initTelemetry");n();c();var j=class{static{o(this,"NetworkLogger")}requests=[];maxRequests=0;allowedDomains=["phantom.app","phantom.com"];ignoredHosts=new Set;ignoredUrls=new Set;ignoredPatterns;init(e={maxRequests:20,ignoredUrls:[],ignoredHosts:[]}){this.maxRequests=e.maxRequests,this.ignoredUrls=new Set(e.ignoredUrls),this.ignoredHosts=new Set(e.ignoredHosts);let r=self.fetch;self.fetch=async(...s)=>{let[i,a]=s,u=a?.method||"GET",d={};if(a?.headers instanceof Headers?a.headers.forEach((w,R)=>{d[R]=w}):Array.isArray(a?.headers)?a.headers.forEach(([w,R])=>{d[w]=R}):d=a?.headers||{},this.shouldIgnoreRequest(i.toString()))return r(...s);let A={id:`${Date.now()}-${Math.random()}`,method:u,url:i.toString(),requestHeaders:d,startTime:Date.now()};this.requests.length>=this.maxRequests&&this.requests.pop(),this.requests.unshift(A);let N=await r(...s),Ze=await N.clone().text();return A.status=N.status,A.responseHeaders={},N.headers.forEach((w,R)=>{A.responseHeaders[R]=w}),A.endTime=Date.now(),A.response=Ze,N}}shouldIgnoreRequest(e){try{let r=new URL(e).hostname;return this.ignoredHosts&&this.ignoredHosts.has(r)||this.ignoredUrls&&this.ignoredUrls.has(e)||!this.allowedDomains.some(s=>r.includes(s))?!0:!!(this.ignoredPatterns&&this.ignoredPatterns.some(s=>s.test(e)))}catch{return!0}}getRequests(){return this.requests}clearRequests(){this.requests=[]}setIgnoredHosts(e){this.ignoredHosts=new Set(e)}setIgnoredUrls(e){this.ignoredUrls=new Set(e)}setIgnoredPatterns(e){this.ignoredPatterns=e}clearIgnoredHosts(){this.ignoredHosts=new Set}clearIgnoredUrls(){this.ignoredUrls=new Set}clearIgnoredPatterns(){this.ignoredPatterns=void 0}},ct=new j,Ve=ct;var S,qe,gr=o(t=>qe?.(t),"handleMMKVMessage"),fr=o(t=>{S?.sendEvent(t)},"sendMMKVUpdateEvent"),We=o(()=>S?.getNamespace(W),"getFlagNamespace"),He=le(t=>{We()?.updateRemoteState(e=>({overrides:e?.overrides??{},eppoConfig:e?.eppoConfig??{},userId:t})),We()?.invalidate()}),mt=o(async(t,e,r)=>{if(S)return;let s={apiKey:ce,deviceId:e,subjectAttributes:{appVersion:I,platform:"browser-ext",deviceId:e},pollingEnabled:t==="background",analytics:v,logTelemetry:o(a=>{y.addBreadcrumb(V.FeatureFlags,a,ee.Info,{skipFileLogger:!0})},"logTelemetry"),telemetry:y},i=t==="background";S=await re({backingStore:new x({isWriter:i,onRegisterMessageHandler:i?a=>qe=a:void 0}),namespaces:[W.withDeps(s),se.withDeps({legacyStorage:H,migrations:[...Pe,...xe,...Le,...we]}),oe.withDeps({authRepository:r,legacyStorage:H,migrations:[...U,...De]})],initDeadline:t==="frontend"?0:5e3}),t==="background"&&S.sendEvent("idle")},"initializeMMKV"),yr=o(async()=>{S&&await S.reset()},"resetMMKV"),Sr=o(async(t,e)=>{try{let r=await v.getDeviceId();await Y(t,r),await mt(t,r,e),await lt(),Z(r)}catch(r){await Y(t),y.captureError(r,V.StartUp)}},"telemetryInitializeFeatureFlags"),lt=o(()=>{let t=k.getMultivariateAssignment("network-logger-config-json");if(t)try{let e=JSON.parse(t),r=te.parse(e);Ve.init({ignoredHosts:r.ignoredHosts,maxRequests:r.maxRequests,ignoredUrls:r.ignoredUrls})}catch(e){console.error("Error initializing network logger",e)}},"initializeNetworkLogging");n();c();n();c();var Fe=f(et(),1);var Ue=new WeakMap;function Be(t,e){let r=Re(e),s=dt(r);for(let[i,a]of t)(!s.has(i)||e?.dangerouslyForceHydrate)&&(s.add(i),r.set(i,a))}o(Be,"useHydrateAtoms");var dt=o(t=>{let e=Ue.get(t);return e||(e=new WeakSet,Ue.set(t,e)),e},"getHydratedSet");n();c();var p=o(()=>!0,"defaultShouldDehydrateQueryPredicate"),Ge={auth:p,tokens:p,prices:Ie,collectibles:Te,currency:Ae,staking:Oe,swapper:be,transferFungibleLoggingContext:p,user:ye,[Ce]:p,[Se]:p,[Ne]:p,[Ke]:p,[ke]:p,[ve]:p,"test-debug-query":O,perps:p},Qe=o(t=>{if(t.queryKey.length===0)return!1;let e=String(t.queryKey[0]);return t.state.status!=="success"?!1:Ge[e]?Ge[e](t):!1},"shouldDehydrateQuery");var L=f(X(),1),P=new ae({defaultOptions:{mutations:{retry:!1,networkMode:"offlineFirst"},queries:{retry:!1,staleTime:1/0,gcTime:1/0,refetchOnWindowFocus:!1,networkMode:"offlineFirst"}}}),ut=ie({underlyingStorage:new _,throttleMs:1e3,enableDebugLogs:O()}),ht=o(({children:t})=>(Be([[Me,P]]),t),"HydrateAtoms"),es=o(t=>(0,L.jsx)(ne,{client:P,persistOptions:{persister:ut,dehydrateOptions:{shouldDehydrateQuery:Qe},buster:pt,maxAge:1/0},children:(0,L.jsx)(Ee,{children:(0,L.jsx)(ht,{children:t.children})})}),"QueryProvider"),pt="25.2.0";n();c();n();c();var je=f(K());n();c();var $e=f(K());var Ye=o(async(t,e,r)=>{let s=await $e.default.identity.launchWebAuthFlow({interactive:r,url:e});if(!pe(t,s))return he(t,s);throw new Error("Error fetching auth code")},"fetchExtensionAuthCode");var ze={getClientID:ge,redirectURL:je.default.identity.getRedirectURL(),fetchAuthorizationCode:o((t,e,r)=>Ye(t,e,r),"fetchAuthorizationCode")};n();c();var z=f(K(),1);var gt=o(async()=>{let t=F("serviceWorkerMutexAcquire",void 0),e=M(await z.default.runtime.sendMessage(E(t)));if("error"in e)throw new Error(e.error.message);return()=>{let r=F("serviceWorkerMutexRelease",void 0);z.default.runtime.sendMessage(E(r))}},"acquire"),Je=o(async t=>{let e=await gt();try{return await t()}finally{e()}},"runExclusiveWithServiceWorker");var Xe=_e(),ft={storage:new _,signer:{sign:o((t,e)=>me(Xe,t,e),"sign"),getAuthenticationPublicKey:o(t=>Xe.getAuthenticationPublicKey(t),"getAuthenticationPublicKey"),getAllSecretIdentifiers:fe},authConfig:ze,queryClient:P,runExclusive:Je,isLocalTokenValidityCheckEnabled:o(()=>!k.isFeatureEnabled("kill-frontend-local-check"),"isLocalTokenValidityCheckEnabled"),isServerTimeEnabled:o(()=>!k.isFeatureEnabled("kill-frontend-server-time"),"isServerTimeEnabled")},yt=ue(ft);yt.subscribe(de.UserID,t=>{v.addUserProperties({authUserId:t}),He(t)});export{rt as a,Ve as b,gr as c,fr as d,yr as e,Sr as f,Qe as g,P as h,es as i,ze as j,yt as k};
//# sourceMappingURL=chunk-3H3VDE2B.js.map
